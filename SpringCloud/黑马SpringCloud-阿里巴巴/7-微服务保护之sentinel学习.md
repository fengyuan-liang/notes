# å¾®æœåŠ¡ä¿æŠ¤

ç¬”è®°æ˜¯é»‘é©¬å¼ è€å¸ˆCloudè¯¾çš„ç¬”è®°ï¼Œé»‘é©¬çš„è§†é¢‘è®²çš„çœŸçš„å¤ªæ£’äº†ï¼ï¼ä¸å¾—ä¸æ„Ÿæ…¨ä¸€å¥ï¼š0åŸºç¡€ã€å­¦IT ... ğŸ˜˜ğŸ˜˜ğŸ˜˜ğŸ˜˜

[è§†é¢‘åœ°å€](https://www.bilibili.com/video/BV1LQ4y127n4?p=158&spm_id_from=pageDriver)ï¼šhttps://www.bilibili.com/video/BV1LQ4y127n4?p=158&spm_id_from=pageDriver

æˆ‘è‡ªå·±åšçš„æ€ç»´å¯¼å›¾ï¼š

![image-20220525174742267](https://cdn.fengxianhub.top/resources-master/202205251747388.png)

# 1.åˆè¯†Sentinel



## 1.1.é›ªå´©é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ



### 1.1.1.é›ªå´©é—®é¢˜



å¾®æœåŠ¡ä¸­ï¼ŒæœåŠ¡é—´è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œä¸€ä¸ªå¾®æœåŠ¡å¾€å¾€ä¾èµ–äºå¤šä¸ªå…¶å®ƒå¾®æœåŠ¡ã€‚

 ![1533829099748](https://cdn.fengxianhub.top/resources-master/202205220858346.png)



å¦‚å›¾ï¼Œå¦‚æœæœåŠ¡æä¾›è€…Iå‘ç”Ÿäº†æ•…éšœï¼Œå½“å‰çš„åº”ç”¨çš„éƒ¨åˆ†ä¸šåŠ¡å› ä¸ºä¾èµ–äºæœåŠ¡Iï¼Œå› æ­¤ä¹Ÿä¼šè¢«é˜»å¡ã€‚æ­¤æ—¶ï¼Œå…¶å®ƒä¸ä¾èµ–äºæœåŠ¡Içš„ä¸šåŠ¡ä¼¼ä¹ä¸å—å½±å“ã€‚

 ![1533829198240](https://cdn.fengxianhub.top/resources-master/202205220858673.png)

ä½†æ˜¯ï¼Œä¾èµ–æœåŠ¡Içš„ä¸šåŠ¡è¯·æ±‚è¢«é˜»å¡ï¼Œç”¨æˆ·ä¸ä¼šå¾—åˆ°å“åº”ï¼Œåˆ™tomcatçš„è¿™ä¸ªçº¿ç¨‹ä¸ä¼šé‡Šæ”¾ï¼Œäºæ˜¯è¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·è¯·æ±‚åˆ°æ¥ï¼Œè¶Šæ¥è¶Šå¤šçš„çº¿ç¨‹ä¼šé˜»å¡ï¼š

 ![1533829307389](https://cdn.fengxianhub.top/resources-master/202205220858102.png)

æœåŠ¡å™¨æ”¯æŒçš„çº¿ç¨‹å’Œå¹¶å‘æ•°æœ‰é™ï¼Œè¯·æ±‚ä¸€ç›´é˜»å¡ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½ï¼Œä»è€Œå¯¼è‡´æ‰€æœ‰å…¶å®ƒæœåŠ¡éƒ½ä¸å¯ç”¨ï¼Œé‚£ä¹ˆå½“å‰æœåŠ¡ä¹Ÿå°±ä¸å¯ç”¨äº†ã€‚

é‚£ä¹ˆï¼Œä¾èµ–äºå½“å‰æœåŠ¡çš„å…¶å®ƒæœåŠ¡éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæœ€ç»ˆä¹Ÿéƒ½ä¼šå˜çš„ä¸å¯ç”¨ï¼Œå½¢æˆçº§è”å¤±è´¥ï¼Œé›ªå´©å°±å‘ç”Ÿäº†ï¼š

![image-20210715172710340](https://cdn.fengxianhub.top/resources-master/202205220858610.png)



### 1.1.2.è¶…æ—¶å¤„ç†

è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹å¼æœ‰å››ç§ï¼š

â€¢è¶…æ—¶å¤„ç†ï¼šè®¾å®šè¶…æ—¶æ—¶é—´ï¼Œè¯·æ±‚è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å“åº”å°±è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šæ— ä¼‘æ­¢ç­‰å¾…

![image-20210715172820438](https://cdn.fengxianhub.top/resources-master/202205220858699.png)



### 1.1.3.ä»“å£æ¨¡å¼

æ–¹æ¡ˆ2ï¼šä»“å£æ¨¡å¼

ä»“å£æ¨¡å¼æ¥æºäºèˆ¹èˆ±çš„è®¾è®¡ï¼š

![image-20210715172946352](https://cdn.fengxianhub.top/resources-master/202205220858193.png)

èˆ¹èˆ±éƒ½ä¼šè¢«éš”æ¿åˆ†ç¦»ä¸ºå¤šä¸ªç‹¬ç«‹ç©ºé—´ï¼Œå½“èˆ¹ä½“ç ´æŸæ—¶ï¼Œåªä¼šå¯¼è‡´éƒ¨åˆ†ç©ºé—´è¿›å…¥ï¼Œå°†æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œé¿å…æ•´ä¸ªèˆ¹ä½“éƒ½è¢«æ·¹æ²¡ã€‚



äºæ­¤ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥é™å®šæ¯ä¸ªä¸šåŠ¡èƒ½ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé¿å…è€—å°½æ•´ä¸ªtomcatçš„èµ„æºï¼Œå› æ­¤ä¹Ÿå«çº¿ç¨‹éš”ç¦»ã€‚

![image-20210715173215243](https://cdn.fengxianhub.top/resources-master/202205220859233.png)



### 1.1.4.æ–­è·¯å™¨

æ–­è·¯å™¨æ¨¡å¼ï¼šç”±**æ–­è·¯å™¨**ç»Ÿè®¡ä¸šåŠ¡æ‰§è¡Œçš„å¼‚å¸¸æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥ä¸šåŠ¡ï¼Œæ‹¦æˆªè®¿é—®è¯¥ä¸šåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ã€‚

æ–­è·¯å™¨ä¼šç»Ÿè®¡è®¿é—®æŸä¸ªæœåŠ¡çš„è¯·æ±‚æ•°é‡ï¼Œå¼‚å¸¸æ¯”ä¾‹ï¼š

![image-20210715173327075](https://cdn.fengxianhub.top/resources-master/202205220859398.png)

å½“å‘ç°è®¿é—®æœåŠ¡Dçš„è¯·æ±‚å¼‚å¸¸æ¯”ä¾‹è¿‡é«˜æ—¶ï¼Œè®¤ä¸ºæœåŠ¡Dæœ‰å¯¼è‡´é›ªå´©çš„é£é™©ï¼Œä¼šæ‹¦æˆªè®¿é—®æœåŠ¡Dçš„ä¸€åˆ‡è¯·æ±‚ï¼Œå½¢æˆç†”æ–­ï¼š

![image-20210715173428073](https://cdn.fengxianhub.top/resources-master/202205220859646.png)



### 1.1.5.é™æµ

**æµé‡æ§åˆ¶**ï¼šé™åˆ¶ä¸šåŠ¡è®¿é—®çš„QPSï¼Œé¿å…æœåŠ¡å› æµé‡çš„çªå¢è€Œæ•…éšœã€‚

![image-20210715173555158](https://cdn.fengxianhub.top/resources-master/202205220859882.png)







### 1.1.6.æ€»ç»“

ä»€ä¹ˆæ˜¯é›ªå´©é—®é¢˜ï¼Ÿ

- å¾®æœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œå› ä¸ºè°ƒç”¨é“¾ä¸­çš„ä¸€ä¸ªæœåŠ¡æ•…éšœï¼Œå¼•èµ·æ•´ä¸ªé“¾è·¯éƒ½æ— æ³•è®¿é—®çš„æƒ…å†µã€‚



å¯ä»¥è®¤ä¸ºï¼š

**é™æµ**æ˜¯å¯¹æœåŠ¡çš„ä¿æŠ¤ï¼Œé¿å…å› ç¬é—´é«˜å¹¶å‘æµé‡è€Œå¯¼è‡´æœåŠ¡æ•…éšœï¼Œè¿›è€Œé¿å…é›ªå´©ã€‚æ˜¯ä¸€ç§**é¢„é˜²**æªæ–½ã€‚

**è¶…æ—¶å¤„ç†ã€çº¿ç¨‹éš”ç¦»ã€é™çº§ç†”æ–­**æ˜¯åœ¨éƒ¨åˆ†æœåŠ¡æ•…éšœæ—¶ï¼Œå°†æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ã€‚æ˜¯ä¸€ç§**è¡¥æ•‘**æªæ–½ã€‚





## 1.2.æœåŠ¡ä¿æŠ¤æŠ€æœ¯å¯¹æ¯”

åœ¨SpringCloudå½“ä¸­æ”¯æŒå¤šç§æœåŠ¡ä¿æŠ¤æŠ€æœ¯ï¼š

- [Netfix Hystrix](https://github.com/Netflix/Hystrix)
- [Sentinel](https://github.com/alibaba/Sentinel)
- [Resilience4J](https://github.com/resilience4j/resilience4j)

æ—©æœŸæ¯”è¾ƒæµè¡Œçš„æ˜¯Hystrixæ¡†æ¶ï¼Œä½†ç›®å‰å›½å†…å®ç”¨æœ€å¹¿æ³›çš„è¿˜æ˜¯é˜¿é‡Œå·´å·´çš„Sentinelæ¡†æ¶ï¼Œè¿™é‡Œæˆ‘ä»¬åšä¸‹å¯¹æ¯”ï¼š

|                | **Sentinel**                                   | **Hystrix**                   |
| -------------- | ---------------------------------------------- | ----------------------------- |
| éš”ç¦»ç­–ç•¥       | ä¿¡å·é‡éš”ç¦»                                     | çº¿ç¨‹æ± éš”ç¦»/ä¿¡å·é‡éš”ç¦»         |
| ç†”æ–­é™çº§ç­–ç•¥   | åŸºäºæ…¢è°ƒç”¨æ¯”ä¾‹æˆ–å¼‚å¸¸æ¯”ä¾‹                       | åŸºäºå¤±è´¥æ¯”ç‡                  |
| å®æ—¶æŒ‡æ ‡å®ç°   | æ»‘åŠ¨çª—å£                                       | æ»‘åŠ¨çª—å£ï¼ˆåŸºäº RxJavaï¼‰       |
| è§„åˆ™é…ç½®       | æ”¯æŒå¤šç§æ•°æ®æº                                 | æ”¯æŒå¤šç§æ•°æ®æº                |
| æ‰©å±•æ€§         | å¤šä¸ªæ‰©å±•ç‚¹                                     | æ’ä»¶çš„å½¢å¼                    |
| åŸºäºæ³¨è§£çš„æ”¯æŒ | æ”¯æŒ                                           | æ”¯æŒ                          |
| é™æµ           | åŸºäº QPSï¼Œæ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ               | æœ‰é™çš„æ”¯æŒ                    |
| æµé‡æ•´å½¢       | æ”¯æŒæ…¢å¯åŠ¨ã€åŒ€é€Ÿæ’é˜Ÿæ¨¡å¼                       | ä¸æ”¯æŒ                        |
| ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ | æ”¯æŒ                                           | ä¸æ”¯æŒ                        |
| æ§åˆ¶å°         | å¼€ç®±å³ç”¨ï¼Œå¯é…ç½®è§„åˆ™ã€æŸ¥çœ‹ç§’çº§ç›‘æ§ã€æœºå™¨å‘ç°ç­‰ | ä¸å®Œå–„                        |
| å¸¸è§æ¡†æ¶çš„é€‚é… | Servletã€Spring Cloudã€Dubboã€gRPC  ç­‰         | Servletã€Spring Cloud Netflix |







## 1.3.Sentinelä»‹ç»å’Œå®‰è£…



### 1.3.1.åˆè¯†Sentinel

Sentinelæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾å¾®æœåŠ¡æµé‡æ§åˆ¶ç»„ä»¶ã€‚å®˜ç½‘åœ°å€ï¼šhttps://sentinelguard.io/zh-cn/index.html

Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾:

â€¢**ä¸°å¯Œçš„åº”ç”¨åœºæ™¯**ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚

â€¢**å®Œå¤‡çš„å®æ—¶ç›‘æ§**ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚

â€¢**å¹¿æ³›çš„å¼€æºç”Ÿæ€**ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Dubboã€gRPC çš„æ•´åˆã€‚æ‚¨åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥ Sentinelã€‚

â€¢**å®Œå–„çš„** **SPI** **æ‰©å±•ç‚¹**ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚



### 1.3.2.å®‰è£…Sentinel

1ï¼‰ä¸‹è½½

sentinelå®˜æ–¹æä¾›äº†UIæ§åˆ¶å°ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¯¹ç³»ç»Ÿåšé™æµè®¾ç½®ã€‚å¤§å®¶å¯ä»¥åœ¨[GitHub](https://github.com/alibaba/Sentinel/releases)ä¸‹è½½ã€‚

è¯¾å‰èµ„æ–™ä¹Ÿæä¾›äº†ä¸‹è½½å¥½çš„jaråŒ…ï¼š

![image-20210715174252531](https://cdn.fengxianhub.top/resources-master/202205220859218.png)



2ï¼‰è¿è¡Œ

å°†jaråŒ…æ”¾åˆ°ä»»æ„éä¸­æ–‡ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š

```sh
java -jar sentinel-dashboard-1.8.1.jar
```

å¦‚æœè¦ä¿®æ”¹Sentinelçš„é»˜è®¤ç«¯å£ã€è´¦æˆ·ã€å¯†ç ï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—é…ç½®ï¼š

| **é…ç½®é¡¹**                       | **é»˜è®¤å€¼** | **è¯´æ˜**   |
| -------------------------------- | ---------- | ---------- |
| server.port                      | 8080       | æœåŠ¡ç«¯å£   |
| sentinel.dashboard.auth.username | sentinel   | é»˜è®¤ç”¨æˆ·å |
| sentinel.dashboard.auth.password | sentinel   | é»˜è®¤å¯†ç    |

ä¾‹å¦‚ï¼Œä¿®æ”¹ç«¯å£ï¼š

```sh
java -Dserver.port=8090 -jar sentinel-dashboard-1.8.1.jar
```





3ï¼‰è®¿é—®

è®¿é—®http://localhost:8080é¡µé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°sentinelçš„æ§åˆ¶å°äº†ï¼š

![image-20210715190827846](https://cdn.fengxianhub.top/resources-master/202205220931656.png)

éœ€è¦è¾“å…¥è´¦å·å’Œå¯†ç ï¼Œé»˜è®¤éƒ½æ˜¯ï¼šsentinel



ç™»å½•åï¼Œå‘ç°ä¸€ç‰‡ç©ºç™½ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ï¼š

![image-20210715191134448](https://cdn.fengxianhub.top/resources-master/202205220931158.png)

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ä¸å¾®æœåŠ¡æ•´åˆã€‚





## 1.4.å¾®æœåŠ¡æ•´åˆSentinel

æˆ‘ä»¬åœ¨order-serviceä¸­æ•´åˆsentinelï¼Œå¹¶è¿æ¥sentinelçš„æ§åˆ¶å°ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1ï¼‰å¼•å…¥sentinelä¾èµ–

```xml
<!--sentinel-->
<dependency>
    <groupId>com.alibaba.cloud</groupId> 
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```



2ï¼‰é…ç½®æ§åˆ¶å°

ä¿®æ”¹application.yamlæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ï¼š

```yaml
server:
  port: 8088
spring:
  cloud: 
    sentinel:
      transport:
        dashboard: localhost:8080
```



3ï¼‰è®¿é—®order-serviceçš„ä»»æ„ç«¯ç‚¹

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®http://localhost:8088/order/101ï¼Œè¿™æ ·æ‰èƒ½è§¦å‘sentinelçš„ç›‘æ§ã€‚

ç„¶åå†è®¿é—®sentinelçš„æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ•ˆæœï¼š

![image-20210715191241799](https://cdn.fengxianhub.top/resources-master/202205220931405.png)





# 2.æµé‡æ§åˆ¶

é›ªå´©é—®é¢˜è™½ç„¶æœ‰å››ç§æ–¹æ¡ˆï¼Œä½†æ˜¯é™æµæ˜¯é¿å…æœåŠ¡å› çªå‘çš„æµé‡è€Œå‘ç”Ÿæ•…éšœï¼Œæ˜¯å¯¹å¾®æœåŠ¡é›ªå´©é—®é¢˜çš„é¢„é˜²ã€‚æˆ‘ä»¬å…ˆå­¦ä¹ è¿™ç§æ¨¡å¼ã€‚

## 2.1.ç°‡ç‚¹é“¾è·¯

å½“è¯·æ±‚è¿›å…¥å¾®æœåŠ¡æ—¶ï¼Œé¦–å…ˆä¼šè®¿é—®DispatcherServletï¼Œç„¶åè¿›å…¥Controllerã€Serviceã€Mapperï¼Œè¿™æ ·çš„ä¸€ä¸ªè°ƒç”¨é“¾å°±å«åš**ç°‡ç‚¹é“¾è·¯**ã€‚ç°‡ç‚¹é“¾è·¯ä¸­è¢«ç›‘æ§çš„æ¯ä¸€ä¸ªæ¥å£å°±æ˜¯ä¸€ä¸ª**èµ„æº**ã€‚

é»˜è®¤æƒ…å†µä¸‹sentinelä¼šç›‘æ§SpringMVCçš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼Œä¹Ÿå°±æ˜¯controllerä¸­çš„æ–¹æ³•ï¼‰ï¼Œå› æ­¤SpringMVCçš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼‰å°±æ˜¯è°ƒç”¨é“¾è·¯ä¸­çš„ä¸€ä¸ªèµ„æºã€‚



ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆšæ‰è®¿é—®çš„order-serviceä¸­çš„OrderControllerä¸­çš„ç«¯ç‚¹ï¼š/order/{orderId}

![image-20210715191757319](https://cdn.fengxianhub.top/resources-master/202205220931380.png)



æµæ§ã€ç†”æ–­ç­‰éƒ½æ˜¯é’ˆå¯¹ç°‡ç‚¹é“¾è·¯ä¸­çš„èµ„æºæ¥è®¾ç½®çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç‚¹å‡»å¯¹åº”èµ„æºåé¢çš„æŒ‰é’®æ¥è®¾ç½®è§„åˆ™ï¼š

- æµæ§ï¼šæµé‡æ§åˆ¶
- é™çº§ï¼šé™çº§ç†”æ–­
- çƒ­ç‚¹ï¼šçƒ­ç‚¹å‚æ•°é™æµï¼Œæ˜¯é™æµçš„ä¸€ç§
- æˆæƒï¼šè¯·æ±‚çš„æƒé™æ§åˆ¶





## 2.1.å¿«é€Ÿå…¥é—¨



### 2.1.1.ç¤ºä¾‹

ç‚¹å‡»èµ„æº/order/{orderId}åé¢çš„æµæ§æŒ‰é’®ï¼Œå°±å¯ä»¥å¼¹å‡ºè¡¨å•ã€‚

![image-20210715191757319](https://cdn.fengxianhub.top/resources-master/202205220932726.png)

è¡¨å•ä¸­å¯ä»¥å¡«å†™é™æµè§„åˆ™ï¼Œå¦‚ä¸‹ï¼š

![image-20210715192010657](https://cdn.fengxianhub.top/resources-master/202205220932580.png)

å…¶å«ä¹‰æ˜¯é™åˆ¶ /order/{orderId}è¿™ä¸ªèµ„æºçš„å•æœºQPSä¸º1ï¼Œå³æ¯ç§’åªå…è®¸1æ¬¡è¯·æ±‚ï¼Œè¶…å‡ºçš„è¯·æ±‚ä¼šè¢«æ‹¦æˆªå¹¶æŠ¥é”™ã€‚



### 2.1.2.ç»ƒä¹ ï¼š

éœ€æ±‚ï¼šç»™ /order/{orderId}è¿™ä¸ªèµ„æºè®¾ç½®æµæ§è§„åˆ™ï¼ŒQPSä¸èƒ½è¶…è¿‡ 5ï¼Œç„¶åæµ‹è¯•ã€‚







1ï¼‰é¦–å…ˆåœ¨sentinelæ§åˆ¶å°æ·»åŠ é™æµè§„åˆ™

![image-20210715192455429](https://cdn.fengxianhub.top/resources-master/202205220932726.png)

2ï¼‰åˆ©ç”¨jmeteræµ‹è¯•

å¦‚æœæ²¡æœ‰ç”¨è¿‡jmeterï¼Œå¯ä»¥å‚è€ƒè¯¾å‰èµ„æ–™æä¾›çš„æ–‡æ¡£ã€ŠJmeterå¿«é€Ÿå…¥é—¨.mdã€‹

è¯¾å‰èµ„æ–™æä¾›äº†ç¼–å†™å¥½çš„Jmeteræµ‹è¯•æ ·ä¾‹ï¼š

![image-20210715200431615](https://cdn.fengxianhub.top/resources-master/202205220932177.png)

æ‰“å¼€jmeterï¼Œå¯¼å…¥è¯¾å‰èµ„æ–™æä¾›çš„æµ‹è¯•æ ·ä¾‹ï¼š

![image-20210715200537171](https://cdn.fengxianhub.top/resources-master/202205220932799.png)

é€‰æ‹©ï¼š

![image-20210715200635414](https://cdn.fengxianhub.top/resources-master/202205220932365.png)

20ä¸ªç”¨æˆ·ï¼Œ2ç§’å†…è¿è¡Œå®Œï¼ŒQPSæ˜¯10ï¼Œè¶…è¿‡äº†5.

é€‰ä¸­`æµæ§å…¥é—¨ï¼ŒQPS<5`å³é”®è¿è¡Œï¼š

![image-20210715200804594](https://cdn.fengxianhub.top/resources-master/202205220932898.png)



> æ³¨æ„ï¼Œä¸è¦ç‚¹å‡»èœå•ä¸­çš„æ‰§è¡ŒæŒ‰é’®æ¥è¿è¡Œã€‚



ç»“æœï¼š

![image-20210715200853671](https://cdn.fengxianhub.top/resources-master/202205220932240.png)

å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸçš„è¯·æ±‚æ¯æ¬¡åªæœ‰5ä¸ª





## 2.2.æµæ§æ¨¡å¼

åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œç‚¹å‡»é«˜çº§é€‰é¡¹ï¼Œå¯ä»¥é€‰æ‹©ä¸‰ç§**æµæ§æ¨¡å¼**ï¼š

- ç›´æ¥ï¼šç»Ÿè®¡å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶å¯¹å½“å‰èµ„æºç›´æ¥é™æµï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼
- å…³è”ï¼šç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ
- é“¾è·¯ï¼šç»Ÿè®¡ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹æŒ‡å®šé“¾è·¯é™æµ

![image-20210715201827886](https://cdn.fengxianhub.top/resources-master/202205220932944.png)



å¿«é€Ÿå…¥é—¨æµ‹è¯•çš„å°±æ˜¯ç›´æ¥æ¨¡å¼ã€‚



### 2.2.1.å…³è”æ¨¡å¼

**å…³è”æ¨¡å¼**ï¼šç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ

**é…ç½®è§„åˆ™**ï¼š

![image-20210715202540786](https://cdn.fengxianhub.top/resources-master/202205220932001.png)

**è¯­æ³•è¯´æ˜**ï¼šå½“/writeèµ„æºè®¿é—®é‡è§¦å‘é˜ˆå€¼æ—¶ï¼Œå°±ä¼šå¯¹/readèµ„æºé™æµï¼Œé¿å…å½±å“/writeèµ„æºã€‚



**ä½¿ç”¨åœºæ™¯**ï¼šæ¯”å¦‚ç”¨æˆ·æ”¯ä»˜æ—¶éœ€è¦ä¿®æ”¹è®¢å•çŠ¶æ€ï¼ŒåŒæ—¶ç”¨æˆ·è¦æŸ¥è¯¢è®¢å•ã€‚æŸ¥è¯¢å’Œä¿®æ”¹æ“ä½œä¼šäº‰æŠ¢æ•°æ®åº“é”ï¼Œäº§ç”Ÿç«äº‰ã€‚ä¸šåŠ¡éœ€æ±‚æ˜¯ä¼˜å…ˆæ”¯ä»˜å’Œæ›´æ–°è®¢å•çš„ä¸šåŠ¡ï¼Œå› æ­¤å½“ä¿®æ”¹è®¢å•ä¸šåŠ¡è§¦å‘é˜ˆå€¼æ—¶ï¼Œéœ€è¦å¯¹æŸ¥è¯¢è®¢å•ä¸šåŠ¡é™æµã€‚



**éœ€æ±‚è¯´æ˜**ï¼š

- åœ¨OrderControlleræ–°å»ºä¸¤ä¸ªç«¯ç‚¹ï¼š/order/queryå’Œ/order/updateï¼Œæ— éœ€å®ç°ä¸šåŠ¡

- é…ç½®æµæ§è§„åˆ™ï¼Œå½“/order/ updateèµ„æºè¢«è®¿é—®çš„QPSè¶…è¿‡5æ—¶ï¼Œå¯¹/order/queryè¯·æ±‚é™æµ



1ï¼‰å®šä¹‰/order/queryç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿè®¢å•æŸ¥è¯¢

```java
@GetMapping("/query")
public String queryOrder() {
    return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
}
```

2ï¼‰å®šä¹‰/order/updateç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿè®¢å•æ›´æ–°

```java
@GetMapping("/update")
public String updateOrder() {
    return "æ›´æ–°è®¢å•æˆåŠŸ";
}
```

é‡å¯æœåŠ¡ï¼ŒæŸ¥çœ‹sentinelæ§åˆ¶å°çš„ç°‡ç‚¹é“¾è·¯ï¼š

![image-20210716101805951](https://cdn.fengxianhub.top/resources-master/202205220932155.png)



3ï¼‰é…ç½®æµæ§è§„åˆ™

å¯¹å“ªä¸ªç«¯ç‚¹é™æµï¼Œå°±ç‚¹å‡»å“ªä¸ªç«¯ç‚¹åé¢çš„æŒ‰é’®ã€‚æˆ‘ä»¬æ˜¯å¯¹è®¢å•æŸ¥è¯¢/order/queryé™æµï¼Œå› æ­¤ç‚¹å‡»å®ƒåé¢çš„æŒ‰é’®ï¼š

![image-20210716101934499](https://cdn.fengxianhub.top/resources-master/202205220932622.png)

åœ¨è¡¨å•ä¸­å¡«å†™æµæ§è§„åˆ™ï¼š

![image-20210716102103814](https://cdn.fengxianhub.top/resources-master/202205220932365.png)



4ï¼‰åœ¨Jmeteræµ‹è¯•

é€‰æ‹©ã€Šæµæ§æ¨¡å¼-å…³è”ã€‹ï¼š

![image-20210716102416266](https://cdn.fengxianhub.top/resources-master/202205220932177.png)

å¯ä»¥çœ‹åˆ°1000ä¸ªç”¨æˆ·ï¼Œ100ç§’ï¼Œå› æ­¤QPSä¸º10ï¼Œè¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„é˜ˆå€¼ï¼š5

æŸ¥çœ‹httpè¯·æ±‚ï¼š

![image-20210716102532554](https://cdn.fengxianhub.top/resources-master/202205220932254.png)

è¯·æ±‚çš„ç›®æ ‡æ˜¯/order/updateï¼Œè¿™æ ·è¿™ä¸ªæ–­ç‚¹å°±ä¼šè§¦å‘é˜ˆå€¼ã€‚

ä½†é™æµçš„ç›®æ ‡æ˜¯/order/queryï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨è®¿é—®ï¼Œå¯ä»¥å‘ç°ï¼š

![image-20210716102636030](https://cdn.fengxianhub.top/resources-master/202205220932325.png)

ç¡®å®è¢«é™æµäº†ã€‚



5ï¼‰æ€»ç»“

![image-20210716103143002](https://cdn.fengxianhub.top/resources-master/202205220932109.png)





### 2.2.2.é“¾è·¯æ¨¡å¼

**é“¾è·¯æ¨¡å¼**ï¼šåªé’ˆå¯¹ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚åšç»Ÿè®¡ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼ã€‚

**é…ç½®ç¤ºä¾‹**ï¼š

ä¾‹å¦‚æœ‰ä¸¤æ¡è¯·æ±‚é“¾è·¯ï¼š

- /test1 --> /common

- /test2 --> /common

å¦‚æœåªå¸Œæœ›ç»Ÿè®¡ä»/test2è¿›å…¥åˆ°/commonçš„è¯·æ±‚ï¼Œåˆ™å¯ä»¥è¿™æ ·é…ç½®ï¼š

![image-20210716103536346](https://cdn.fengxianhub.top/resources-master/202205220932920.png)

**å®æˆ˜æ¡ˆä¾‹**

éœ€æ±‚ï¼šæœ‰æŸ¥è¯¢è®¢å•å’Œåˆ›å»ºè®¢å•ä¸šåŠ¡ï¼Œä¸¤è€…éƒ½éœ€è¦æŸ¥è¯¢å•†å“ã€‚é’ˆå¯¹ä»æŸ¥è¯¢è®¢å•è¿›å…¥åˆ°æŸ¥è¯¢å•†å“çš„è¯·æ±‚ç»Ÿè®¡ï¼Œå¹¶è®¾ç½®é™æµã€‚

æ­¥éª¤ï¼š

1. åœ¨OrderServiceä¸­æ·»åŠ ä¸€ä¸ªqueryGoodsæ–¹æ³•ï¼Œä¸ç”¨å®ç°ä¸šåŠ¡

2. åœ¨OrderControllerä¸­ï¼Œæ”¹é€ /order/queryç«¯ç‚¹ï¼Œè°ƒç”¨OrderServiceä¸­çš„queryGoodsæ–¹æ³•

3. åœ¨OrderControllerä¸­æ·»åŠ ä¸€ä¸ª/order/saveçš„ç«¯ç‚¹ï¼Œè°ƒç”¨OrderServiceçš„queryGoodsæ–¹æ³•

4. ç»™queryGoodsè®¾ç½®é™æµè§„åˆ™ï¼Œä»/order/queryè¿›å…¥queryGoodsçš„æ–¹æ³•é™åˆ¶QPSå¿…é¡»å°äº2



å®ç°ï¼š

#### 1ï¼‰æ·»åŠ æŸ¥è¯¢å•†å“æ–¹æ³•

åœ¨order-serviceæœåŠ¡ä¸­ï¼Œç»™OrderServiceç±»æ·»åŠ ä¸€ä¸ªqueryGoodsæ–¹æ³•ï¼š

```java
public void queryGoods(){
    System.err.println("æŸ¥è¯¢å•†å“");
}
```



#### 2ï¼‰æŸ¥è¯¢è®¢å•æ—¶ï¼ŒæŸ¥è¯¢å•†å“

åœ¨order-serviceçš„OrderControllerä¸­ï¼Œä¿®æ”¹/order/queryç«¯ç‚¹çš„ä¸šåŠ¡é€»è¾‘ï¼š

```java
@GetMapping("/query")
public String queryOrder() {
    // æŸ¥è¯¢å•†å“
    orderService.queryGoods();
    // æŸ¥è¯¢è®¢å•
    System.out.println("æŸ¥è¯¢è®¢å•");
    return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
}
```



#### 3ï¼‰æ–°å¢è®¢å•ï¼ŒæŸ¥è¯¢å•†å“

åœ¨order-serviceçš„OrderControllerä¸­ï¼Œä¿®æ”¹/order/saveç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿæ–°å¢è®¢å•ï¼š

```java
@GetMapping("/save")
public String saveOrder() {
    // æŸ¥è¯¢å•†å“
    orderService.queryGoods();
    // æŸ¥è¯¢è®¢å•
    System.err.println("æ–°å¢è®¢å•");
    return "æ–°å¢è®¢å•æˆåŠŸ";
}
```



#### 4ï¼‰ç»™æŸ¥è¯¢å•†å“æ·»åŠ èµ„æºæ ‡è®°

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOrderServiceä¸­çš„æ–¹æ³•æ˜¯ä¸è¢«Sentinelç›‘æ§çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±é€šè¿‡æ³¨è§£æ¥æ ‡è®°è¦ç›‘æ§çš„æ–¹æ³•ã€‚

ç»™OrderServiceçš„queryGoodsæ–¹æ³•æ·»åŠ @SentinelResourceæ³¨è§£ï¼š

```java
@SentinelResource("goods")
public void queryGoods(){
    System.err.println("æŸ¥è¯¢å•†å“");
}
```



é“¾è·¯æ¨¡å¼ä¸­ï¼Œæ˜¯å¯¹ä¸åŒæ¥æºçš„ä¸¤ä¸ªé“¾è·¯åšç›‘æ§ã€‚ä½†æ˜¯sentinelé»˜è®¤ä¼šç»™è¿›å…¥SpringMVCçš„æ‰€æœ‰è¯·æ±‚è®¾ç½®åŒä¸€ä¸ªrootèµ„æºï¼Œä¼šå¯¼è‡´é“¾è·¯æ¨¡å¼å¤±æ•ˆã€‚

æˆ‘ä»¬éœ€è¦å…³é—­è¿™ç§å¯¹SpringMVCçš„èµ„æºèšåˆï¼Œä¿®æ”¹order-serviceæœåŠ¡çš„application.ymlæ–‡ä»¶ï¼š

```yaml
spring:
  cloud:
    sentinel:
      web-context-unify: false # å…³é—­contextæ•´åˆ
```

é‡å¯æœåŠ¡ï¼Œè®¿é—®/order/queryå’Œ/order/saveï¼Œå¯ä»¥æŸ¥çœ‹åˆ°sentinelçš„ç°‡ç‚¹é“¾è·¯è§„åˆ™ä¸­ï¼Œå‡ºç°äº†æ–°çš„èµ„æºï¼š

![image-20210716105227163](https://cdn.fengxianhub.top/resources-master/202205221030827.png)



#### 5ï¼‰æ·»åŠ æµæ§è§„åˆ™

ç‚¹å‡»goodsèµ„æºåé¢çš„æµæ§æŒ‰é’®ï¼Œåœ¨å¼¹å‡ºçš„è¡¨å•ä¸­å¡«å†™ä¸‹é¢ä¿¡æ¯ï¼š

![image-20210716105408723](https://cdn.fengxianhub.top/resources-master/202205221030105.png)



åªç»Ÿè®¡ä»/order/queryè¿›å…¥/goodsçš„èµ„æºï¼ŒQPSé˜ˆå€¼ä¸º2ï¼Œè¶…å‡ºåˆ™è¢«é™æµã€‚



#### 6ï¼‰Jmeteræµ‹è¯•

é€‰æ‹©ã€Šæµæ§æ¨¡å¼-é“¾è·¯ã€‹ï¼š

![image-20210716105612312](https://cdn.fengxianhub.top/resources-master/202205221030714.png)

å¯ä»¥çœ‹åˆ°è¿™é‡Œ200ä¸ªç”¨æˆ·ï¼Œ50ç§’å†…å‘å®Œï¼ŒQPSä¸º4ï¼Œè¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„é˜ˆå€¼2

ä¸€ä¸ªhttpè¯·æ±‚æ˜¯è®¿é—®/order/saveï¼š

![image-20210716105812789](https://cdn.fengxianhub.top/resources-master/202205221030570.png)

è¿è¡Œçš„ç»“æœï¼š

![image-20210716110027064](https://cdn.fengxianhub.top/resources-master/202205221030151.png)

å®Œå…¨ä¸å—å½±å“ã€‚



å¦ä¸€ä¸ªæ˜¯è®¿é—®/order/queryï¼š

![image-20210716105855951](https://cdn.fengxianhub.top/resources-master/202205221030864.png)

è¿è¡Œç»“æœï¼š

![image-20210716105956401](https://cdn.fengxianhub.top/resources-master/202205221030344.png)

æ¯æ¬¡åªæœ‰2ä¸ªé€šè¿‡ã€‚



### 2.2.3.æ€»ç»“

æµæ§æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ

â€¢ç›´æ¥ï¼šå¯¹å½“å‰èµ„æºé™æµ

â€¢å…³è”ï¼šé«˜ä¼˜å…ˆçº§èµ„æºè§¦å‘é˜ˆå€¼ï¼Œå¯¹ä½ä¼˜å…ˆçº§èµ„æºé™æµã€‚

â€¢é“¾è·¯ï¼šé˜ˆå€¼ç»Ÿè®¡æ—¶ï¼Œåªç»Ÿè®¡ä»æŒ‡å®šèµ„æºè¿›å…¥å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œæ˜¯å¯¹è¯·æ±‚æ¥æºçš„é™æµ



## 2.3.æµæ§æ•ˆæœ

åœ¨æµæ§çš„é«˜çº§é€‰é¡¹ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªæµæ§æ•ˆæœé€‰é¡¹ï¼š

![image-20210716110225104](https://cdn.fengxianhub.top/resources-master/202205221030344.png)

æµæ§æ•ˆæœæ˜¯æŒ‡è¯·æ±‚è¾¾åˆ°æµæ§é˜ˆå€¼æ—¶åº”è¯¥é‡‡å–çš„æªæ–½ï¼ŒåŒ…æ‹¬ä¸‰ç§ï¼š

- å¿«é€Ÿå¤±è´¥ï¼šè¾¾åˆ°é˜ˆå€¼åï¼Œæ–°çš„è¯·æ±‚ä¼šè¢«ç«‹å³æ‹’ç»å¹¶æŠ›å‡ºFlowExceptionå¼‚å¸¸ã€‚æ˜¯é»˜è®¤çš„å¤„ç†æ–¹å¼ã€‚

- warm upï¼šé¢„çƒ­æ¨¡å¼ï¼Œå¯¹è¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚åŒæ ·æ˜¯æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä½†è¿™ç§æ¨¡å¼é˜ˆå€¼ä¼šåŠ¨æ€å˜åŒ–ï¼Œä»ä¸€ä¸ªè¾ƒå°å€¼é€æ¸å¢åŠ åˆ°æœ€å¤§é˜ˆå€¼ã€‚

- æ’é˜Ÿç­‰å¾…ï¼šè®©æ‰€æœ‰çš„è¯·æ±‚æŒ‰ç…§å…ˆåæ¬¡åºæ’é˜Ÿæ‰§è¡Œï¼Œä¸¤ä¸ªè¯·æ±‚çš„é—´éš”ä¸èƒ½å°äºæŒ‡å®šæ—¶é•¿



### 2.3.1.warm up

é˜ˆå€¼ä¸€èˆ¬æ˜¯ä¸€ä¸ªå¾®æœåŠ¡èƒ½æ‰¿æ‹…çš„æœ€å¤§QPSï¼Œä½†æ˜¯ä¸€ä¸ªæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼Œä¸€åˆ‡èµ„æºå°šæœªåˆå§‹åŒ–ï¼ˆ**å†·å¯åŠ¨**ï¼‰ï¼Œå¦‚æœç›´æ¥å°†QPSè·‘åˆ°æœ€å¤§å€¼ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ç¬é—´å®•æœºã€‚



warm upä¹Ÿå«**é¢„çƒ­æ¨¡å¼**ï¼Œæ˜¯åº”å¯¹æœåŠ¡å†·å¯åŠ¨çš„ä¸€ç§æ–¹æ¡ˆã€‚è¯·æ±‚é˜ˆå€¼åˆå§‹å€¼æ˜¯ maxThreshold / coldFactorï¼ŒæŒç»­æŒ‡å®šæ—¶é•¿åï¼Œé€æ¸æé«˜åˆ°maxThresholdå€¼ã€‚è€ŒcoldFactorçš„é»˜è®¤å€¼æ˜¯3.

ä¾‹å¦‚ï¼Œæˆ‘è®¾ç½®QPSçš„maxThresholdä¸º10ï¼Œé¢„çƒ­æ—¶é—´ä¸º5ç§’ï¼Œé‚£ä¹ˆåˆå§‹é˜ˆå€¼å°±æ˜¯ 10 / 3 ï¼Œä¹Ÿå°±æ˜¯3ï¼Œç„¶ååœ¨5ç§’åé€æ¸å¢é•¿åˆ°10.

![image-20210716110629796](https://cdn.fengxianhub.top/resources-master/202205221030540.png)



**æ¡ˆä¾‹**

éœ€æ±‚ï¼šç»™/order/{orderId}è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§QPSä¸º10ï¼Œåˆ©ç”¨warm upæ•ˆæœï¼Œé¢„çƒ­æ—¶é•¿ä¸º5ç§’



#### 1ï¼‰é…ç½®æµæ§è§„åˆ™ï¼š

![image-20210716111012387](https://cdn.fengxianhub.top/resources-master/202205221030697.png)



#### 2ï¼‰Jmeteræµ‹è¯•

é€‰æ‹©ã€Šæµæ§æ•ˆæœï¼Œwarm upã€‹ï¼š

![image-20210716111136699](https://cdn.fengxianhub.top/resources-master/202205221031743.png)

QPSä¸º10.

åˆšåˆšå¯åŠ¨æ—¶ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚å¤±è´¥ï¼ŒæˆåŠŸçš„åªæœ‰3ä¸ªï¼Œè¯´æ˜QPSè¢«é™å®šåœ¨3ï¼š

![image-20210716111303701](https://cdn.fengxianhub.top/resources-master/202205221031805.png)

éšç€æ—¶é—´æ¨ç§»ï¼ŒæˆåŠŸæ¯”ä¾‹è¶Šæ¥è¶Šé«˜ï¼š

![image-20210716111404717](https://cdn.fengxianhub.top/resources-master/202205221031442.png)



åˆ°Sentinelæ§åˆ¶å°æŸ¥çœ‹å®æ—¶ç›‘æ§ï¼š

![image-20210716111526480](https://cdn.fengxianhub.top/resources-master/202205221031068.png)

ä¸€æ®µæ—¶é—´åï¼š

![image-20210716111658541](https://cdn.fengxianhub.top/resources-master/202205221031147.png)





### 2.3.2.æ’é˜Ÿç­‰å¾…

å½“è¯·æ±‚è¶…è¿‡QPSé˜ˆå€¼æ—¶ï¼Œå¿«é€Ÿå¤±è´¥å’Œwarm up ä¼šæ‹’ç»æ–°çš„è¯·æ±‚å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

è€Œæ’é˜Ÿç­‰å¾…åˆ™æ˜¯è®©æ‰€æœ‰è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œã€‚åæ¥çš„è¯·æ±‚å¿…é¡»ç­‰å¾…å‰é¢æ‰§è¡Œå®Œæˆï¼Œå¦‚æœè¯·æ±‚é¢„æœŸçš„ç­‰å¾…æ—¶é—´è¶…å‡ºæœ€å¤§æ—¶é•¿ï¼Œåˆ™ä¼šè¢«æ‹’ç»ã€‚

å·¥ä½œåŸç†

ä¾‹å¦‚ï¼šQPS = 5ï¼Œæ„å‘³ç€æ¯200mså¤„ç†ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼›timeout = 2000ï¼Œæ„å‘³ç€**é¢„æœŸç­‰å¾…æ—¶é•¿**è¶…è¿‡2000msçš„è¯·æ±‚ä¼šè¢«æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

é‚£ä»€ä¹ˆå«åšé¢„æœŸç­‰å¾…æ—¶é•¿å‘¢ï¼Ÿ

æ¯”å¦‚ç°åœ¨ä¸€ä¸‹å­æ¥äº†12 ä¸ªè¯·æ±‚ï¼Œå› ä¸ºæ¯200msæ‰§è¡Œä¸€ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆï¼š

- ç¬¬6ä¸ªè¯·æ±‚çš„**é¢„æœŸç­‰å¾…æ—¶é•¿** =  200 * ï¼ˆ6 - 1ï¼‰ = 1000ms
- ç¬¬12ä¸ªè¯·æ±‚çš„é¢„æœŸç­‰å¾…æ—¶é•¿ = 200 * ï¼ˆ12-1ï¼‰ = 2200ms



ç°åœ¨ï¼Œç¬¬1ç§’åŒæ—¶æ¥æ”¶åˆ°10ä¸ªè¯·æ±‚ï¼Œä½†ç¬¬2ç§’åªæœ‰1ä¸ªè¯·æ±‚ï¼Œæ­¤æ—¶QPSçš„æ›²çº¿è¿™æ ·çš„ï¼š

![image-20210716113147176](https://cdn.fengxianhub.top/resources-master/202205251748705.png)

å¦‚æœä½¿ç”¨é˜Ÿåˆ—æ¨¡å¼åšæµæ§ï¼Œæ‰€æœ‰è¿›å…¥çš„è¯·æ±‚éƒ½è¦æ’é˜Ÿï¼Œä»¥å›ºå®šçš„200msçš„é—´éš”æ‰§è¡Œï¼ŒQPSä¼šå˜çš„å¾ˆå¹³æ»‘ï¼š

![image-20210716113426524](https://cdn.fengxianhub.top/resources-master/202205251748716.png)



å¹³æ»‘çš„QPSæ›²çº¿ï¼Œå¯¹äºæœåŠ¡å™¨æ¥è¯´æ˜¯æ›´å‹å¥½çš„ã€‚



**æ¡ˆä¾‹**

éœ€æ±‚ï¼šç»™/order/{orderId}è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§QPSä¸º10ï¼Œåˆ©ç”¨æ’é˜Ÿçš„æµæ§æ•ˆæœï¼Œè¶…æ—¶æ—¶é•¿è®¾ç½®ä¸º5s



#### 1ï¼‰æ·»åŠ æµæ§è§„åˆ™

![image-20210716114048918](https://cdn.fengxianhub.top/resources-master/202205221031524.png)



#### 2ï¼‰Jmeteræµ‹è¯•

é€‰æ‹©ã€Šæµæ§æ•ˆæœï¼Œé˜Ÿåˆ—ã€‹ï¼š

![image-20210716114243558](https://cdn.fengxianhub.top/resources-master/202205221031704.png)

QPSä¸º15ï¼Œå·²ç»è¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„10ã€‚

å¦‚æœæ˜¯ä¹‹å‰çš„ å¿«é€Ÿå¤±è´¥ã€warmupæ¨¡å¼ï¼Œè¶…å‡ºçš„è¯·æ±‚åº”è¯¥ä¼šç›´æ¥æŠ¥é”™ã€‚

ä½†æ˜¯æˆ‘ä»¬çœ‹çœ‹é˜Ÿåˆ—æ¨¡å¼çš„è¿è¡Œç»“æœï¼š

![image-20210716114429361](https://cdn.fengxianhub.top/resources-master/202205221031306.png)

å…¨éƒ¨éƒ½é€šè¿‡äº†ã€‚

å†å»sentinelæŸ¥çœ‹å®æ—¶ç›‘æ§çš„QPSæ›²çº¿ï¼š

![image-20210716114522935](https://cdn.fengxianhub.top/resources-master/202205221031669.png)

QPSéå¸¸å¹³æ»‘ï¼Œä¸€è‡´ä¿æŒåœ¨10ï¼Œä½†æ˜¯è¶…å‡ºçš„è¯·æ±‚æ²¡æœ‰è¢«æ‹’ç»ï¼Œè€Œæ˜¯æ”¾å…¥é˜Ÿåˆ—ã€‚å› æ­¤**å“åº”æ—¶é—´**ï¼ˆç­‰å¾…æ—¶é—´ï¼‰ä¼šè¶Šæ¥è¶Šé•¿ã€‚

å½“é˜Ÿåˆ—æ»¡äº†ä»¥åï¼Œæ‰ä¼šæœ‰éƒ¨åˆ†è¯·æ±‚å¤±è´¥ï¼š

![image-20210716114651137](https://cdn.fengxianhub.top/resources-master/202205221031307.png)





### 2.3.3.æ€»ç»“

æµæ§æ•ˆæœæœ‰å“ªäº›ï¼Ÿ

- å¿«é€Ÿå¤±è´¥ï¼šQPSè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‹’ç»æ–°çš„è¯·æ±‚

- warm upï¼š QPSè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‹’ç»æ–°çš„è¯·æ±‚ï¼›QPSé˜ˆå€¼æ˜¯é€æ¸æå‡çš„ï¼Œå¯ä»¥é¿å…å†·å¯åŠ¨æ—¶é«˜å¹¶å‘å¯¼è‡´æœåŠ¡å®•æœºã€‚

- æ’é˜Ÿç­‰å¾…ï¼šè¯·æ±‚ä¼šè¿›å…¥é˜Ÿåˆ—ï¼ŒæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œè¯·æ±‚ï¼›å¦‚æœè¯·æ±‚é¢„æœŸç­‰å¾…æ—¶é•¿å¤§äºè¶…æ—¶æ—¶é—´ï¼Œç›´æ¥æ‹’ç»





## 2.4.çƒ­ç‚¹å‚æ•°é™æµ

ä¹‹å‰çš„é™æµæ˜¯ç»Ÿè®¡è®¿é—®æŸä¸ªèµ„æºçš„æ‰€æœ‰è¯·æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡QPSé˜ˆå€¼ã€‚è€Œçƒ­ç‚¹å‚æ•°é™æµæ˜¯**åˆ†åˆ«ç»Ÿè®¡å‚æ•°å€¼ç›¸åŒçš„è¯·æ±‚**ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡QPSé˜ˆå€¼ã€‚

### 2.4.1.å…¨å±€å‚æ•°é™æµ

ä¾‹å¦‚ï¼Œä¸€ä¸ªæ ¹æ®idæŸ¥è¯¢å•†å“çš„æ¥å£ï¼š

![image-20210716115014663](https://cdn.fengxianhub.top/resources-master/202205221031700.png)

è®¿é—®/goods/{id}çš„è¯·æ±‚ä¸­ï¼Œidå‚æ•°å€¼ä¼šæœ‰å˜åŒ–ï¼Œçƒ­ç‚¹å‚æ•°é™æµä¼šæ ¹æ®å‚æ•°å€¼åˆ†åˆ«ç»Ÿè®¡QPSï¼Œç»Ÿè®¡ç»“æœï¼š

![image-20210716115131463](https://cdn.fengxianhub.top/resources-master/202205221031664.png)

å½“id=1çš„è¯·æ±‚è§¦å‘é˜ˆå€¼è¢«é™æµæ—¶ï¼Œidå€¼ä¸ä¸º1çš„è¯·æ±‚ä¸å—å½±å“ã€‚



é…ç½®ç¤ºä¾‹ï¼š

![image-20210716115232426](https://cdn.fengxianhub.top/resources-master/202205221031592.png)

ä»£è¡¨çš„å«ä¹‰æ˜¯ï¼šå¯¹hotè¿™ä¸ªèµ„æºçš„0å·å‚æ•°ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰åšç»Ÿè®¡ï¼Œæ¯1ç§’**ç›¸åŒå‚æ•°å€¼**çš„è¯·æ±‚æ•°ä¸èƒ½è¶…è¿‡5



### 2.4.2.çƒ­ç‚¹å‚æ•°é™æµ

åˆšæ‰çš„é…ç½®ä¸­ï¼Œå¯¹æŸ¥è¯¢å•†å“è¿™ä¸ªæ¥å£çš„æ‰€æœ‰å•†å“ä¸€è§†åŒä»ï¼ŒQPSéƒ½é™å®šä¸º5.

è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯èƒ½éƒ¨åˆ†å•†å“æ˜¯çƒ­ç‚¹å•†å“ï¼Œä¾‹å¦‚ç§’æ€å•†å“ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™éƒ¨åˆ†å•†å“çš„QPSé™åˆ¶ä¸å…¶å®ƒå•†å“ä¸ä¸€æ ·ï¼Œé«˜ä¸€äº›ã€‚é‚£å°±éœ€è¦é…ç½®çƒ­ç‚¹å‚æ•°é™æµçš„é«˜çº§é€‰é¡¹äº†ï¼š

![image-20210716115717523](https://cdn.fengxianhub.top/resources-master/202205221031635.png)

ç»“åˆä¸Šä¸€ä¸ªé…ç½®ï¼Œè¿™é‡Œçš„å«ä¹‰æ˜¯å¯¹0å·çš„longç±»å‹å‚æ•°é™æµï¼Œæ¯1ç§’ç›¸åŒå‚æ•°çš„QPSä¸èƒ½è¶…è¿‡5ï¼Œæœ‰ä¸¤ä¸ªä¾‹å¤–ï¼š

â€¢å¦‚æœå‚æ•°å€¼æ˜¯100ï¼Œåˆ™æ¯1ç§’å…è®¸çš„QPSä¸º10

â€¢å¦‚æœå‚æ•°å€¼æ˜¯101ï¼Œåˆ™æ¯1ç§’å…è®¸çš„QPSä¸º15



### 2.4.4.æ¡ˆä¾‹

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™/order/{orderId}è¿™ä¸ªèµ„æºæ·»åŠ çƒ­ç‚¹å‚æ•°é™æµï¼Œè§„åˆ™å¦‚ä¸‹ï¼š

â€¢é»˜è®¤çš„çƒ­ç‚¹å‚æ•°è§„åˆ™æ˜¯æ¯1ç§’è¯·æ±‚é‡ä¸è¶…è¿‡2

â€¢ç»™102è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯1ç§’è¯·æ±‚é‡ä¸è¶…è¿‡4

â€¢ç»™103è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯1ç§’è¯·æ±‚é‡ä¸è¶…è¿‡10



**æ³¨æ„äº‹é¡¹**ï¼šçƒ­ç‚¹å‚æ•°é™æµå¯¹é»˜è®¤çš„SpringMVCèµ„æºæ— æ•ˆï¼Œéœ€è¦åˆ©ç”¨@SentinelResourceæ³¨è§£æ ‡è®°èµ„æº



#### 1ï¼‰æ ‡è®°èµ„æº

ç»™order-serviceä¸­çš„OrderControllerä¸­çš„/order/{orderId}èµ„æºæ·»åŠ æ³¨è§£ï¼š

![image-20210716120033572](https://cdn.fengxianhub.top/resources-master/202205221031838.png)



#### 2ï¼‰çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™

è®¿é—®è¯¥æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ ‡è®°çš„hotèµ„æºå‡ºç°äº†ï¼š

![image-20210716120208509](https://cdn.fengxianhub.top/resources-master/202205221031487.png)

è¿™é‡Œä¸è¦ç‚¹å‡»hotåé¢çš„æŒ‰é’®ï¼Œé¡µé¢æœ‰BUG



ç‚¹å‡»å·¦ä¾§èœå•ä¸­**çƒ­ç‚¹è§„åˆ™**èœå•ï¼š

![image-20210716120319009](https://cdn.fengxianhub.top/resources-master/202205221031194.png)

ç‚¹å‡»æ–°å¢ï¼Œå¡«å†™è¡¨å•ï¼š

![image-20210716120536714](https://cdn.fengxianhub.top/resources-master/202205221031933.png)



#### 3ï¼‰Jmeteræµ‹è¯•

é€‰æ‹©ã€Šçƒ­ç‚¹å‚æ•°é™æµ QPS1ã€‹ï¼š

![image-20210716120754527](https://cdn.fengxianhub.top/resources-master/202205221031629.png)

è¿™é‡Œå‘èµ·è¯·æ±‚çš„QPSä¸º5.

åŒ…å«3ä¸ªhttpè¯·æ±‚ï¼š

æ™®é€šå‚æ•°ï¼ŒQPSé˜ˆå€¼ä¸º2

![image-20210716120840501](https://cdn.fengxianhub.top/resources-master/202205221031534.png)

è¿è¡Œç»“æœï¼š

![image-20210716121105567](https://cdn.fengxianhub.top/resources-master/202205221031835.png)



ä¾‹å¤–é¡¹ï¼ŒQPSé˜ˆå€¼ä¸º4

![image-20210716120900365](https://cdn.fengxianhub.top/resources-master/202205221031303.png)

è¿è¡Œç»“æœï¼š

![image-20210716121201630](https://cdn.fengxianhub.top/resources-master/202205221031556.png)



ä¾‹å¤–é¡¹ï¼ŒQPSé˜ˆå€¼ä¸º10

![image-20210716120919131](https://cdn.fengxianhub.top/resources-master/202205221031579.png)

è¿è¡Œç»“æœï¼š

![image-20210716121220305](https://cdn.fengxianhub.top/resources-master/202205221031985.png)



# 3.éš”ç¦»å’Œé™çº§

é™æµæ˜¯ä¸€ç§é¢„é˜²æªæ–½ï¼Œè™½ç„¶é™æµå¯ä»¥å°½é‡é¿å…å› é«˜å¹¶å‘è€Œå¼•èµ·çš„æœåŠ¡æ•…éšœï¼Œä½†æœåŠ¡è¿˜ä¼šå› ä¸ºå…¶å®ƒåŸå› è€Œæ•…éšœã€‚

è€Œè¦å°†è¿™äº›æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ï¼Œå°±è¦é **çº¿ç¨‹éš”ç¦»**ï¼ˆèˆ±å£æ¨¡å¼ï¼‰å’Œ**ç†”æ–­é™çº§**æ‰‹æ®µäº†ã€‚



**çº¿ç¨‹éš”ç¦»**ä¹‹å‰è®²åˆ°è¿‡ï¼šè°ƒç”¨è€…åœ¨è°ƒç”¨æœåŠ¡æä¾›è€…æ—¶ï¼Œç»™æ¯ä¸ªè°ƒç”¨çš„è¯·æ±‚åˆ†é…ç‹¬ç«‹çº¿ç¨‹æ± ï¼Œå‡ºç°æ•…éšœæ—¶ï¼Œæœ€å¤šæ¶ˆè€—è¿™ä¸ªçº¿ç¨‹æ± å†…èµ„æºï¼Œé¿å…æŠŠè°ƒç”¨è€…çš„æ‰€æœ‰èµ„æºè€—å°½ã€‚

![image-20210715173215243](https://cdn.fengxianhub.top/resources-master/202205221032602.png)



**ç†”æ–­é™çº§**ï¼šæ˜¯åœ¨è°ƒç”¨æ–¹è¿™è¾¹åŠ å…¥æ–­è·¯å™¨ï¼Œç»Ÿè®¡å¯¹æœåŠ¡æä¾›è€…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨çš„å¤±è´¥æ¯”ä¾‹è¿‡é«˜ï¼Œåˆ™ç†”æ–­è¯¥ä¸šåŠ¡ï¼Œä¸å…è®¸è®¿é—®è¯¥æœåŠ¡çš„æä¾›è€…äº†ã€‚

![image-20210715173428073](https://cdn.fengxianhub.top/resources-master/202205221032687.png)





å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯çº¿ç¨‹éš”ç¦»è¿˜æ˜¯ç†”æ–­é™çº§ï¼Œéƒ½æ˜¯å¯¹**å®¢æˆ·ç«¯**ï¼ˆè°ƒç”¨æ–¹ï¼‰çš„ä¿æŠ¤ã€‚éœ€è¦åœ¨**è°ƒç”¨æ–¹** å‘èµ·è¿œç¨‹è°ƒç”¨æ—¶åšçº¿ç¨‹éš”ç¦»ã€æˆ–è€…æœåŠ¡ç†”æ–­ã€‚

è€Œæˆ‘ä»¬çš„å¾®æœåŠ¡è¿œç¨‹è°ƒç”¨éƒ½æ˜¯åŸºäºFeignæ¥å®Œæˆçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†Feignä¸Sentinelæ•´åˆï¼Œåœ¨Feigné‡Œé¢å®ç°çº¿ç¨‹éš”ç¦»å’ŒæœåŠ¡ç†”æ–­ã€‚



## 3.1.FeignClientæ•´åˆSentinel

SpringCloudä¸­ï¼Œå¾®æœåŠ¡è°ƒç”¨éƒ½æ˜¯é€šè¿‡Feignæ¥å®ç°çš„ï¼Œå› æ­¤åšå®¢æˆ·ç«¯ä¿æŠ¤å¿…é¡»æ•´åˆFeignå’ŒSentinelã€‚



### 3.1.1.ä¿®æ”¹é…ç½®ï¼Œå¼€å¯sentinelåŠŸèƒ½

ä¿®æ”¹OrderServiceçš„application.ymlæ–‡ä»¶ï¼Œå¼€å¯Feignçš„SentinelåŠŸèƒ½ï¼š

```yaml
feign:
  sentinel:
    enabled: true # å¼€å¯feignå¯¹sentinelçš„æ”¯æŒ
```



### 3.1.2.ç¼–å†™å¤±è´¥é™çº§é€»è¾‘

ä¸šåŠ¡å¤±è´¥åï¼Œä¸èƒ½ç›´æ¥æŠ¥é”™ï¼Œè€Œåº”è¯¥è¿”å›ç”¨æˆ·ä¸€ä¸ªå‹å¥½æç¤ºæˆ–è€…é»˜è®¤ç»“æœï¼Œè¿™ä¸ªå°±æ˜¯å¤±è´¥é™çº§é€»è¾‘ã€‚

ç»™FeignClientç¼–å†™å¤±è´¥åçš„é™çº§é€»è¾‘

â‘ æ–¹å¼ä¸€ï¼šFallbackClassï¼Œæ— æ³•å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†

â‘¡æ–¹å¼äºŒï¼šFallbackFactoryï¼Œå¯ä»¥å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†ï¼Œæˆ‘ä»¬é€‰æ‹©è¿™ç§



è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºæ–¹å¼äºŒçš„å¤±è´¥é™çº§å¤„ç†ã€‚

**æ­¥éª¤ä¸€**ï¼šåœ¨feing-apié¡¹ç›®ä¸­å®šä¹‰ç±»ï¼Œå®ç°FallbackFactoryï¼š

![image-20210716122403502](https://cdn.fengxianhub.top/resources-master/202205221033496.png)

ä»£ç ï¼š

```java
package cn.itcast.feign.clients.fallback;

import cn.itcast.feign.clients.UserClient;
import cn.itcast.feign.pojo.User;
import feign.hystrix.FallbackFactory;
import lombok.extern.slf4j.Slf4j;

@Slf4j
public class UserClientFallbackFactory implements FallbackFactory<UserClient> {
    @Override
    public UserClient create(Throwable throwable) {
        return new UserClient() {
            @Override
            public User findById(Long id) {
                log.error("æŸ¥è¯¢ç”¨æˆ·å¼‚å¸¸", throwable);
                return new User();
            }
        };
    }
}

```



**æ­¥éª¤äºŒ**ï¼šåœ¨feing-apié¡¹ç›®ä¸­çš„DefaultFeignConfigurationç±»ä¸­å°†UserClientFallbackFactoryæ³¨å†Œä¸ºä¸€ä¸ªBeanï¼š

```java
@Bean
public UserClientFallbackFactory userClientFallbackFactory(){
    return new UserClientFallbackFactory();
}
```

**æ­¥éª¤ä¸‰**ï¼šåœ¨feing-apié¡¹ç›®ä¸­çš„UserClientæ¥å£ä¸­ä½¿ç”¨UserClientFallbackFactoryï¼š

```java
import cn.itcast.feign.clients.fallback.UserClientFallbackFactory;
import cn.itcast.feign.pojo.User;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient(value = "userservice", fallbackFactory = UserClientFallbackFactory.class)
public interface UserClient {

    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```



é‡å¯åï¼Œè®¿é—®ä¸€æ¬¡è®¢å•æŸ¥è¯¢ä¸šåŠ¡ï¼Œç„¶åæŸ¥çœ‹sentinelæ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°æ–°çš„ç°‡ç‚¹é“¾è·¯ï¼š

![image-20210716123705780](https://cdn.fengxianhub.top/resources-master/202205221133604.png)





### 3.1.3.æ€»ç»“

Sentinelæ”¯æŒçš„é›ªå´©è§£å†³æ–¹æ¡ˆï¼š

- çº¿ç¨‹éš”ç¦»ï¼ˆä»“å£æ¨¡å¼ï¼‰
- é™çº§ç†”æ–­

Feignæ•´åˆSentinelçš„æ­¥éª¤ï¼š

- åœ¨application.ymlä¸­é…ç½®ï¼šfeign.sentienl.enable=true
- ç»™FeignClientç¼–å†™FallbackFactoryå¹¶æ³¨å†Œä¸ºBean
- å°†FallbackFactoryé…ç½®åˆ°FeignClient







## 3.2.çº¿ç¨‹éš”ç¦»ï¼ˆèˆ±å£æ¨¡å¼ï¼‰



### 3.2.1.çº¿ç¨‹éš”ç¦»çš„å®ç°æ–¹å¼

çº¿ç¨‹éš”ç¦»æœ‰ä¸¤ç§æ–¹å¼å®ç°ï¼š

- çº¿ç¨‹æ± éš”ç¦»

- ä¿¡å·é‡éš”ç¦»ï¼ˆSentinelé»˜è®¤é‡‡ç”¨ï¼‰

å¦‚å›¾ï¼š

![image-20210716123036937](https://cdn.fengxianhub.top/resources-master/202205221133493.png)



**çº¿ç¨‹æ± éš”ç¦»**ï¼šç»™æ¯ä¸ªæœåŠ¡è°ƒç”¨ä¸šåŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œåˆ©ç”¨çº¿ç¨‹æ± æœ¬èº«å®ç°éš”ç¦»æ•ˆæœ

**ä¿¡å·é‡éš”ç¦»**ï¼šä¸åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯è®¡æ•°å™¨æ¨¡å¼ï¼Œè®°å½•ä¸šåŠ¡ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡ï¼Œè¾¾åˆ°ä¿¡å·é‡ä¸Šé™æ—¶ï¼Œç¦æ­¢æ–°çš„è¯·æ±‚ã€‚



ä¸¤è€…çš„ä¼˜ç¼ºç‚¹ï¼š

![image-20210716123240518](https://cdn.fengxianhub.top/resources-master/202205221133091.png)





### 3.2.2.sentinelçš„çº¿ç¨‹éš”ç¦»

**ç”¨æ³•è¯´æ˜**ï¼š

åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¸¤ç§é˜ˆå€¼ç±»å‹ï¼š

![image-20210716123411217](https://cdn.fengxianhub.top/resources-master/202205221133088.png)

- QPSï¼šå°±æ˜¯æ¯ç§’çš„è¯·æ±‚æ•°ï¼Œåœ¨å¿«é€Ÿå…¥é—¨ä¸­å·²ç»æ¼”ç¤ºè¿‡

- çº¿ç¨‹æ•°ï¼šæ˜¯è¯¥èµ„æºèƒ½ä½¿ç”¨ç”¨çš„tomcatçº¿ç¨‹æ•°çš„æœ€å¤§å€¼ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå®ç°**çº¿ç¨‹éš”ç¦»**ï¼ˆèˆ±å£æ¨¡å¼ï¼‰ã€‚



**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ order-serviceæœåŠ¡ä¸­çš„UserClientçš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®æµæ§è§„åˆ™ï¼Œçº¿ç¨‹æ•°ä¸èƒ½è¶…è¿‡ 2ã€‚ç„¶ååˆ©ç”¨jemeteræµ‹è¯•ã€‚



#### 1ï¼‰é…ç½®éš”ç¦»è§„åˆ™

é€‰æ‹©feignæ¥å£åé¢çš„æµæ§æŒ‰é’®ï¼š

![image-20210716123831992](https://cdn.fengxianhub.top/resources-master/202205221133463.png)

å¡«å†™è¡¨å•ï¼š

![image-20210716123936844](https://cdn.fengxianhub.top/resources-master/202205221133769.png)



#### 2ï¼‰Jmeteræµ‹è¯•

é€‰æ‹©ã€Šé˜ˆå€¼ç±»å‹-çº¿ç¨‹æ•°<2ã€‹ï¼š

![image-20210716124229894](https://cdn.fengxianhub.top/resources-master/202205221133457.png)

ä¸€æ¬¡å‘ç”Ÿ10ä¸ªè¯·æ±‚ï¼Œæœ‰è¾ƒå¤§æ¦‚ç‡å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡2ï¼Œè€Œè¶…å‡ºçš„è¯·æ±‚ä¼šèµ°ä¹‹å‰å®šä¹‰çš„å¤±è´¥é™çº§é€»è¾‘ã€‚



æŸ¥çœ‹è¿è¡Œç»“æœï¼š

![image-20210716124147820](https://cdn.fengxianhub.top/resources-master/202205221133806.png)

å‘ç°è™½ç„¶ç»“æœéƒ½æ˜¯é€šè¿‡äº†ï¼Œä¸è¿‡éƒ¨åˆ†è¯·æ±‚å¾—åˆ°çš„å“åº”æ˜¯é™çº§è¿”å›çš„nullä¿¡æ¯ã€‚





### 3.2.3.æ€»ç»“

çº¿ç¨‹éš”ç¦»çš„ä¸¤ç§æ‰‹æ®µæ˜¯ï¼Ÿ

- ä¿¡å·é‡éš”ç¦»

- çº¿ç¨‹æ± éš”ç¦»

ä¿¡å·é‡éš”ç¦»çš„ç‰¹ç‚¹æ˜¯ï¼Ÿ

- åŸºäºè®¡æ•°å™¨æ¨¡å¼ï¼Œç®€å•ï¼Œå¼€é”€å°

çº¿ç¨‹æ± éš”ç¦»çš„ç‰¹ç‚¹æ˜¯ï¼Ÿ

- åŸºäºçº¿ç¨‹æ± æ¨¡å¼ï¼Œæœ‰é¢å¤–å¼€é”€ï¼Œä½†éš”ç¦»æ§åˆ¶æ›´å¼º





## 3.3.ç†”æ–­é™çº§

ç†”æ–­é™çº§æ˜¯è§£å†³é›ªå´©é—®é¢˜çš„é‡è¦æ‰‹æ®µã€‚å…¶æ€è·¯æ˜¯ç”±**æ–­è·¯å™¨**ç»Ÿè®¡æœåŠ¡è°ƒç”¨çš„å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥æœåŠ¡ã€‚å³æ‹¦æˆªè®¿é—®è¯¥æœåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ï¼›è€Œå½“æœåŠ¡æ¢å¤æ—¶ï¼Œæ–­è·¯å™¨ä¼šæ”¾è¡Œè®¿é—®è¯¥æœåŠ¡çš„è¯·æ±‚ã€‚

æ–­è·¯å™¨æ§åˆ¶ç†”æ–­å’Œæ”¾è¡Œæ˜¯é€šè¿‡çŠ¶æ€æœºæ¥å®Œæˆçš„ï¼š

![image-20210716130958518](https://cdn.fengxianhub.top/resources-master/202205221133042.png)

çŠ¶æ€æœºåŒ…æ‹¬ä¸‰ä¸ªçŠ¶æ€ï¼š

- closedï¼šå…³é—­çŠ¶æ€ï¼Œæ–­è·¯å™¨æ”¾è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å¼€å§‹ç»Ÿè®¡å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ã€‚è¶…è¿‡é˜ˆå€¼åˆ™åˆ‡æ¢åˆ°opençŠ¶æ€
- openï¼šæ‰“å¼€çŠ¶æ€ï¼ŒæœåŠ¡è°ƒç”¨è¢«**ç†”æ–­**ï¼Œè®¿é—®è¢«ç†”æ–­æœåŠ¡çš„è¯·æ±‚ä¼šè¢«æ‹’ç»ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œç›´æ¥èµ°é™çº§é€»è¾‘ã€‚OpençŠ¶æ€5ç§’åä¼šè¿›å…¥half-opençŠ¶æ€
- half-openï¼šåŠå¼€çŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚ï¼Œæ ¹æ®æ‰§è¡Œç»“æœæ¥åˆ¤æ–­æ¥ä¸‹æ¥çš„æ“ä½œã€‚
  - è¯·æ±‚æˆåŠŸï¼šåˆ™åˆ‡æ¢åˆ°closedçŠ¶æ€
  - è¯·æ±‚å¤±è´¥ï¼šåˆ™åˆ‡æ¢åˆ°opençŠ¶æ€



æ–­è·¯å™¨ç†”æ–­ç­–ç•¥æœ‰ä¸‰ç§ï¼šæ…¢è°ƒç”¨ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°



### 3.3.1.æ…¢è°ƒç”¨

**æ…¢è°ƒç”¨**ï¼šä¸šåŠ¡çš„å“åº”æ—¶é•¿ï¼ˆRTï¼‰å¤§äºæŒ‡å®šæ—¶é•¿çš„è¯·æ±‚è®¤å®šä¸ºæ…¢è°ƒç”¨è¯·æ±‚ã€‚åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡è®¾å®šçš„æœ€å°æ•°é‡ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºè®¾å®šçš„é˜ˆå€¼ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¾‹å¦‚ï¼š

![image-20210716145934347](https://cdn.fengxianhub.top/resources-master/202205221151508.png)

è§£è¯»ï¼šRTè¶…è¿‡500msçš„è°ƒç”¨æ˜¯æ…¢è°ƒç”¨ï¼Œç»Ÿè®¡æœ€è¿‘10000mså†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡10æ¬¡ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨æ¯”ä¾‹ä¸ä½äº0.5ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç†”æ–­æ—¶é•¿ä¸º5ç§’ã€‚ç„¶åè¿›å…¥half-opençŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚åšæµ‹è¯•ã€‚



**æ¡ˆä¾‹**

éœ€æ±‚ï¼šç»™ UserClientçš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œæ…¢è°ƒç”¨çš„RTé˜ˆå€¼ä¸º50msï¼Œç»Ÿè®¡æ—¶é—´ä¸º1ç§’ï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º5



#### 1ï¼‰è®¾ç½®æ…¢è°ƒç”¨

ä¿®æ”¹user-serviceä¸­çš„/user/{id}è¿™ä¸ªæ¥å£çš„ä¸šåŠ¡ã€‚é€šè¿‡ä¼‘çœ æ¨¡æ‹Ÿä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ï¼š

![image-20210716150234787](https://cdn.fengxianhub.top/resources-master/202205221151003.png)



æ­¤æ—¶ï¼ŒorderId=101çš„è®¢å•ï¼Œå…³è”çš„æ˜¯idä¸º1çš„ç”¨æˆ·ï¼Œè°ƒç”¨æ—¶é•¿ä¸º60msï¼š

![image-20210716150510956](https://cdn.fengxianhub.top/resources-master/202205221151007.png)

orderId=102çš„è®¢å•ï¼Œå…³è”çš„æ˜¯idä¸º2çš„ç”¨æˆ·ï¼Œè°ƒç”¨æ—¶é•¿ä¸ºéå¸¸çŸ­ï¼›

![image-20210716150605208](https://cdn.fengxianhub.top/resources-master/202205221151899.png)



#### 2ï¼‰è®¾ç½®ç†”æ–­è§„åˆ™

ä¸‹é¢ï¼Œç»™feignæ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼š

![image-20210716150654094](https://cdn.fengxianhub.top/resources-master/202205221151931.png)

è§„åˆ™ï¼š

![image-20210716150740434](https://cdn.fengxianhub.top/resources-master/202205221151526.png)

è¶…è¿‡50msçš„è¯·æ±‚éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯æ…¢è¯·æ±‚



#### 3ï¼‰æµ‹è¯•

åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8088/order/101ï¼Œå¿«é€Ÿåˆ·æ–°5æ¬¡ï¼Œå¯ä»¥å‘ç°ï¼š

![image-20210716150911004](https://cdn.fengxianhub.top/resources-master/202205221151949.png)

è§¦å‘äº†ç†”æ–­ï¼Œè¯·æ±‚æ—¶é•¿ç¼©çŸ­è‡³5msï¼Œå¿«é€Ÿå¤±è´¥äº†ï¼Œå¹¶ä¸”èµ°é™çº§é€»è¾‘ï¼Œè¿”å›çš„null



åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8088/order/102ï¼Œç«Ÿç„¶ä¹Ÿè¢«ç†”æ–­äº†ï¼š

![image-20210716151107785](https://cdn.fengxianhub.top/resources-master/202205221151658.png)





### 3.3.2.å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°

**å¼‚å¸¸æ¯”ä¾‹æˆ–å¼‚å¸¸æ•°**ï¼šç»Ÿè®¡æŒ‡å®šæ—¶é—´å†…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨æ¬¡æ•°è¶…è¿‡æŒ‡å®šè¯·æ±‚æ•°ï¼Œå¹¶ä¸”å‡ºç°å¼‚å¸¸çš„æ¯”ä¾‹è¾¾åˆ°è®¾å®šçš„æ¯”ä¾‹é˜ˆå€¼ï¼ˆæˆ–è¶…è¿‡æŒ‡å®šå¼‚å¸¸æ•°ï¼‰ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ªå¼‚å¸¸æ¯”ä¾‹è®¾ç½®ï¼š

![image-20210716131430682](https://cdn.fengxianhub.top/resources-master/202205251752522.png)

è§£è¯»ï¼šç»Ÿè®¡æœ€è¿‘1000mså†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡10æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº0.4ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¸€ä¸ªå¼‚å¸¸æ•°è®¾ç½®ï¼š

![image-20210716131522912](https://cdn.fengxianhub.top/resources-master/202205251752519.png)

è§£è¯»ï¼šç»Ÿè®¡æœ€è¿‘1000mså†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡10æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº2æ¬¡ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚



**æ¡ˆä¾‹**

éœ€æ±‚ï¼šç»™ UserClientçš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œç»Ÿè®¡æ—¶é—´ä¸º1ç§’ï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º5s



#### 1ï¼‰è®¾ç½®å¼‚å¸¸è¯·æ±‚

é¦–å…ˆï¼Œä¿®æ”¹user-serviceä¸­çš„/user/{id}è¿™ä¸ªæ¥å£çš„ä¸šåŠ¡ã€‚æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œä»¥è§¦å‘å¼‚å¸¸æ¯”ä¾‹çš„ç†”æ–­ï¼š

![image-20210716151348183](https://cdn.fengxianhub.top/resources-master/202205251752524.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œid ä¸º 2æ—¶ï¼Œå°±ä¼šè§¦å‘å¼‚å¸¸



#### 2ï¼‰è®¾ç½®ç†”æ–­è§„åˆ™

ä¸‹é¢ï¼Œç»™feignæ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼š

![image-20210716150654094](https://cdn.fengxianhub.top/resources-master/202205251752541.png)

è§„åˆ™ï¼š

![image-20210716151538785](https://cdn.fengxianhub.top/resources-master/202205251752546.png)

åœ¨5æ¬¡è¯·æ±‚ä¸­ï¼Œåªè¦å¼‚å¸¸æ¯”ä¾‹è¶…è¿‡0.4ï¼Œä¹Ÿå°±æ˜¯æœ‰2æ¬¡ä»¥ä¸Šçš„å¼‚å¸¸ï¼Œå°±ä¼šè§¦å‘ç†”æ–­ã€‚



####  3ï¼‰æµ‹è¯•

åœ¨æµè§ˆå™¨å¿«é€Ÿè®¿é—®ï¼šhttp://localhost:8088/order/102ï¼Œå¿«é€Ÿåˆ·æ–°5æ¬¡ï¼Œè§¦å‘ç†”æ–­ï¼š

![image-20210716151722916](https://cdn.fengxianhub.top/resources-master/202205251752563.png)



æ­¤æ—¶ï¼Œæˆ‘ä»¬å»è®¿é—®æœ¬æ¥åº”è¯¥æ­£å¸¸çš„103ï¼š

![image-20210716151844817](https://cdn.fengxianhub.top/resources-master/202205251752248.png)





# 4.æˆæƒè§„åˆ™

æˆæƒè§„åˆ™å¯ä»¥å¯¹è¯·æ±‚æ–¹æ¥æºåšåˆ¤æ–­å’Œæ§åˆ¶ã€‚

## 4.1.æˆæƒè§„åˆ™

### 4.1.1.åŸºæœ¬è§„åˆ™

æˆæƒè§„åˆ™å¯ä»¥å¯¹è°ƒç”¨æ–¹çš„æ¥æºåšæ§åˆ¶ï¼Œæœ‰ç™½åå•å’Œé»‘åå•ä¸¤ç§æ–¹å¼ã€‚

- ç™½åå•ï¼šæ¥æºï¼ˆoriginï¼‰åœ¨ç™½åå•å†…çš„è°ƒç”¨è€…å…è®¸è®¿é—®

- é»‘åå•ï¼šæ¥æºï¼ˆoriginï¼‰åœ¨é»‘åå•å†…çš„è°ƒç”¨è€…ä¸å…è®¸è®¿é—®

ç‚¹å‡»å·¦ä¾§èœå•çš„æˆæƒï¼Œå¯ä»¥çœ‹åˆ°æˆæƒè§„åˆ™ï¼š

![image-20210716152010750](https://cdn.fengxianhub.top/resources-master/202205221451030.png)

- èµ„æºåï¼šå°±æ˜¯å—ä¿æŠ¤çš„èµ„æºï¼Œä¾‹å¦‚/order/{orderId}

- æµæ§åº”ç”¨ï¼šæ˜¯æ¥æºè€…çš„åå•ï¼Œ
  - å¦‚æœæ˜¯å‹¾é€‰ç™½åå•ï¼Œåˆ™åå•ä¸­çš„æ¥æºè¢«è®¸å¯è®¿é—®ã€‚
  - å¦‚æœæ˜¯å‹¾é€‰é»‘åå•ï¼Œåˆ™åå•ä¸­çš„æ¥æºè¢«ç¦æ­¢è®¿é—®ã€‚

æ¯”å¦‚ï¼š

![image-20210716152349191](https://cdn.fengxianhub.top/resources-master/202205221451000.png)

æˆ‘ä»¬å…è®¸è¯·æ±‚ä»gatewayåˆ°order-serviceï¼Œä¸å…è®¸æµè§ˆå™¨è®¿é—®order-serviceï¼Œé‚£ä¹ˆç™½åå•ä¸­å°±è¦å¡«å†™**ç½‘å…³çš„æ¥æºåç§°ï¼ˆoriginï¼‰**ã€‚

### 4.1.2.å¦‚ä½•è·å–origin

Sentinelæ˜¯é€šè¿‡RequestOriginParserè¿™ä¸ªæ¥å£çš„parseOriginæ¥è·å–è¯·æ±‚çš„æ¥æºçš„ã€‚

```java
public interface RequestOriginParser {
    /**
     * ä»è¯·æ±‚requestå¯¹è±¡ä¸­è·å–originï¼Œè·å–æ–¹å¼è‡ªå®šä¹‰
     */
    String parseOrigin(HttpServletRequest request);
}
```

è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯ä»requestå¯¹è±¡ä¸­ï¼Œè·å–è¯·æ±‚è€…çš„originå€¼å¹¶è¿”å›ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œsentinelä¸ç®¡è¯·æ±‚è€…ä»å“ªé‡Œæ¥ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯defaultï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€åˆ‡è¯·æ±‚çš„æ¥æºéƒ½è¢«è®¤ä¸ºæ˜¯ä¸€æ ·çš„å€¼defaultã€‚



å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰è¿™ä¸ªæ¥å£çš„å®ç°ï¼Œè®©**ä¸åŒçš„è¯·æ±‚ï¼Œè¿”å›ä¸åŒçš„origin**ã€‚



ä¾‹å¦‚order-serviceæœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªRequestOriginParserçš„å®ç°ç±»ï¼š

```java
package cn.itcast.order.sentinel;

import com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import javax.servlet.http.HttpServletRequest;

@Component
public class HeaderOriginParser implements RequestOriginParser {
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // 1.è·å–è¯·æ±‚å¤´
        String origin = request.getHeader("origin");
        // 2.éç©ºåˆ¤æ–­
        if (StringUtils.isEmpty(origin)) {
            origin = "blank";
        }
        return origin;
    }
}
```

æˆ‘ä»¬ä¼šå°è¯•ä»request-headerä¸­è·å–originå€¼ã€‚



### 4.1.3.ç»™ç½‘å…³æ·»åŠ è¯·æ±‚å¤´

æ—¢ç„¶è·å–è¯·æ±‚originçš„æ–¹å¼æ˜¯ä»reques-headerä¸­è·å–originå€¼ï¼Œæˆ‘ä»¬å¿…é¡»è®©**æ‰€æœ‰ä»gatewayè·¯ç”±åˆ°å¾®æœåŠ¡çš„è¯·æ±‚éƒ½å¸¦ä¸Šoriginå¤´**ã€‚

è¿™ä¸ªéœ€è¦åˆ©ç”¨ä¹‹å‰å­¦ä¹ çš„ä¸€ä¸ªGatewayFilteræ¥å®ç°ï¼ŒAddRequestHeaderGatewayFilterã€‚

ä¿®æ”¹gatewayæœåŠ¡ä¸­çš„application.ymlï¼Œæ·»åŠ ä¸€ä¸ªdefaultFilterï¼š

```yaml
spring:
  cloud:
    gateway:
      default-filters:
        - AddRequestHeader=origin,gateway
      routes:
       # ...ç•¥
```

è¿™æ ·ï¼Œä»gatewayè·¯ç”±çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¸¦ä¸Šoriginå¤´ï¼Œå€¼ä¸ºgatewayã€‚è€Œä»å…¶å®ƒåœ°æ–¹åˆ°è¾¾å¾®æœåŠ¡çš„è¯·æ±‚åˆ™æ²¡æœ‰è¿™ä¸ªå¤´ã€‚



### 4.1.4.é…ç½®æˆæƒè§„åˆ™

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæˆæƒè§„åˆ™ï¼Œæ”¾è¡Œoriginå€¼ä¸ºgatewayçš„è¯·æ±‚ã€‚

![image-20210716153250134](https://cdn.fengxianhub.top/resources-master/202205221451904.png)

é…ç½®å¦‚ä¸‹ï¼š

![image-20210716153301069](https://cdn.fengxianhub.top/resources-master/202205221451010.png)

ç°åœ¨ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ç½‘å…³ï¼Œè®¿é—®order-serviceæœåŠ¡ï¼š

![image-20210716153348396](https://cdn.fengxianhub.top/resources-master/202205221451106.png)

é€šè¿‡ç½‘å…³è®¿é—®ï¼š

![image-20210716153434095](https://cdn.fengxianhub.top/resources-master/202205221451521.png)







## 4.2.è‡ªå®šä¹‰å¼‚å¸¸ç»“æœ

é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ç”Ÿé™æµã€é™çº§ã€æˆæƒæ‹¦æˆªæ—¶ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸åˆ°è°ƒç”¨æ–¹ã€‚å¼‚å¸¸ç»“æœéƒ½æ˜¯flow limmitingï¼ˆé™æµï¼‰ã€‚è¿™æ ·ä¸å¤Ÿå‹å¥½ï¼Œæ— æ³•å¾—çŸ¥æ˜¯é™æµè¿˜æ˜¯é™çº§è¿˜æ˜¯æˆæƒæ‹¦æˆªã€‚



### 4.2.1.å¼‚å¸¸ç±»å‹



è€Œå¦‚æœè¦è‡ªå®šä¹‰å¼‚å¸¸æ—¶çš„è¿”å›ç»“æœï¼Œéœ€è¦å®ç°BlockExceptionHandleræ¥å£ï¼š

```java
public interface BlockExceptionHandler {
    /**
     * å¤„ç†è¯·æ±‚è¢«é™æµã€é™çº§ã€æˆæƒæ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸ï¼šBlockException
     */
    void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception;
}
```

è¿™ä¸ªæ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š

- HttpServletRequest requestï¼šrequestå¯¹è±¡
- HttpServletResponse responseï¼šresponseå¯¹è±¡
- BlockException eï¼šè¢«sentinelæ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸

è¿™é‡Œçš„BlockExceptionåŒ…å«å¤šä¸ªä¸åŒçš„å­ç±»ï¼š

| **å¼‚å¸¸**             | **è¯´æ˜**           |
| -------------------- | ------------------ |
| FlowException        | é™æµå¼‚å¸¸           |
| ParamFlowException   | çƒ­ç‚¹å‚æ•°é™æµçš„å¼‚å¸¸ |
| DegradeException     | é™çº§å¼‚å¸¸           |
| AuthorityException   | æˆæƒè§„åˆ™å¼‚å¸¸       |
| SystemBlockException | ç³»ç»Ÿè§„åˆ™å¼‚å¸¸       |



### 4.2.2.è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±åœ¨order-serviceå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ç±»ï¼š

```java
package cn.itcast.order.sentinel;

import com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;
import com.alibaba.csp.sentinel.slots.block.flow.FlowException;
import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
public class SentinelExceptionHandler implements BlockExceptionHandler {
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception {
        String msg = "æœªçŸ¥å¼‚å¸¸";
        int status = 429;

        if (e instanceof FlowException) {
            msg = "è¯·æ±‚è¢«é™æµäº†";
        } else if (e instanceof ParamFlowException) {
            msg = "è¯·æ±‚è¢«çƒ­ç‚¹å‚æ•°é™æµ";
        } else if (e instanceof DegradeException) {
            msg = "è¯·æ±‚è¢«é™çº§äº†";
        } else if (e instanceof AuthorityException) {
            msg = "æ²¡æœ‰æƒé™è®¿é—®";
            status = 401;
        }

        response.setContentType("application/json;charset=utf-8");
        response.setStatus(status);
        response.getWriter().println("{\"msg\": " + msg + ", \"status\": " + status + "}");
    }
}
```



é‡å¯æµ‹è¯•ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œä¼šè¿”å›ä¸åŒçš„å¼‚å¸¸æ¶ˆæ¯.

é™æµï¼š

![image-20210716153938887](https://cdn.fengxianhub.top/resources-master/202205221452387.png)

æˆæƒæ‹¦æˆªæ—¶ï¼š

![image-20210716154012736](https://cdn.fengxianhub.top/resources-master/202205221452272.png)





# 5.è§„åˆ™æŒä¹…åŒ–

ç°åœ¨ï¼Œsentinelçš„æ‰€æœ‰è§„åˆ™éƒ½æ˜¯å†…å­˜å­˜å‚¨ï¼Œé‡å¯åæ‰€æœ‰è§„åˆ™éƒ½ä¼šä¸¢å¤±ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿è¿™äº›è§„åˆ™çš„æŒä¹…åŒ–ï¼Œé¿å…ä¸¢å¤±ã€‚

## 5.1.è§„åˆ™ç®¡ç†æ¨¡å¼

è§„åˆ™æ˜¯å¦èƒ½æŒä¹…åŒ–ï¼Œå–å†³äºè§„åˆ™ç®¡ç†æ¨¡å¼ï¼Œsentinelæ”¯æŒä¸‰ç§è§„åˆ™ç®¡ç†æ¨¡å¼ï¼š

- åŸå§‹æ¨¡å¼ï¼šSentinelçš„é»˜è®¤æ¨¡å¼ï¼Œå°†è§„åˆ™ä¿å­˜åœ¨å†…å­˜ï¼Œé‡å¯æœåŠ¡ä¼šä¸¢å¤±ã€‚
- pullæ¨¡å¼
- pushæ¨¡å¼



### 5.1.1.pullæ¨¡å¼

pullæ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®çš„è§„åˆ™æ¨é€åˆ°Sentinelå®¢æˆ·ç«¯ï¼Œè€Œå®¢æˆ·ç«¯ä¼šå°†é…ç½®è§„åˆ™ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ã€‚ä»¥åä¼šå®šæ—¶å»æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œæ›´æ–°æœ¬åœ°è§„åˆ™ã€‚

![image-20210716154155238](https://cdn.fengxianhub.top/resources-master/202205221452300.png)



### 5.1.2.pushæ¨¡å¼

pushæ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®è§„åˆ™æ¨é€åˆ°è¿œç¨‹é…ç½®ä¸­å¿ƒï¼Œä¾‹å¦‚Nacosã€‚Sentinelå®¢æˆ·ç«¯ç›‘å¬Nacosï¼Œè·å–é…ç½®å˜æ›´çš„æ¨é€æ¶ˆæ¯ï¼Œå®Œæˆæœ¬åœ°é…ç½®æ›´æ–°ã€‚

![image-20210716154215456](https://cdn.fengxianhub.top/resources-master/202205221452732.png)







## 5.2.å®ç°pushæ¨¡å¼

è¯¦ç»†æ­¥éª¤å¯ä»¥å‚è€ƒè¯¾å‰èµ„æ–™çš„ã€Šsentinelè§„åˆ™æŒä¹…åŒ–ã€‹ï¼š

![image-20210716154255466](https://cdn.fengxianhub.top/resources-master/202205221452245.png)
