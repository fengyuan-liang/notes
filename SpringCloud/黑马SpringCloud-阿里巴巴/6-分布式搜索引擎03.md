# åˆ†å¸ƒå¼æœç´¢å¼•æ“03

ç¬”è®°æ˜¯é»‘é©¬æè€å¸ˆCloudè¯¾çš„ç¬”è®°ï¼Œé»‘é©¬çš„è§†é¢‘è®²çš„çœŸçš„å¤ªæ£’äº†ï¼ï¼ä¸å¾—ä¸æ„Ÿæ…¨ä¸€å¥ï¼š0åŸºç¡€ã€å­¦IT ... ğŸ˜˜ğŸ˜˜ğŸ˜˜ğŸ˜˜

[è§†é¢‘åœ°å€](https://www.bilibili.com/video/BV1LQ4y127n4?p=158&spm_id_from=pageDriver)ï¼šhttps://www.bilibili.com/video/BV1LQ4y127n4?p=158&spm_id_from=pageDriver

æˆ‘è‡ªå·±åšçš„æ€ç»´å¯¼å›¾ï¼š

![image-20220525172650853](https://cdn.fengxianhub.top/resources-master/202205251726979.png)

# 1.æ•°æ®èšåˆ

**[èšåˆï¼ˆ](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)[aggregations](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)[ï¼‰](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)**å¯ä»¥è®©æˆ‘ä»¬æå…¶æ–¹ä¾¿çš„å®ç°å¯¹æ•°æ®çš„ç»Ÿè®¡ã€åˆ†æã€è¿ç®—ã€‚ä¾‹å¦‚ï¼š

- ä»€ä¹ˆå“ç‰Œçš„æ‰‹æœºæœ€å—æ¬¢è¿ï¼Ÿ
- è¿™äº›æ‰‹æœºçš„å¹³å‡ä»·æ ¼ã€æœ€é«˜ä»·æ ¼ã€æœ€ä½ä»·æ ¼ï¼Ÿ
- è¿™äº›æ‰‹æœºæ¯æœˆçš„é”€å”®æƒ…å†µå¦‚ä½•ï¼Ÿ

å®ç°è¿™äº›ç»Ÿè®¡åŠŸèƒ½çš„æ¯”æ•°æ®åº“çš„sqlè¦æ–¹ä¾¿çš„å¤šï¼Œè€Œä¸”æŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼Œå¯ä»¥å®ç°è¿‘å®æ—¶æœç´¢æ•ˆæœã€‚

## 1.1.èšåˆçš„ç§ç±»

èšåˆå¸¸è§çš„æœ‰ä¸‰ç±»ï¼š

- **æ¡¶ï¼ˆBucketï¼‰**èšåˆï¼šç”¨æ¥å¯¹æ–‡æ¡£åšåˆ†ç»„
  - TermAggregationï¼šæŒ‰ç…§æ–‡æ¡£å­—æ®µå€¼åˆ†ç»„ï¼Œä¾‹å¦‚æŒ‰ç…§å“ç‰Œå€¼åˆ†ç»„ã€æŒ‰ç…§å›½å®¶åˆ†ç»„
  - Date Histogramï¼šæŒ‰ç…§æ—¥æœŸé˜¶æ¢¯åˆ†ç»„ï¼Œä¾‹å¦‚ä¸€å‘¨ä¸ºä¸€ç»„ï¼Œæˆ–è€…ä¸€æœˆä¸ºä¸€ç»„

- **åº¦é‡ï¼ˆMetricï¼‰**èšåˆï¼šç”¨ä»¥è®¡ç®—ä¸€äº›å€¼ï¼Œæ¯”å¦‚ï¼šæœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰
  - Avgï¼šæ±‚å¹³å‡å€¼
  - Maxï¼šæ±‚æœ€å¤§å€¼
  - Minï¼šæ±‚æœ€å°å€¼
  - Statsï¼šåŒæ—¶æ±‚maxã€minã€avgã€sumç­‰
- **ç®¡é“ï¼ˆpipelineï¼‰**èšåˆï¼šå…¶å®ƒèšåˆçš„ç»“æœä¸ºåŸºç¡€åšèšåˆ



> **æ³¨æ„ï¼š**å‚åŠ èšåˆçš„å­—æ®µå¿…é¡»æ˜¯keywordã€æ—¥æœŸã€æ•°å€¼ã€å¸ƒå°”ç±»å‹





## 1.2.DSLå®ç°èšåˆ

ç°åœ¨ï¼Œæˆ‘ä»¬è¦ç»Ÿè®¡æ‰€æœ‰æ•°æ®ä¸­çš„é…’åº—å“ç‰Œæœ‰å‡ ç§ï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§å“ç‰Œå¯¹æ•°æ®åˆ†ç»„ã€‚æ­¤æ—¶å¯ä»¥æ ¹æ®é…’åº—å“ç‰Œçš„åç§°åšèšåˆï¼Œä¹Ÿå°±æ˜¯Bucketèšåˆã€‚

### 1.2.1.Bucketèšåˆè¯­æ³•

è¯­æ³•å¦‚ä¸‹ï¼š

```json
GETÂ /hotel/_search
{
Â Â "size":Â 0,Â Â //Â è®¾ç½®sizeä¸º0ï¼Œç»“æœä¸­ä¸åŒ…å«æ–‡æ¡£ï¼ŒåªåŒ…å«èšåˆç»“æœ
Â Â "aggs":Â {Â //Â å®šä¹‰èšåˆ
Â Â Â Â "brandAgg":Â {Â //ç»™èšåˆèµ·ä¸ªåå­—
Â Â Â Â Â Â "terms":Â {Â //Â èšåˆçš„ç±»å‹ï¼ŒæŒ‰ç…§å“ç‰Œå€¼èšåˆï¼Œæ‰€ä»¥é€‰æ‹©term
Â Â Â Â Â Â Â Â "field":Â "brand",Â //Â å‚ä¸èšåˆçš„å­—æ®µ
Â Â Â Â Â Â Â Â "size":Â 20Â //Â å¸Œæœ›è·å–çš„èšåˆç»“æœæ•°é‡
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```

ç»“æœå¦‚å›¾ï¼š

![image-20210723171948228](https://cdn.fengxianhub.top/resources-master/202205211112948.png)



### 1.2.2.èšåˆç»“æœæ’åº

é»˜è®¤æƒ…å†µä¸‹ï¼ŒBucketèšåˆä¼šç»Ÿè®¡Bucketå†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º_countï¼Œå¹¶ä¸”æŒ‰ç…§_counté™åºæ’åºã€‚

æˆ‘ä»¬å¯ä»¥æŒ‡å®šorderå±æ€§ï¼Œè‡ªå®šä¹‰èšåˆçš„æ’åºæ–¹å¼ï¼š

```json
GETÂ /hotel/_search
{
Â Â "size":Â 0,Â 
Â Â "aggs":Â {
Â Â Â Â "brandAgg":Â {
Â Â Â Â Â Â "terms":Â {
Â Â Â Â Â Â Â Â "field":Â "brand",
Â Â Â Â Â Â Â Â "order":Â {
Â Â Â Â Â Â Â Â Â Â "_count":Â "asc" //Â æŒ‰ç…§_countå‡åºæ’åˆ—
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â "size":Â 20
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```



### 1.2.3.é™å®šèšåˆèŒƒå›´

é»˜è®¤æƒ…å†µä¸‹ï¼ŒBucketèšåˆæ˜¯å¯¹ç´¢å¼•åº“çš„æ‰€æœ‰æ–‡æ¡£åšèšåˆï¼Œä½†çœŸå®åœºæ™¯ä¸‹ï¼Œç”¨æˆ·ä¼šè¾“å…¥æœç´¢æ¡ä»¶ï¼Œå› æ­¤èšåˆå¿…é¡»æ˜¯å¯¹æœç´¢ç»“æœèšåˆã€‚é‚£ä¹ˆèšåˆå¿…é¡»æ·»åŠ é™å®šæ¡ä»¶ã€‚

æˆ‘ä»¬å¯ä»¥é™å®šè¦èšåˆçš„æ–‡æ¡£èŒƒå›´ï¼Œåªè¦æ·»åŠ queryæ¡ä»¶å³å¯ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "range":Â {
Â Â Â Â Â Â "price":Â {
Â Â Â Â Â Â Â Â "lte":Â 200 // åªå¯¹200å…ƒä»¥ä¸‹çš„æ–‡æ¡£èšåˆ
Â Â Â Â Â Â }
Â Â Â Â }
Â Â },Â 
Â Â "size":Â 0,Â 
Â Â "aggs":Â {
Â Â Â Â "brandAgg":Â {
Â Â Â Â Â Â "terms":Â {
Â Â Â Â Â Â Â Â "field":Â "brand",
Â Â Â Â Â Â Â Â "size":Â 20
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```



è¿™æ¬¡ï¼Œèšåˆå¾—åˆ°çš„å“ç‰Œæ˜æ˜¾å˜å°‘äº†ï¼š

![image-20210723172404836](https://cdn.fengxianhub.top/resources-master/202205211112379.png)



### 1.2.4.Metricèšåˆè¯­æ³•

ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬å¯¹é…’åº—æŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œå½¢æˆäº†ä¸€ä¸ªä¸ªæ¡¶ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹æ¡¶å†…çš„é…’åº—åšè¿ç®—ï¼Œè·å–æ¯ä¸ªå“ç‰Œçš„ç”¨æˆ·è¯„åˆ†çš„minã€maxã€avgç­‰å€¼ã€‚

è¿™å°±è¦ç”¨åˆ°Metricèšåˆäº†ï¼Œä¾‹å¦‚statèšåˆï¼šå°±å¯ä»¥è·å–minã€maxã€avgç­‰ç»“æœã€‚

è¯­æ³•å¦‚ä¸‹ï¼š

```json
GETÂ /hotel/_search
{
Â Â "size":Â 0,Â 
Â Â "aggs":Â {
Â Â Â Â "brandAgg":Â {Â 
Â Â Â Â Â Â "terms":Â {Â 
Â Â Â Â Â Â Â Â "field":Â "brand",Â 
Â Â Â Â Â Â Â Â "size":Â 20
Â Â Â Â Â Â },
Â Â Â Â Â Â "aggs":Â {Â //Â æ˜¯brandsèšåˆçš„å­èšåˆï¼Œä¹Ÿå°±æ˜¯åˆ†ç»„åå¯¹æ¯ç»„åˆ†åˆ«è®¡ç®—
Â Â Â Â Â Â Â Â "score_stats":Â {Â //Â èšåˆåç§°
Â Â Â Â Â Â Â Â Â Â "stats":Â {Â //Â èšåˆç±»å‹ï¼Œè¿™é‡Œstatså¯ä»¥è®¡ç®—minã€maxã€avgç­‰
Â Â Â Â Â Â Â Â Â Â Â Â "field":Â "score"Â //Â èšåˆå­—æ®µï¼Œè¿™é‡Œæ˜¯score
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```



è¿™æ¬¡çš„score_statsèšåˆæ˜¯åœ¨brandAggçš„èšåˆå†…éƒ¨åµŒå¥—çš„å­èšåˆã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªæ¡¶åˆ†åˆ«è®¡ç®—ã€‚



å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»™èšåˆç»“æœåšä¸ªæ’åºï¼Œä¾‹å¦‚æŒ‰ç…§æ¯ä¸ªæ¡¶çš„é…’åº—å¹³å‡åˆ†åšæ’åºï¼š

![image-20210723172917636](https://cdn.fengxianhub.top/resources-master/202205211112853.png)





### 1.2.5.å°ç»“

aggsä»£è¡¨èšåˆï¼Œä¸queryåŒçº§ï¼Œæ­¤æ—¶queryçš„ä½œç”¨æ˜¯ï¼Ÿ

- é™å®šèšåˆçš„çš„æ–‡æ¡£èŒƒå›´

èšåˆå¿…é¡»çš„ä¸‰è¦ç´ ï¼š

- èšåˆåç§°
- èšåˆç±»å‹
- èšåˆå­—æ®µ

èšåˆå¯é…ç½®å±æ€§æœ‰ï¼š

- sizeï¼šæŒ‡å®šèšåˆç»“æœæ•°é‡
- orderï¼šæŒ‡å®šèšåˆç»“æœæ’åºæ–¹å¼
- fieldï¼šæŒ‡å®šèšåˆå­—æ®µ



## 1.3.RestAPIå®ç°èšåˆ

### 1.3.1.APIè¯­æ³•

èšåˆæ¡ä»¶ä¸queryæ¡ä»¶åŒçº§åˆ«ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨request.source()æ¥æŒ‡å®šèšåˆæ¡ä»¶ã€‚

èšåˆæ¡ä»¶çš„è¯­æ³•ï¼š

![image-20210723173057733](https://cdn.fengxianhub.top/resources-master/202205211112239.png)



èšåˆçš„ç»“æœä¹Ÿä¸æŸ¥è¯¢ç»“æœä¸åŒï¼ŒAPIä¹Ÿæ¯”è¾ƒç‰¹æ®Šã€‚ä¸è¿‡åŒæ ·æ˜¯JSONé€å±‚è§£æï¼š

![image-20210723173215728](https://cdn.fengxianhub.top/resources-master/202205211112110.png)



### 1.3.2.ä¸šåŠ¡éœ€æ±‚

éœ€æ±‚ï¼šæœç´¢é¡µé¢çš„å“ç‰Œã€åŸå¸‚ç­‰ä¿¡æ¯ä¸åº”è¯¥æ˜¯åœ¨é¡µé¢å†™æ­»ï¼Œè€Œæ˜¯é€šè¿‡èšåˆç´¢å¼•åº“ä¸­çš„é…’åº—æ•°æ®å¾—æ¥çš„ï¼š

![image-20210723192605566](https://cdn.fengxianhub.top/resources-master/202205211112557.png)



åˆ†æï¼š

ç›®å‰ï¼Œé¡µé¢çš„åŸå¸‚åˆ—è¡¨ã€æ˜Ÿçº§åˆ—è¡¨ã€å“ç‰Œåˆ—è¡¨éƒ½æ˜¯å†™æ­»çš„ï¼Œå¹¶ä¸ä¼šéšç€æœç´¢ç»“æœçš„å˜åŒ–è€Œå˜åŒ–ã€‚ä½†æ˜¯ç”¨æˆ·æœç´¢æ¡ä»¶æ”¹å˜æ—¶ï¼Œæœç´¢ç»“æœä¼šè·Ÿç€å˜åŒ–ã€‚

ä¾‹å¦‚ï¼šç”¨æˆ·æœç´¢â€œä¸œæ–¹æ˜ç â€ï¼Œé‚£æœç´¢çš„é…’åº—è‚¯å®šæ˜¯åœ¨ä¸Šæµ·ä¸œæ–¹æ˜ç é™„è¿‘ï¼Œå› æ­¤ï¼ŒåŸå¸‚åªèƒ½æ˜¯ä¸Šæµ·ï¼Œæ­¤æ—¶åŸå¸‚åˆ—è¡¨ä¸­å°±ä¸åº”è¯¥æ˜¾ç¤ºåŒ—äº¬ã€æ·±åœ³ã€æ­å·è¿™äº›ä¿¡æ¯äº†ã€‚



ä¹Ÿå°±æ˜¯è¯´ï¼Œæœç´¢ç»“æœä¸­åŒ…å«å“ªäº›åŸå¸‚ï¼Œé¡µé¢å°±åº”è¯¥åˆ—å‡ºå“ªäº›åŸå¸‚ï¼›æœç´¢ç»“æœä¸­åŒ…å«å“ªäº›å“ç‰Œï¼Œé¡µé¢å°±åº”è¯¥åˆ—å‡ºå“ªäº›å“ç‰Œã€‚

å¦‚ä½•å¾—çŸ¥æœç´¢ç»“æœä¸­åŒ…å«å“ªäº›å“ç‰Œï¼Ÿå¦‚ä½•å¾—çŸ¥æœç´¢ç»“æœä¸­åŒ…å«å“ªäº›åŸå¸‚ï¼Ÿ



ä½¿ç”¨èšåˆåŠŸèƒ½ï¼Œåˆ©ç”¨Bucketèšåˆï¼Œå¯¹æœç´¢ç»“æœä¸­çš„æ–‡æ¡£åŸºäºå“ç‰Œåˆ†ç»„ã€åŸºäºåŸå¸‚åˆ†ç»„ï¼Œå°±èƒ½å¾—çŸ¥åŒ…å«å“ªäº›å“ç‰Œã€å“ªäº›åŸå¸‚äº†ã€‚

å› ä¸ºæ˜¯å¯¹æœç´¢ç»“æœèšåˆï¼Œå› æ­¤èšåˆæ˜¯**é™å®šèŒƒå›´çš„èšåˆ**ï¼Œä¹Ÿå°±æ˜¯è¯´èšåˆçš„é™å®šæ¡ä»¶è·Ÿæœç´¢æ–‡æ¡£çš„æ¡ä»¶ä¸€è‡´ã€‚



æŸ¥çœ‹æµè§ˆå™¨å¯ä»¥å‘ç°ï¼Œå‰ç«¯å…¶å®å·²ç»å‘å‡ºäº†è¿™æ ·çš„ä¸€ä¸ªè¯·æ±‚ï¼š

![image-20210723193730799](https://cdn.fengxianhub.top/resources-master/202205211119855.png)

è¯·æ±‚**å‚æ•°ä¸æœç´¢æ–‡æ¡£çš„å‚æ•°å®Œå…¨ä¸€è‡´**ã€‚



è¿”å›å€¼ç±»å‹å°±æ˜¯é¡µé¢è¦å±•ç¤ºçš„æœ€ç»ˆç»“æœï¼š

![image-20210723203915982](https://cdn.fengxianhub.top/resources-master/202205211119970.png)

ç»“æœæ˜¯ä¸€ä¸ªMapç»“æ„ï¼š

- keyæ˜¯å­—ç¬¦ä¸²ï¼ŒåŸå¸‚ã€æ˜Ÿçº§ã€å“ç‰Œã€ä»·æ ¼
- valueæ˜¯é›†åˆï¼Œä¾‹å¦‚å¤šä¸ªåŸå¸‚çš„åç§°



### 1.3.3.ä¸šåŠ¡å®ç°

åœ¨`cn.itcast.hotel.web`åŒ…çš„`HotelController`ä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œéµå¾ªä¸‹é¢çš„è¦æ±‚ï¼š

- è¯·æ±‚æ–¹å¼ï¼š`POST`
- è¯·æ±‚è·¯å¾„ï¼š`/hotel/filters`
- è¯·æ±‚å‚æ•°ï¼š`RequestParams`ï¼Œä¸æœç´¢æ–‡æ¡£çš„å‚æ•°ä¸€è‡´
- è¿”å›å€¼ç±»å‹ï¼š`Map<String, List<String>>`

ä»£ç ï¼š

```java
    @PostMapping("filters")
    public Map<String, List<String>> getFilters(@RequestBody RequestParams params){
        return hotelService.getFilters(params);
    }
```



è¿™é‡Œè°ƒç”¨äº†IHotelServiceä¸­çš„getFiltersæ–¹æ³•ï¼Œå°šæœªå®ç°ã€‚

åœ¨`cn.itcast.hotel.service.IHotelService`ä¸­å®šä¹‰æ–°æ–¹æ³•ï¼š

```java
Map<String, List<String>> filters(RequestParams params);
```



åœ¨`cn.itcast.hotel.service.impl.HotelService`ä¸­å®ç°è¯¥æ–¹æ³•ï¼š

```java
@Override
public Map<String, List<String>> filters(RequestParams params) {
    try {
        // 1.å‡†å¤‡Request
        SearchRequest request = new SearchRequest("hotel");
        // 2.å‡†å¤‡DSL
        // 2.1.query
        buildBasicQuery(params, request);
        // 2.2.è®¾ç½®size
        request.source().size(0);
        // 2.3.èšåˆ
        buildAggregation(request);
        // 3.å‘å‡ºè¯·æ±‚
        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        // 4.è§£æç»“æœ
        Map<String, List<String>> result = new HashMap<>();
        Aggregations aggregations = response.getAggregations();
        // 4.1.æ ¹æ®å“ç‰Œåç§°ï¼Œè·å–å“ç‰Œç»“æœ
        List<String> brandList = getAggByName(aggregations, "brandAgg");
        result.put("å“ç‰Œ", brandList);
        // 4.2.æ ¹æ®å“ç‰Œåç§°ï¼Œè·å–å“ç‰Œç»“æœ
        List<String> cityList = getAggByName(aggregations, "cityAgg");
        result.put("åŸå¸‚", cityList);
        // 4.3.æ ¹æ®å“ç‰Œåç§°ï¼Œè·å–å“ç‰Œç»“æœ
        List<String> starList = getAggByName(aggregations, "starAgg");
        result.put("æ˜Ÿçº§", starList);

        return result;
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}

private void buildAggregation(SearchRequest request) {
    request.source().aggregation(AggregationBuilders
                                 .terms("brandAgg")
                                 .field("brand")
                                 .size(100)
                                );
    request.source().aggregation(AggregationBuilders
                                 .terms("cityAgg")
                                 .field("city")
                                 .size(100)
                                );
    request.source().aggregation(AggregationBuilders
                                 .terms("starAgg")
                                 .field("starName")
                                 .size(100)
                                );
}

private List<String> getAggByName(Aggregations aggregations, String aggName) {
    // 4.1.æ ¹æ®èšåˆåç§°è·å–èšåˆç»“æœ
    Terms brandTerms = aggregations.get(aggName);
    // 4.2.è·å–buckets
    List<? extends Terms.Bucket> buckets = brandTerms.getBuckets();
    // 4.3.éå†
    List<String> brandList = new ArrayList<>();
    for (Terms.Bucket bucket : buckets) {
        // 4.4.è·å–key
        String key = bucket.getKeyAsString();
        brandList.add(key);
    }
    return brandList;
}
```







# 2.è‡ªåŠ¨è¡¥å…¨

å½“ç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥å­—ç¬¦æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æç¤ºå‡ºä¸è¯¥å­—ç¬¦æœ‰å…³çš„æœç´¢é¡¹ï¼Œå¦‚å›¾ï¼š

![image-20210723204936367](https://cdn.fengxianhub.top/resources-master/202205211119097.png)

è¿™ç§æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å­—æ¯ï¼Œæç¤ºå®Œæ•´è¯æ¡çš„åŠŸèƒ½ï¼Œå°±æ˜¯è‡ªåŠ¨è¡¥å…¨äº†ã€‚



å› ä¸ºéœ€è¦æ ¹æ®æ‹¼éŸ³å­—æ¯æ¥æ¨æ–­ï¼Œå› æ­¤è¦ç”¨åˆ°æ‹¼éŸ³åˆ†è¯åŠŸèƒ½ã€‚



## 2.1.æ‹¼éŸ³åˆ†è¯å™¨



è¦å®ç°æ ¹æ®å­—æ¯åšè¡¥å…¨ï¼Œå°±å¿…é¡»å¯¹æ–‡æ¡£æŒ‰ç…§æ‹¼éŸ³åˆ†è¯ã€‚åœ¨GitHubä¸Šæ°å¥½æœ‰elasticsearchçš„æ‹¼éŸ³åˆ†è¯æ’ä»¶ã€‚åœ°å€ï¼šhttps://github.com/medcl/elasticsearch-analysis-pinyin

![image-20210723205932746](https://cdn.fengxianhub.top/resources-master/202205211119969.png)





è¯¾å‰èµ„æ–™ä¸­ä¹Ÿæä¾›äº†æ‹¼éŸ³åˆ†è¯å™¨çš„å®‰è£…åŒ…ï¼š

![image-20210723205722303](https://cdn.fengxianhub.top/resources-master/202205211435835.png) 



å®‰è£…æ–¹å¼ä¸IKåˆ†è¯å™¨ä¸€æ ·ï¼Œåˆ†ä¸‰æ­¥ï¼š

â€‹	â‘ è§£å‹

â€‹	â‘¡ä¸Šä¼ åˆ°è™šæ‹Ÿæœºä¸­ï¼Œelasticsearchçš„pluginç›®å½•

â€‹	â‘¢é‡å¯elasticsearch

â€‹	â‘£æµ‹è¯•



è¯¦ç»†å®‰è£…æ­¥éª¤å¯ä»¥å‚è€ƒIKåˆ†è¯å™¨çš„å®‰è£…è¿‡ç¨‹ã€‚





æµ‹è¯•ç”¨æ³•å¦‚ä¸‹ï¼š

```json
POSTÂ /_analyze
{
Â Â "text":Â "å¦‚å®¶é…’åº—è¿˜ä¸é”™",
Â Â "analyzer":Â "pinyin"
}
```

ç»“æœï¼š

![image-20210723210126506](https://cdn.fengxianhub.top/resources-master/202205211435671.png) 





## 2.2.è‡ªå®šä¹‰åˆ†è¯å™¨

é»˜è®¤çš„æ‹¼éŸ³åˆ†è¯å™¨ä¼šå°†æ¯ä¸ªæ±‰å­—å•ç‹¬åˆ†ä¸ºæ‹¼éŸ³ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯æ¯ä¸ªè¯æ¡å½¢æˆä¸€ç»„æ‹¼éŸ³ï¼Œéœ€è¦å¯¹æ‹¼éŸ³åˆ†è¯å™¨åšä¸ªæ€§åŒ–å®šåˆ¶ï¼Œå½¢æˆè‡ªå®šä¹‰åˆ†è¯å™¨ã€‚



elasticsearchä¸­åˆ†è¯å™¨ï¼ˆanalyzerï¼‰çš„ç»„æˆåŒ…å«ä¸‰éƒ¨åˆ†ï¼š

- character filtersï¼šåœ¨tokenizerä¹‹å‰å¯¹æ–‡æœ¬è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚åˆ é™¤å­—ç¬¦ã€æ›¿æ¢å­—ç¬¦
- tokenizerï¼šå°†æ–‡æœ¬æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åˆ‡å‰²æˆè¯æ¡ï¼ˆtermï¼‰ã€‚ä¾‹å¦‚keywordï¼Œå°±æ˜¯ä¸åˆ†è¯ï¼›è¿˜æœ‰ik_smart
- tokenizer filterï¼šå°†tokenizerè¾“å‡ºçš„è¯æ¡åšè¿›ä¸€æ­¥å¤„ç†ã€‚ä¾‹å¦‚å¤§å°å†™è½¬æ¢ã€åŒä¹‰è¯å¤„ç†ã€æ‹¼éŸ³å¤„ç†ç­‰



æ–‡æ¡£åˆ†è¯æ—¶ä¼šä¾æ¬¡ç”±è¿™ä¸‰éƒ¨åˆ†æ¥å¤„ç†æ–‡æ¡£ï¼š

   ![image-20210723210427878](https://cdn.fengxianhub.top/resources-master/202205211435169.png)

å£°æ˜è‡ªå®šä¹‰åˆ†è¯å™¨çš„è¯­æ³•å¦‚ä¸‹ï¼š

```json
PUTÂ /test
{
Â Â "settings":Â {
Â Â Â Â "analysis":Â {
Â Â Â Â Â Â "analyzer":Â {Â //Â è‡ªå®šä¹‰åˆ†è¯å™¨
Â Â Â Â Â Â Â Â "my_analyzer":Â {Â Â //Â åˆ†è¯å™¨åç§°
Â Â Â Â Â Â Â Â Â Â "tokenizer":Â "ik_max_word",
Â Â Â Â Â Â Â Â Â Â "filter":Â "py"
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â },
Â Â Â Â Â Â "filter":Â {Â //Â è‡ªå®šä¹‰tokenizerÂ filter
Â Â Â Â Â Â Â Â "py":Â {Â //Â è¿‡æ»¤å™¨åç§°
Â Â Â Â Â Â Â Â Â Â "type":Â "pinyin",Â //Â è¿‡æ»¤å™¨ç±»å‹ï¼Œè¿™é‡Œæ˜¯pinyin
		  "keep_full_pinyin":Â false,
Â Â Â Â Â Â Â Â Â Â "keep_joined_full_pinyin":Â true,
Â Â Â Â Â Â Â Â Â Â "keep_original":Â true,
Â Â Â Â Â Â Â Â Â Â "limit_first_letter_length":Â 16,
Â Â Â Â Â Â Â Â Â Â "remove_duplicated_term":Â true,
Â Â Â Â Â Â Â Â Â Â "none_chinese_pinyin_tokenize":Â false
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â }
Â Â },
Â Â "mappings":Â {
Â Â Â Â "properties":Â {
Â Â Â Â Â Â "name":Â {
Â Â Â Â Â Â Â Â "type":Â "text",
Â Â Â Â Â Â Â Â "analyzer":Â "my_analyzer",
Â Â Â Â Â Â Â Â "search_analyzer":Â "ik_smart"
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```



æµ‹è¯•ï¼š

![image-20210723211829150](https://cdn.fengxianhub.top/resources-master/202205251740829.png)



æ€»ç»“ï¼š

å¦‚ä½•ä½¿ç”¨æ‹¼éŸ³åˆ†è¯å™¨ï¼Ÿ

- â‘ ä¸‹è½½pinyinåˆ†è¯å™¨

- â‘¡è§£å‹å¹¶æ”¾åˆ°elasticsearchçš„pluginç›®å½•

- â‘¢é‡å¯å³å¯

å¦‚ä½•è‡ªå®šä¹‰åˆ†è¯å™¨ï¼Ÿ

- â‘ åˆ›å»ºç´¢å¼•åº“æ—¶ï¼Œåœ¨settingsä¸­é…ç½®ï¼Œå¯ä»¥åŒ…å«ä¸‰éƒ¨åˆ†

- â‘¡character filter

- â‘¢tokenizer

- â‘£filter

æ‹¼éŸ³åˆ†è¯å™¨æ³¨æ„äº‹é¡¹ï¼Ÿ

- ä¸ºäº†é¿å…æœç´¢åˆ°åŒéŸ³å­—ï¼Œæœç´¢æ—¶ä¸è¦ä½¿ç”¨æ‹¼éŸ³åˆ†è¯å™¨





## 2.3.è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢

elasticsearchæä¾›äº†[Completion Suggester](https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html)æŸ¥è¯¢æ¥å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚è¿™ä¸ªæŸ¥è¯¢ä¼šåŒ¹é…ä»¥ç”¨æˆ·è¾“å…¥å†…å®¹å¼€å¤´çš„è¯æ¡å¹¶è¿”å›ã€‚ä¸ºäº†æé«˜è¡¥å…¨æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå¯¹äºæ–‡æ¡£ä¸­å­—æ®µçš„ç±»å‹æœ‰ä¸€äº›çº¦æŸï¼š

- å‚ä¸è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µå¿…é¡»æ˜¯completionç±»å‹ã€‚

- å­—æ®µçš„å†…å®¹ä¸€èˆ¬æ˜¯ç”¨æ¥è¡¥å…¨çš„å¤šä¸ªè¯æ¡å½¢æˆçš„æ•°ç»„ã€‚

æ¯”å¦‚ï¼Œä¸€ä¸ªè¿™æ ·çš„ç´¢å¼•åº“ï¼š

```json
//Â åˆ›å»ºç´¢å¼•åº“
PUTÂ test
{
Â Â "mappings":Â {
Â Â Â Â "properties":Â {
Â Â Â Â Â Â "title":{
Â Â Â Â Â Â Â Â "type":Â "completion"
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```

ç„¶åæ’å…¥ä¸‹é¢çš„æ•°æ®ï¼š

```json
// ç¤ºä¾‹æ•°æ®
POSTÂ test/_doc
{
Â Â "title":Â ["Sony",Â "WH-1000XM3"]
}
POSTÂ test/_doc
{
Â Â "title":Â ["SK-II",Â "PITERA"]
}
POSTÂ test/_doc
{
Â Â "title":Â ["Nintendo",Â "switch"]
}
```



æŸ¥è¯¢çš„DSLè¯­å¥å¦‚ä¸‹ï¼š

```json
//Â è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢
GETÂ /test/_search
{
Â Â "suggest":Â {
Â Â Â Â "title_suggest":Â {
Â Â Â Â Â Â "text":Â "s",Â //Â å…³é”®å­—
Â Â Â Â Â Â "completion":Â {
Â Â Â Â Â Â Â Â "field":Â "title",Â //Â è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µ
Â Â Â Â Â Â Â Â "skip_duplicates":Â true,Â //Â è·³è¿‡é‡å¤çš„
Â Â Â Â Â Â Â Â "size":Â 10Â //Â è·å–å‰10æ¡ç»“æœ
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```







## 2.4.å®ç°é…’åº—æœç´¢æ¡†è‡ªåŠ¨è¡¥å…¨

ç°åœ¨ï¼Œæˆ‘ä»¬çš„hotelç´¢å¼•åº“è¿˜æ²¡æœ‰è®¾ç½®æ‹¼éŸ³åˆ†è¯å™¨ï¼Œéœ€è¦ä¿®æ”¹ç´¢å¼•åº“ä¸­çš„é…ç½®ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ç´¢å¼•åº“æ˜¯æ— æ³•ä¿®æ”¹çš„ï¼Œåªèƒ½åˆ é™¤ç„¶åé‡æ–°åˆ›å»ºã€‚

å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œç”¨æ¥åšè‡ªåŠ¨è¡¥å…¨ï¼Œå°†brandã€suggestionã€cityç­‰éƒ½æ”¾è¿›å»ï¼Œä½œä¸ºè‡ªåŠ¨è¡¥å…¨çš„æç¤ºã€‚



å› æ­¤ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…åŒ…æ‹¬ï¼š

1. ä¿®æ”¹hotelç´¢å¼•åº“ç»“æ„ï¼Œè®¾ç½®è‡ªå®šä¹‰æ‹¼éŸ³åˆ†è¯å™¨

2. ä¿®æ”¹ç´¢å¼•åº“çš„nameã€allå­—æ®µï¼Œä½¿ç”¨è‡ªå®šä¹‰åˆ†è¯å™¨

3. ç´¢å¼•åº“æ·»åŠ ä¸€ä¸ªæ–°å­—æ®µsuggestionï¼Œç±»å‹ä¸ºcompletionç±»å‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„åˆ†è¯å™¨

4. ç»™HotelDocç±»æ·»åŠ suggestionå­—æ®µï¼Œå†…å®¹åŒ…å«brandã€business

5. é‡æ–°å¯¼å…¥æ•°æ®åˆ°hotelåº“



### 2.4.1.ä¿®æ”¹é…’åº—æ˜ å°„ç»“æ„

ä»£ç å¦‚ä¸‹ï¼š

```json
// é…’åº—æ•°æ®ç´¢å¼•åº“
PUT /hotel
{
  "settings": {
    "analysis": {
      "analyzer": {
        "text_anlyzer": {
          "tokenizer": "ik_max_word",
          "filter": "py"
        },
        "completion_analyzer": {
          "tokenizer": "keyword",
          "filter": "py"
        }
      },
      "filter": {
        "py": {
          "type": "pinyin",
          "keep_full_pinyin": false,
          "keep_joined_full_pinyin": true,
          "keep_original": true,
          "limit_first_letter_length": 16,
          "remove_duplicated_term": true,
          "none_chinese_pinyin_tokenize": false
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id":{
        "type": "keyword"
      },
      "name":{
        "type": "text",
        "analyzer": "text_anlyzer",
        "search_analyzer": "ik_smart",
        "copy_to": "all"
      },
      "address":{
        "type": "keyword",
        "index": false
      },
      "price":{
        "type": "integer"
      },
      "score":{
        "type": "integer"
      },
      "brand":{
        "type": "keyword",
        "copy_to": "all"
      },
      "city":{
        "type": "keyword"
      },
      "starName":{
        "type": "keyword"
      },
      "business":{
        "type": "keyword",
        "copy_to": "all"
      },
      "location":{
        "type": "geo_point"
      },
      "pic":{
        "type": "keyword",
        "index": false
      },
      "all":{
        "type": "text",
        "analyzer": "text_anlyzer",
        "search_analyzer": "ik_smart"
      },
      "suggestion":{
          "type": "completion",
          "analyzer": "completion_analyzer"
      }
    }
  }
}
```



### 2.4.2.ä¿®æ”¹HotelDocå®ä½“

HotelDocä¸­è¦æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œç”¨æ¥åšè‡ªåŠ¨è¡¥å…¨ï¼Œå†…å®¹å¯ä»¥æ˜¯é…’åº—å“ç‰Œã€åŸå¸‚ã€å•†åœˆç­‰ä¿¡æ¯ã€‚æŒ‰ç…§è‡ªåŠ¨è¡¥å…¨å­—æ®µçš„è¦æ±‚ï¼Œæœ€å¥½æ˜¯è¿™äº›å­—æ®µçš„æ•°ç»„ã€‚

å› æ­¤æˆ‘ä»¬åœ¨HotelDocä¸­æ·»åŠ ä¸€ä¸ªsuggestionå­—æ®µï¼Œç±»å‹ä¸º`List<String>`ï¼Œç„¶åå°†brandã€cityã€businessç­‰ä¿¡æ¯æ”¾åˆ°é‡Œé¢ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
package cn.itcast.hotel.pojo;

import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

@Data
@NoArgsConstructor
public class HotelDoc {
    private Long id;
    private String name;
    private String address;
    private Integer price;
    private Integer score;
    private String brand;
    private String city;
    private String starName;
    private String business;
    private String location;
    private String pic;
    private Object distance;
    private Boolean isAD;
    private List<String> suggestion;

    public HotelDoc(Hotel hotel) {
        this.id = hotel.getId();
        this.name = hotel.getName();
        this.address = hotel.getAddress();
        this.price = hotel.getPrice();
        this.score = hotel.getScore();
        this.brand = hotel.getBrand();
        this.city = hotel.getCity();
        this.starName = hotel.getStarName();
        this.business = hotel.getBusiness();
        this.location = hotel.getLatitude() + ", " + hotel.getLongitude();
        this.pic = hotel.getPic();
        // ç»„è£…suggestion
        if(this.business.contains("/")){
            // businessæœ‰å¤šä¸ªå€¼ï¼Œéœ€è¦åˆ‡å‰²
            String[] arr = this.business.split("/");
            // æ·»åŠ å…ƒç´ 
            this.suggestion = new ArrayList<>();
            this.suggestion.add(this.brand);
            Collections.addAll(this.suggestion, arr);
        }else {
            this.suggestion = Arrays.asList(this.brand, this.business);
        }
    }
}
```



### 2.4.3.é‡æ–°å¯¼å…¥

é‡æ–°æ‰§è¡Œä¹‹å‰ç¼–å†™çš„å¯¼å…¥æ•°æ®åŠŸèƒ½ï¼Œå¯ä»¥çœ‹åˆ°æ–°çš„é…’åº—æ•°æ®ä¸­åŒ…å«äº†suggestionï¼š

![image-20210723213546183](https://cdn.fengxianhub.top/resources-master/202205251741412.png)





### 2.4.4.è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢çš„JavaAPI

ä¹‹å‰æˆ‘ä»¬å­¦ä¹ äº†è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢çš„DSLï¼Œè€Œæ²¡æœ‰å­¦ä¹ å¯¹åº”çš„JavaAPIï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªç¤ºä¾‹ï¼š

![image-20210723213759922](https://cdn.fengxianhub.top/resources-master/202205251741985.png)



è€Œè‡ªåŠ¨è¡¥å…¨çš„ç»“æœä¹Ÿæ¯”è¾ƒç‰¹æ®Šï¼Œè§£æçš„ä»£ç å¦‚ä¸‹ï¼š

![image-20210723213917524](https://cdn.fengxianhub.top/resources-master/202205251741833.png)



### 2.4.5.å®ç°æœç´¢æ¡†è‡ªåŠ¨è¡¥å…¨

æŸ¥çœ‹å‰ç«¯é¡µé¢ï¼Œå¯ä»¥å‘ç°å½“æˆ‘ä»¬åœ¨è¾“å…¥æ¡†é”®å…¥æ—¶ï¼Œå‰ç«¯ä¼šå‘èµ·ajaxè¯·æ±‚ï¼š

![image-20210723214021062](https://cdn.fengxianhub.top/resources-master/202205251741849.png)

è¿”å›å€¼æ˜¯è¡¥å…¨è¯æ¡çš„é›†åˆï¼Œç±»å‹ä¸º`List<String>`



1ï¼‰åœ¨`cn.itcast.hotel.web`åŒ…ä¸‹çš„`HotelController`ä¸­æ·»åŠ æ–°æ¥å£ï¼Œæ¥æ”¶æ–°çš„è¯·æ±‚ï¼š

```java
@GetMapping("suggestion")
public List<String> getSuggestions(@RequestParam("key") String prefix) {
    return hotelService.getSuggestions(prefix);
}
```



2ï¼‰åœ¨`cn.itcast.hotel.service`åŒ…ä¸‹çš„`IhotelService`ä¸­æ·»åŠ æ–¹æ³•ï¼š

```java
List<String> getSuggestions(String prefix);
```



3ï¼‰åœ¨`cn.itcast.hotel.service.impl.HotelService`ä¸­å®ç°è¯¥æ–¹æ³•ï¼š

```java
@Override
public List<String> getSuggestions(String prefix) {
    try {
        // 1.å‡†å¤‡Request
        SearchRequest request = new SearchRequest("hotel");
        // 2.å‡†å¤‡DSL
        request.source().suggest(new SuggestBuilder().addSuggestion(
            "suggestions",
            SuggestBuilders.completionSuggestion("suggestion")
            .prefix(prefix)
            .skipDuplicates(true)
            .size(10)
        ));
        // 3.å‘èµ·è¯·æ±‚
        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        // 4.è§£æç»“æœ
        Suggest suggest = response.getSuggest();
        // 4.1.æ ¹æ®è¡¥å…¨æŸ¥è¯¢åç§°ï¼Œè·å–è¡¥å…¨ç»“æœ
        CompletionSuggestion suggestions = suggest.getSuggestion("suggestions");
        // 4.2.è·å–options
        List<CompletionSuggestion.Entry.Option> options = suggestions.getOptions();
        // 4.3.éå†
        List<String> list = new ArrayList<>(options.size());
        for (CompletionSuggestion.Entry.Option option : options) {
            String text = option.getText().toString();
            list.add(text);
        }
        return list;
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}
```





# 3.æ•°æ®åŒæ­¥

elasticsearchä¸­çš„é…’åº—æ•°æ®æ¥è‡ªäºmysqlæ•°æ®åº“ï¼Œå› æ­¤mysqlæ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œelasticsearchä¹Ÿå¿…é¡»è·Ÿç€æ”¹å˜ï¼Œè¿™ä¸ªå°±æ˜¯elasticsearchä¸mysqlä¹‹é—´çš„**æ•°æ®åŒæ­¥**ã€‚



![image-20210723214758392](https://cdn.fengxianhub.top/resources-master/202205251741848.png)





## 3.1.æ€è·¯åˆ†æ

å¸¸è§çš„æ•°æ®åŒæ­¥æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š

- åŒæ­¥è°ƒç”¨
- å¼‚æ­¥é€šçŸ¥
- ç›‘å¬binlog



### 3.1.1.åŒæ­¥è°ƒç”¨

æ–¹æ¡ˆä¸€ï¼šåŒæ­¥è°ƒç”¨

![image-20210723214931869](https://cdn.fengxianhub.top/resources-master/202205251741876.png)

åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š

- hotel-demoå¯¹å¤–æä¾›æ¥å£ï¼Œç”¨æ¥ä¿®æ”¹elasticsearchä¸­çš„æ•°æ®
- é…’åº—ç®¡ç†æœåŠ¡åœ¨å®Œæˆæ•°æ®åº“æ“ä½œåï¼Œç›´æ¥è°ƒç”¨hotel-demoæä¾›çš„æ¥å£ï¼Œ



### 3.1.2.å¼‚æ­¥é€šçŸ¥

æ–¹æ¡ˆäºŒï¼šå¼‚æ­¥é€šçŸ¥

![image-20210723215140735](https://cdn.fengxianhub.top/resources-master/202205251742536.png)



æµç¨‹å¦‚ä¸‹ï¼š

- hotel-adminå¯¹mysqlæ•°æ®åº“æ•°æ®å®Œæˆå¢ã€åˆ ã€æ”¹åï¼Œå‘é€MQæ¶ˆæ¯
- hotel-demoç›‘å¬MQï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åå®Œæˆelasticsearchæ•°æ®ä¿®æ”¹





### 3.1.3.ç›‘å¬binlog

æ–¹æ¡ˆä¸‰ï¼šç›‘å¬binlog

![image-20210723215518541](https://cdn.fengxianhub.top/resources-master/202205251742661.png)

æµç¨‹å¦‚ä¸‹ï¼š

- ç»™mysqlå¼€å¯binlogåŠŸèƒ½
- mysqlå®Œæˆå¢ã€åˆ ã€æ”¹æ“ä½œéƒ½ä¼šè®°å½•åœ¨binlogä¸­
- hotel-demoåŸºäºcanalç›‘å¬binlogå˜åŒ–ï¼Œå®æ—¶æ›´æ–°elasticsearchä¸­çš„å†…å®¹



### 3.1.4.é€‰æ‹©

æ–¹å¼ä¸€ï¼šåŒæ­¥è°ƒç”¨

- ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç²—æš´
- ç¼ºç‚¹ï¼šä¸šåŠ¡è€¦åˆåº¦é«˜

æ–¹å¼äºŒï¼šå¼‚æ­¥é€šçŸ¥

- ä¼˜ç‚¹ï¼šä½è€¦åˆï¼Œå®ç°éš¾åº¦ä¸€èˆ¬
- ç¼ºç‚¹ï¼šä¾èµ–mqçš„å¯é æ€§

æ–¹å¼ä¸‰ï¼šç›‘å¬binlog

- ä¼˜ç‚¹ï¼šå®Œå…¨è§£é™¤æœåŠ¡é—´è€¦åˆ
- ç¼ºç‚¹ï¼šå¼€å¯binlogå¢åŠ æ•°æ®åº“è´Ÿæ‹…ã€å®ç°å¤æ‚åº¦é«˜



## 3.2.å®ç°æ•°æ®åŒæ­¥



### 3.2.1.æ€è·¯

åˆ©ç”¨è¯¾å‰èµ„æ–™æä¾›çš„hotel-adminé¡¹ç›®ä½œä¸ºé…’åº—ç®¡ç†çš„å¾®æœåŠ¡ã€‚å½“é…’åº—æ•°æ®å‘ç”Ÿå¢ã€åˆ ã€æ”¹æ—¶ï¼Œè¦æ±‚å¯¹elasticsearchä¸­æ•°æ®ä¹Ÿè¦å®Œæˆç›¸åŒæ“ä½œã€‚

æ­¥éª¤ï¼š

- å¯¼å…¥è¯¾å‰èµ„æ–™æä¾›çš„hotel-adminé¡¹ç›®ï¼Œå¯åŠ¨å¹¶æµ‹è¯•é…’åº—æ•°æ®çš„CRUD

- å£°æ˜exchangeã€queueã€RoutingKey

- åœ¨hotel-adminä¸­çš„å¢ã€åˆ ã€æ”¹ä¸šåŠ¡ä¸­å®Œæˆæ¶ˆæ¯å‘é€

- åœ¨hotel-demoä¸­å®Œæˆæ¶ˆæ¯ç›‘å¬ï¼Œå¹¶æ›´æ–°elasticsearchä¸­æ•°æ®

- å¯åŠ¨å¹¶æµ‹è¯•æ•°æ®åŒæ­¥åŠŸèƒ½









### 3.2.2.å¯¼å…¥demo

å¯¼å…¥è¯¾å‰èµ„æ–™æä¾›çš„hotel-adminé¡¹ç›®ï¼š

![image-20210723220237930](https://cdn.fengxianhub.top/resources-master/202205251743717.png)

è¿è¡Œåï¼Œè®¿é—® http://localhost:8099

![image-20210723220354464](https://cdn.fengxianhub.top/resources-master/202205251743719.png)



å…¶ä¸­åŒ…å«äº†é…’åº—çš„CRUDåŠŸèƒ½ï¼š

![image-20210723220511090](https://cdn.fengxianhub.top/resources-master/202205251743721.png)



### 3.2.3.å£°æ˜äº¤æ¢æœºã€é˜Ÿåˆ—

MQç»“æ„å¦‚å›¾ï¼š

![image-20210723215850307](https://cdn.fengxianhub.top/resources-master/202205251743732.png)



#### 1ï¼‰å¼•å…¥ä¾èµ–

åœ¨hotel-adminã€hotel-demoä¸­å¼•å…¥rabbitmqçš„ä¾èµ–ï¼š

```xml
<!--amqp-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```



#### 2ï¼‰å£°æ˜é˜Ÿåˆ—äº¤æ¢æœºåç§°

åœ¨hotel-adminå’Œhotel-demoä¸­çš„`cn.itcast.hotel.constatnts`åŒ…ä¸‹æ–°å»ºä¸€ä¸ªç±»`MqConstants`ï¼š

```java
package cn.itcast.hotel.constatnts;

    public class MqConstants {
    /**
     * äº¤æ¢æœº
     */
    public final static String HOTEL_EXCHANGE = "hotel.topic";
    /**
     * ç›‘å¬æ–°å¢å’Œä¿®æ”¹çš„é˜Ÿåˆ—
     */
    public final static String HOTEL_INSERT_QUEUE = "hotel.insert.queue";
    /**
     * ç›‘å¬åˆ é™¤çš„é˜Ÿåˆ—
     */
    public final static String HOTEL_DELETE_QUEUE = "hotel.delete.queue";
    /**
     * æ–°å¢æˆ–ä¿®æ”¹çš„RoutingKey
     */
    public final static String HOTEL_INSERT_KEY = "hotel.insert";
    /**
     * åˆ é™¤çš„RoutingKey
     */
    public final static String HOTEL_DELETE_KEY = "hotel.delete";
}
```



#### 3ï¼‰å£°æ˜é˜Ÿåˆ—äº¤æ¢æœº

åœ¨hotel-demoä¸­ï¼Œå®šä¹‰é…ç½®ç±»ï¼Œå£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºï¼š

```java
package cn.itcast.hotel.config;

import cn.itcast.hotel.constants.MqConstants;
import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.core.TopicExchange;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MqConfig {
    @Bean
    public TopicExchange topicExchange(){
        return new TopicExchange(MqConstants.HOTEL_EXCHANGE, true, false);
    }

    @Bean
    public Queue insertQueue(){
        return new Queue(MqConstants.HOTEL_INSERT_QUEUE, true);
    }

    @Bean
    public Queue deleteQueue(){
        return new Queue(MqConstants.HOTEL_DELETE_QUEUE, true);
    }

    @Bean
    public Binding insertQueueBinding(){
        return BindingBuilder.bind(insertQueue()).to(topicExchange()).with(MqConstants.HOTEL_INSERT_KEY);
    }

    @Bean
    public Binding deleteQueueBinding(){
        return BindingBuilder.bind(deleteQueue()).to(topicExchange()).with(MqConstants.HOTEL_DELETE_KEY);
    }
}
```



### 3.2.4.å‘é€MQæ¶ˆæ¯

åœ¨hotel-adminä¸­çš„å¢ã€åˆ ã€æ”¹ä¸šåŠ¡ä¸­åˆ†åˆ«å‘é€MQæ¶ˆæ¯ï¼š

![image-20210723221843816](https://cdn.fengxianhub.top/resources-master/202205251743734.png)



### 3.2.5.æ¥æ”¶MQæ¶ˆæ¯

hotel-demoæ¥æ”¶åˆ°MQæ¶ˆæ¯è¦åšçš„äº‹æƒ…åŒ…æ‹¬ï¼š

- æ–°å¢æ¶ˆæ¯ï¼šæ ¹æ®ä¼ é€’çš„hotelçš„idæŸ¥è¯¢hotelä¿¡æ¯ï¼Œç„¶åæ–°å¢ä¸€æ¡æ•°æ®åˆ°ç´¢å¼•åº“
- åˆ é™¤æ¶ˆæ¯ï¼šæ ¹æ®ä¼ é€’çš„hotelçš„idåˆ é™¤ç´¢å¼•åº“ä¸­çš„ä¸€æ¡æ•°æ®



1ï¼‰é¦–å…ˆåœ¨hotel-demoçš„`cn.itcast.hotel.service`åŒ…ä¸‹çš„`IHotelService`ä¸­æ–°å¢æ–°å¢ã€åˆ é™¤ä¸šåŠ¡

```java
void deleteById(Long id);

void insertById(Long id);
```



2ï¼‰ç»™hotel-demoä¸­çš„`cn.itcast.hotel.service.impl`åŒ…ä¸‹çš„HotelServiceä¸­å®ç°ä¸šåŠ¡ï¼š

```java
@Override
public void deleteById(Long id) {
    try {
        // 1.å‡†å¤‡Request
        DeleteRequest request = new DeleteRequest("hotel", id.toString());
        // 2.å‘é€è¯·æ±‚
        client.delete(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}

@Override
public void insertById(Long id) {
    try {
        // 0.æ ¹æ®idæŸ¥è¯¢é…’åº—æ•°æ®
        Hotel hotel = getById(id);
        // è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹
        HotelDoc hotelDoc = new HotelDoc(hotel);

        // 1.å‡†å¤‡Requestå¯¹è±¡
        IndexRequest request = new IndexRequest("hotel").id(hotel.getId().toString());
        // 2.å‡†å¤‡Jsonæ–‡æ¡£
        request.source(JSON.toJSONString(hotelDoc), XContentType.JSON);
        // 3.å‘é€è¯·æ±‚
        client.index(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}
```



3ï¼‰ç¼–å†™ç›‘å¬å™¨

åœ¨hotel-demoä¸­çš„`cn.itcast.hotel.mq`åŒ…æ–°å¢ä¸€ä¸ªç±»ï¼š

```java
package cn.itcast.hotel.mq;

import cn.itcast.hotel.constants.MqConstants;
import cn.itcast.hotel.service.IHotelService;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
public class HotelListener {

    @Autowired
    private IHotelService hotelService;

    /**
     * ç›‘å¬é…’åº—æ–°å¢æˆ–ä¿®æ”¹çš„ä¸šåŠ¡
     * @param id é…’åº—id
     */
    @RabbitListener(queues = MqConstants.HOTEL_INSERT_QUEUE)
    public void listenHotelInsertOrUpdate(Long id){
        hotelService.insertById(id);
    }

    /**
     * ç›‘å¬é…’åº—åˆ é™¤çš„ä¸šåŠ¡
     * @param id é…’åº—id
     */
    @RabbitListener(queues = MqConstants.HOTEL_DELETE_QUEUE)
    public void listenHotelDelete(Long id){
        hotelService.deleteById(id);
    }
}
```





# 4.é›†ç¾¤

å•æœºçš„elasticsearchåšæ•°æ®å­˜å‚¨ï¼Œå¿…ç„¶é¢ä¸´ä¸¤ä¸ªé—®é¢˜ï¼šæµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ã€å•ç‚¹æ•…éšœé—®é¢˜ã€‚

- æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ï¼šå°†ç´¢å¼•åº“ä»é€»è¾‘ä¸Šæ‹†åˆ†ä¸ºNä¸ªåˆ†ç‰‡ï¼ˆshardï¼‰ï¼Œå­˜å‚¨åˆ°å¤šä¸ªèŠ‚ç‚¹
- å•ç‚¹æ•…éšœé—®é¢˜ï¼šå°†åˆ†ç‰‡æ•°æ®åœ¨ä¸åŒèŠ‚ç‚¹å¤‡ä»½ï¼ˆreplica ï¼‰

**ESé›†ç¾¤ç›¸å…³æ¦‚å¿µ**:

* é›†ç¾¤ï¼ˆclusterï¼‰ï¼šä¸€ç»„æ‹¥æœ‰å…±åŒçš„ cluster name çš„ èŠ‚ç‚¹ã€‚

* <font color="red">èŠ‚ç‚¹ï¼ˆnode)</font>   ï¼šé›†ç¾¤ä¸­çš„ä¸€ä¸ª Elasticearch å®ä¾‹

* <font color="red">åˆ†ç‰‡ï¼ˆshardï¼‰</font>ï¼šç´¢å¼•å¯ä»¥è¢«æ‹†åˆ†ä¸ºä¸åŒçš„éƒ¨åˆ†è¿›è¡Œå­˜å‚¨ï¼Œç§°ä¸ºåˆ†ç‰‡ã€‚åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªç´¢å¼•çš„ä¸åŒåˆ†ç‰‡å¯ä»¥æ‹†åˆ†åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸­

  è§£å†³é—®é¢˜ï¼šæ•°æ®é‡å¤ªå¤§ï¼Œå•ç‚¹å­˜å‚¨é‡æœ‰é™çš„é—®é¢˜ã€‚

  ![image-20200104124440086](https://cdn.fengxianhub.top/resources-master/202205251743744.png)

  > æ­¤å¤„ï¼Œæˆ‘ä»¬æŠŠæ•°æ®åˆ†æˆ3ç‰‡ï¼šshard0ã€shard1ã€shard2

* ä¸»åˆ†ç‰‡ï¼ˆPrimary shardï¼‰ï¼šç›¸å¯¹äºå‰¯æœ¬åˆ†ç‰‡çš„å®šä¹‰ã€‚

* å‰¯æœ¬åˆ†ç‰‡ï¼ˆReplica shardï¼‰æ¯ä¸ªä¸»åˆ†ç‰‡å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå‰¯æœ¬ï¼Œæ•°æ®å’Œä¸»åˆ†ç‰‡ä¸€æ ·ã€‚

  â€‹	

æ•°æ®å¤‡ä»½å¯ä»¥ä¿è¯é«˜å¯ç”¨ï¼Œä½†æ˜¯æ¯ä¸ªåˆ†ç‰‡å¤‡ä»½ä¸€ä»½ï¼Œæ‰€éœ€è¦çš„èŠ‚ç‚¹æ•°é‡å°±ä¼šç¿»ä¸€å€ï¼Œæˆæœ¬å®åœ¨æ˜¯å¤ªé«˜äº†ï¼

ä¸ºäº†åœ¨é«˜å¯ç”¨å’Œæˆæœ¬é—´å¯»æ±‚å¹³è¡¡ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š

- é¦–å…ˆå¯¹æ•°æ®åˆ†ç‰‡ï¼Œå­˜å‚¨åˆ°ä¸åŒèŠ‚ç‚¹
- ç„¶åå¯¹æ¯ä¸ªåˆ†ç‰‡è¿›è¡Œå¤‡ä»½ï¼Œæ”¾åˆ°å¯¹æ–¹èŠ‚ç‚¹ï¼Œå®Œæˆäº’ç›¸å¤‡ä»½

è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘æ‰€éœ€è¦çš„æœåŠ¡èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚å›¾ï¼Œæˆ‘ä»¬ä»¥3åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å¤‡ä»½ä¸€ä»½ä¸ºä¾‹ï¼š

![image-20200104124551912](https://cdn.fengxianhub.top/resources-master/202205251743585.png)

ç°åœ¨ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½æœ‰1ä¸ªå¤‡ä»½ï¼Œå­˜å‚¨åœ¨3ä¸ªèŠ‚ç‚¹ï¼š

- node0ï¼šä¿å­˜äº†åˆ†ç‰‡0å’Œ1
- node1ï¼šä¿å­˜äº†åˆ†ç‰‡0å’Œ2
- node2ï¼šä¿å­˜äº†åˆ†ç‰‡1å’Œ2





## 4.1.æ­å»ºESé›†ç¾¤

å‚è€ƒè¯¾å‰èµ„æ–™çš„æ–‡æ¡£ï¼š

![image-20210723222732427](https://cdn.fengxianhub.top/resources-master/202205251743612.png) 

å…¶ä¸­çš„ç¬¬å››ç« èŠ‚ï¼š

![image-20210723222812619](https://cdn.fengxianhub.top/resources-master/202205251743624.png) 









## 4.2.é›†ç¾¤è„‘è£‚é—®é¢˜



### 4.2.1.é›†ç¾¤èŒè´£åˆ’åˆ†

elasticsearchä¸­é›†ç¾¤èŠ‚ç‚¹æœ‰ä¸åŒçš„èŒè´£åˆ’åˆ†ï¼š

![image-20210723223008967](https://cdn.fengxianhub.top/resources-master/202205251743645.png)



é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­çš„ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒæ—¶å…·å¤‡ä¸Šè¿°å››ç§è§’è‰²ã€‚



ä½†æ˜¯çœŸå®çš„é›†ç¾¤ä¸€å®šè¦å°†é›†ç¾¤èŒè´£åˆ†ç¦»ï¼š

- masterèŠ‚ç‚¹ï¼šå¯¹CPUè¦æ±‚é«˜ï¼Œä½†æ˜¯å†…å­˜è¦æ±‚ä½
- dataèŠ‚ç‚¹ï¼šå¯¹CPUå’Œå†…å­˜è¦æ±‚éƒ½é«˜
- coordinatingèŠ‚ç‚¹ï¼šå¯¹ç½‘ç»œå¸¦å®½ã€CPUè¦æ±‚é«˜

èŒè´£åˆ†ç¦»å¯ä»¥è®©æˆ‘ä»¬æ ¹æ®ä¸åŒèŠ‚ç‚¹çš„éœ€æ±‚åˆ†é…ä¸åŒçš„ç¡¬ä»¶å»éƒ¨ç½²ã€‚è€Œä¸”é¿å…ä¸šåŠ¡ä¹‹é—´çš„äº’ç›¸å¹²æ‰°ã€‚

ä¸€ä¸ªå…¸å‹çš„esé›†ç¾¤èŒè´£åˆ’åˆ†å¦‚å›¾ï¼š

![image-20210723223629142](https://cdn.fengxianhub.top/resources-master/202205251743653.png)



### 4.2.2.è„‘è£‚é—®é¢˜

è„‘è£‚æ˜¯å› ä¸ºé›†ç¾¤ä¸­çš„èŠ‚ç‚¹å¤±è”å¯¼è‡´çš„ã€‚

ä¾‹å¦‚ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¸å…¶å®ƒèŠ‚ç‚¹å¤±è”ï¼š

![image-20210723223804995](https://cdn.fengxianhub.top/resources-master/202205251743666.png)

æ­¤æ—¶ï¼Œnode2å’Œnode3è®¤ä¸ºnode1å®•æœºï¼Œå°±ä¼šé‡æ–°é€‰ä¸»ï¼š

![image-20210723223845754](https://cdn.fengxianhub.top/resources-master/202205251743412.png)

å½“node3å½“é€‰åï¼Œé›†ç¾¤ç»§ç»­å¯¹å¤–æä¾›æœåŠ¡ï¼Œnode2å’Œnode3è‡ªæˆé›†ç¾¤ï¼Œnode1è‡ªæˆé›†ç¾¤ï¼Œä¸¤ä¸ªé›†ç¾¤æ•°æ®ä¸åŒæ­¥ï¼Œå‡ºç°æ•°æ®å·®å¼‚ã€‚

å½“ç½‘ç»œæ¢å¤åï¼Œå› ä¸ºé›†ç¾¤ä¸­æœ‰ä¸¤ä¸ªmasterèŠ‚ç‚¹ï¼Œé›†ç¾¤çŠ¶æ€çš„ä¸ä¸€è‡´ï¼Œå‡ºç°è„‘è£‚çš„æƒ…å†µï¼š

![image-20210723224000555](https://cdn.fengxianhub.top/resources-master/202205251743427.png)



è§£å†³è„‘è£‚çš„æ–¹æ¡ˆæ˜¯ï¼Œè¦æ±‚é€‰ç¥¨è¶…è¿‡ ( eligibleèŠ‚ç‚¹æ•°é‡ + 1 ï¼‰/ 2 æ‰èƒ½å½“é€‰ä¸ºä¸»ï¼Œå› æ­¤eligibleèŠ‚ç‚¹æ•°é‡æœ€å¥½æ˜¯å¥‡æ•°ã€‚å¯¹åº”é…ç½®é¡¹æ˜¯discovery.zen.minimum_master_nodesï¼Œåœ¨es7.0ä»¥åï¼Œå·²ç»æˆä¸ºé»˜è®¤é…ç½®ï¼Œå› æ­¤ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿè„‘è£‚é—®é¢˜



ä¾‹å¦‚ï¼š3ä¸ªèŠ‚ç‚¹å½¢æˆçš„é›†ç¾¤ï¼Œé€‰ç¥¨å¿…é¡»è¶…è¿‡ ï¼ˆ3 + 1ï¼‰ / 2 ï¼Œä¹Ÿå°±æ˜¯2ç¥¨ã€‚node3å¾—åˆ°node2å’Œnode3çš„é€‰ç¥¨ï¼Œå½“é€‰ä¸ºä¸»ã€‚node1åªæœ‰è‡ªå·±1ç¥¨ï¼Œæ²¡æœ‰å½“é€‰ã€‚é›†ç¾¤ä¸­ä¾ç„¶åªæœ‰1ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ²¡æœ‰å‡ºç°è„‘è£‚ã€‚



### 4.2.3.å°ç»“

master eligibleèŠ‚ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

- å‚ä¸é›†ç¾¤é€‰ä¸»
- ä¸»èŠ‚ç‚¹å¯ä»¥ç®¡ç†é›†ç¾¤çŠ¶æ€ã€ç®¡ç†åˆ†ç‰‡ä¿¡æ¯ã€å¤„ç†åˆ›å»ºå’Œåˆ é™¤ç´¢å¼•åº“çš„è¯·æ±‚

dataèŠ‚ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

- æ•°æ®çš„CRUD

coordinatorèŠ‚ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

- è·¯ç”±è¯·æ±‚åˆ°å…¶å®ƒèŠ‚ç‚¹

- åˆå¹¶æŸ¥è¯¢åˆ°çš„ç»“æœï¼Œè¿”å›ç»™ç”¨æˆ·





## 4.3.é›†ç¾¤åˆ†å¸ƒå¼å­˜å‚¨

å½“æ–°å¢æ–‡æ¡£æ—¶ï¼Œåº”è¯¥ä¿å­˜åˆ°ä¸åŒåˆ†ç‰‡ï¼Œä¿è¯æ•°æ®å‡è¡¡ï¼Œé‚£ä¹ˆcoordinating nodeå¦‚ä½•ç¡®å®šæ•°æ®è¯¥å­˜å‚¨åˆ°å“ªä¸ªåˆ†ç‰‡å‘¢ï¼Ÿ



### 4.3.1.åˆ†ç‰‡å­˜å‚¨æµ‹è¯•

æ’å…¥ä¸‰æ¡æ•°æ®ï¼š

![image-20210723225006058](https://cdn.fengxianhub.top/resources-master/202205251743430.png)



![image-20210723225034637](https://cdn.fengxianhub.top/resources-master/202205251743455.png)



![image-20210723225112029](https://cdn.fengxianhub.top/resources-master/202205251743469.png)



æµ‹è¯•å¯ä»¥çœ‹åˆ°ï¼Œä¸‰æ¡æ•°æ®åˆ†åˆ«åœ¨ä¸åŒåˆ†ç‰‡ï¼š

![image-20210723225227928](https://cdn.fengxianhub.top/resources-master/202205251743483.png)

ç»“æœï¼š

![image-20210723225342120](https://cdn.fengxianhub.top/resources-master/202205251743139.png)



### 4.3.2.åˆ†ç‰‡å­˜å‚¨åŸç†



elasticsearchä¼šé€šè¿‡hashç®—æ³•æ¥è®¡ç®—æ–‡æ¡£åº”è¯¥å­˜å‚¨åˆ°å“ªä¸ªåˆ†ç‰‡ï¼š

![image-20210723224354904](https://cdn.fengxianhub.top/resources-master/202205251743146.png)



è¯´æ˜ï¼š

- _routingé»˜è®¤æ˜¯æ–‡æ¡£çš„id
- ç®—æ³•ä¸åˆ†ç‰‡æ•°é‡æœ‰å…³ï¼Œå› æ­¤ç´¢å¼•åº“ä¸€æ—¦åˆ›å»ºï¼Œåˆ†ç‰‡æ•°é‡ä¸èƒ½ä¿®æ”¹ï¼





æ–°å¢æ–‡æ¡£çš„æµç¨‹å¦‚ä¸‹ï¼š

![image-20210723225436084](https://cdn.fengxianhub.top/resources-master/202205251743189.png)



è§£è¯»ï¼š

- 1ï¼‰æ–°å¢ä¸€ä¸ªid=1çš„æ–‡æ¡£
- 2ï¼‰å¯¹idåšhashè¿ç®—ï¼Œå‡å¦‚å¾—åˆ°çš„æ˜¯2ï¼Œåˆ™åº”è¯¥å­˜å‚¨åˆ°shard-2
- 3ï¼‰shard-2çš„ä¸»åˆ†ç‰‡åœ¨node3èŠ‚ç‚¹ï¼Œå°†æ•°æ®è·¯ç”±åˆ°node3
- 4ï¼‰ä¿å­˜æ–‡æ¡£
- 5ï¼‰åŒæ­¥ç»™shard-2çš„å‰¯æœ¬replica-2ï¼Œåœ¨node2èŠ‚ç‚¹
- 6ï¼‰è¿”å›ç»“æœç»™coordinating-nodeèŠ‚ç‚¹



## 4.4.é›†ç¾¤åˆ†å¸ƒå¼æŸ¥è¯¢

elasticsearchçš„æŸ¥è¯¢åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼š

- scatter phaseï¼šåˆ†æ•£é˜¶æ®µï¼Œcoordinating nodeä¼šæŠŠè¯·æ±‚åˆ†å‘åˆ°æ¯ä¸€ä¸ªåˆ†ç‰‡

- gather phaseï¼šèšé›†é˜¶æ®µï¼Œcoordinating nodeæ±‡æ€»data nodeçš„æœç´¢ç»“æœï¼Œå¹¶å¤„ç†ä¸ºæœ€ç»ˆç»“æœé›†è¿”å›ç»™ç”¨æˆ·



![image-20210723225809848](https://cdn.fengxianhub.top/resources-master/202205251743196.png)









## 4.5.é›†ç¾¤æ•…éšœè½¬ç§»

é›†ç¾¤çš„masterèŠ‚ç‚¹ä¼šç›‘æ§é›†ç¾¤ä¸­çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚æœå‘ç°æœ‰èŠ‚ç‚¹å®•æœºï¼Œä¼šç«‹å³å°†å®•æœºèŠ‚ç‚¹çš„åˆ†ç‰‡æ•°æ®è¿ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ï¼Œè¿™ä¸ªå«åšæ•…éšœè½¬ç§»ã€‚



1ï¼‰ä¾‹å¦‚ä¸€ä¸ªé›†ç¾¤ç»“æ„å¦‚å›¾ï¼š

![image-20210723225945963](https://cdn.fengxianhub.top/resources-master/202205251743198.png)

ç°åœ¨ï¼Œnode1æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå…¶å®ƒä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä»èŠ‚ç‚¹ã€‚



2ï¼‰çªç„¶ï¼Œnode1å‘ç”Ÿäº†æ•…éšœï¼š

![image-20210723230020574](https://cdn.fengxianhub.top/resources-master/202205251743208.png)



å®•æœºåçš„ç¬¬ä¸€ä»¶äº‹ï¼Œéœ€è¦é‡æ–°é€‰ä¸»ï¼Œä¾‹å¦‚é€‰ä¸­äº†node2ï¼š

![image-20210723230055974](https://cdn.fengxianhub.top/resources-master/202205251743917.png)



node2æˆä¸ºä¸»èŠ‚ç‚¹åï¼Œä¼šæ£€æµ‹é›†ç¾¤ç›‘æ§çŠ¶æ€ï¼Œå‘ç°ï¼šshard-1ã€shard-0æ²¡æœ‰å‰¯æœ¬èŠ‚ç‚¹ã€‚å› æ­¤éœ€è¦å°†node1ä¸Šçš„æ•°æ®è¿ç§»åˆ°node2ã€node3ï¼š

![image-20210723230216642](https://cdn.fengxianhub.top/resources-master/202205251743940.png)





