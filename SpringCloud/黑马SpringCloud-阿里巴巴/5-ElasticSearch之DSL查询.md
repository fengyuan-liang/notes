# åˆ†å¸ƒå¼æœç´¢å¼•æ“02

ç¬”è®°æ˜¯é»‘é©¬ç¨‹åºå‘˜Cloudè¯¾çš„ç¬”è®°ï¼Œé»‘é©¬çš„è§†é¢‘è®²çš„çœŸçš„å¤ªæ£’äº†ï¼ï¼ä¸å¾—ä¸æ„Ÿæ…¨ä¸€å¥ï¼š0åŸºç¡€ã€å­¦IT ... ğŸ˜˜ğŸ˜˜ğŸ˜˜ğŸ˜˜

[è§†é¢‘åœ°å€](https://www.bilibili.com/video/BV1LQ4y127n4?p=158&spm_id_from=pageDriver)ï¼šhttps://www.bilibili.com/video/BV1LQ4y127n4?p=158&spm_id_from=pageDriver

æˆ‘è‡ªå·±åšçš„æ€ç»´å¯¼å›¾ï¼š

![image-20220525172650853](https://cdn.fengxianhub.top/resources-master/202205251726979.png)



åœ¨æ˜¨å¤©çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯¼å…¥äº†å¤§é‡æ•°æ®åˆ°elasticsearchä¸­ï¼Œå®ç°äº†elasticsearchçš„æ•°æ®å­˜å‚¨åŠŸèƒ½ã€‚ä½†elasticsearchæœ€æ“…é•¿çš„è¿˜æ˜¯æœç´¢å’Œæ•°æ®åˆ†æã€‚

æ‰€ä»¥ä»Šå¤©ï¼Œæˆ‘ä»¬ç ”ç©¶ä¸‹elasticsearchçš„æ•°æ®æœç´¢åŠŸèƒ½ã€‚æˆ‘ä»¬ä¼šåˆ†åˆ«ä½¿ç”¨**DSL**å’Œ**RestClient**å®ç°æœç´¢ã€‚

# 1.DSLæŸ¥è¯¢æ–‡æ¡£

elasticsearchçš„æŸ¥è¯¢ä¾ç„¶æ˜¯åŸºäºJSONé£æ ¼çš„DSLæ¥å®ç°çš„ã€‚

## 1.1.DSLæŸ¥è¯¢åˆ†ç±»

Elasticsearchæä¾›äº†åŸºäºJSONçš„DSLï¼ˆ[Domain Specific Language](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)ï¼‰æ¥å®šä¹‰æŸ¥è¯¢ã€‚å¸¸è§çš„æŸ¥è¯¢ç±»å‹åŒ…æ‹¬ï¼š

- **æŸ¥è¯¢æ‰€æœ‰**ï¼šæŸ¥è¯¢å‡ºæ‰€æœ‰æ•°æ®ï¼Œä¸€èˆ¬æµ‹è¯•ç”¨ã€‚ä¾‹å¦‚ï¼šmatch_all

- **å…¨æ–‡æ£€ç´¢ï¼ˆfull textï¼‰æŸ¥è¯¢**ï¼šåˆ©ç”¨åˆ†è¯å™¨å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹åˆ†è¯ï¼Œç„¶åå»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ã€‚ä¾‹å¦‚ï¼š
  - match_query
  - multi_match_query
- **ç²¾ç¡®æŸ¥è¯¢**ï¼šæ ¹æ®ç²¾ç¡®è¯æ¡å€¼æŸ¥æ‰¾æ•°æ®ï¼Œä¸€èˆ¬æ˜¯æŸ¥æ‰¾keywordã€æ•°å€¼ã€æ—¥æœŸã€booleanç­‰ç±»å‹å­—æ®µã€‚ä¾‹å¦‚ï¼š
  - ids
  - rangeï¼šèŒƒå›´ï¼Œä¾‹å¦‚é‡‘é¢çš„èŒƒå›´
  - termï¼šæ ¹æ®æ•°æ®çš„å€¼è¿›è¡Œç²¾ç¡®æŸ¥æ‰¾
- **åœ°ç†ï¼ˆgeoï¼‰æŸ¥è¯¢**ï¼šæ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š
  - geo_distance
  - geo_bounding_box
- **å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢**ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†ä¸Šè¿°å„ç§æŸ¥è¯¢æ¡ä»¶ç»„åˆèµ·æ¥ï¼Œåˆå¹¶æŸ¥è¯¢æ¡ä»¶ã€‚ä¾‹å¦‚ï¼š
  - bool
  - function_score



æŸ¥è¯¢çš„è¯­æ³•åŸºæœ¬ä¸€è‡´ï¼š

```json
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "æŸ¥è¯¢ç±»å‹":Â {
Â Â Â Â Â Â "æŸ¥è¯¢æ¡ä»¶":Â "æ¡ä»¶å€¼"
Â Â Â Â }
Â Â }
}
```

æˆ‘ä»¬ä»¥æŸ¥è¯¢æ‰€æœ‰ä¸ºä¾‹ï¼Œå…¶ä¸­ï¼š

- æŸ¥è¯¢ç±»å‹ä¸ºmatch_all
- æ²¡æœ‰æŸ¥è¯¢æ¡ä»¶

```json
// æŸ¥è¯¢æ‰€æœ‰
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {
    }
Â Â }
}
```

å…¶å®ƒæŸ¥è¯¢æ— éå°±æ˜¯**æŸ¥è¯¢ç±»å‹**ã€**æŸ¥è¯¢æ¡ä»¶**çš„å˜åŒ–ã€‚



## 1.2.å…¨æ–‡æ£€ç´¢æŸ¥è¯¢



### 1.2.1.ä½¿ç”¨åœºæ™¯

å…¨æ–‡æ£€ç´¢æŸ¥è¯¢çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- å¯¹ç”¨æˆ·æœç´¢çš„å†…å®¹åšåˆ†è¯ï¼Œå¾—åˆ°è¯æ¡
- æ ¹æ®è¯æ¡å»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ï¼Œå¾—åˆ°æ–‡æ¡£id
- æ ¹æ®æ–‡æ¡£idæ‰¾åˆ°æ–‡æ¡£ï¼Œè¿”å›ç»™ç”¨æˆ·

æ¯”è¾ƒå¸¸ç”¨çš„åœºæ™¯åŒ…æ‹¬ï¼š

- å•†åŸçš„è¾“å…¥æ¡†æœç´¢
- ç™¾åº¦è¾“å…¥æ¡†æœç´¢

ä¾‹å¦‚äº¬ä¸œï¼š

![image-20210721165326938](https://cdn.fengxianhub.top/resources-master/202205172000954.png)



å› ä¸ºæ˜¯æ‹¿ç€è¯æ¡å»åŒ¹é…ï¼Œå› æ­¤å‚ä¸æœç´¢çš„å­—æ®µä¹Ÿå¿…é¡»æ˜¯å¯åˆ†è¯çš„textç±»å‹çš„å­—æ®µã€‚



### 1.2.2.åŸºæœ¬è¯­æ³•

å¸¸è§çš„å…¨æ–‡æ£€ç´¢æŸ¥è¯¢åŒ…æ‹¬ï¼š

- matchæŸ¥è¯¢ï¼šå•å­—æ®µæŸ¥è¯¢
- multi_matchæŸ¥è¯¢ï¼šå¤šå­—æ®µæŸ¥è¯¢ï¼Œä»»æ„ä¸€ä¸ªå­—æ®µç¬¦åˆæ¡ä»¶å°±ç®—ç¬¦åˆæŸ¥è¯¢æ¡ä»¶

matchæŸ¥è¯¢è¯­æ³•å¦‚ä¸‹ï¼š

```json
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "match":Â {
Â Â Â Â Â Â "FIELD":Â "TEXT"
Â Â Â Â }
Â Â }
}
```

mulit_matchè¯­æ³•å¦‚ä¸‹ï¼š

```json
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "multi_match":Â {
Â Â Â Â Â Â "query":Â "TEXT",
Â Â Â Â Â Â "fields":Â ["FIELD1",Â " FIELD12"]
Â Â Â Â }
Â Â }
}
```



### 1.2.3.ç¤ºä¾‹

matchæŸ¥è¯¢ç¤ºä¾‹ï¼š

![image-20210721170455419](https://cdn.fengxianhub.top/resources-master/202205172242075.png)



multi_matchæŸ¥è¯¢ç¤ºä¾‹ï¼š

![image-20210721170720691](https://cdn.fengxianhub.top/resources-master/202205172242757.png)



å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ç§æŸ¥è¯¢ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

å› ä¸ºæˆ‘ä»¬å°†brandã€nameã€businesså€¼éƒ½åˆ©ç”¨copy_toå¤åˆ¶åˆ°äº†allå­—æ®µä¸­ã€‚å› æ­¤ä½ æ ¹æ®ä¸‰ä¸ªå­—æ®µæœç´¢ï¼Œå’Œæ ¹æ®allå­—æ®µæœç´¢æ•ˆæœå½“ç„¶ä¸€æ ·äº†ã€‚

**ä½†æ˜¯ï¼Œæœç´¢å­—æ®µè¶Šå¤šï¼Œå¯¹æŸ¥è¯¢æ€§èƒ½å½±å“è¶Šå¤§ï¼Œå› æ­¤å»ºè®®é‡‡ç”¨copy_toï¼Œç„¶åå•å­—æ®µæŸ¥è¯¢çš„æ–¹å¼ã€‚**



### 1.2.4.æ€»ç»“

matchå’Œmulti_matchçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- matchï¼šæ ¹æ®ä¸€ä¸ªå­—æ®µæŸ¥è¯¢
- multi_matchï¼šæ ¹æ®å¤šä¸ªå­—æ®µæŸ¥è¯¢ï¼Œå‚ä¸æŸ¥è¯¢å­—æ®µè¶Šå¤šï¼ŒæŸ¥è¯¢æ€§èƒ½è¶Šå·®



## 1.3.ç²¾å‡†æŸ¥è¯¢

ç²¾ç¡®æŸ¥è¯¢ä¸€èˆ¬æ˜¯æŸ¥æ‰¾keywordã€æ•°å€¼ã€æ—¥æœŸã€booleanç­‰ç±»å‹å­—æ®µï¼Œ**ä»–ä»¬çš„å€¼æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“**ã€‚æ‰€ä»¥**ä¸ä¼š**å¯¹æœç´¢æ¡ä»¶åˆ†è¯ã€‚å¸¸è§çš„æœ‰ï¼š

- termï¼šæ ¹æ®è¯æ¡ç²¾ç¡®å€¼æŸ¥è¯¢
- rangeï¼šæ ¹æ®å€¼çš„èŒƒå›´æŸ¥è¯¢



### 1.3.1.termæŸ¥è¯¢

å› ä¸ºç²¾ç¡®æŸ¥è¯¢çš„å­—æ®µæœæ˜¯ä¸åˆ†è¯çš„å­—æ®µï¼Œå› æ­¤æŸ¥è¯¢çš„æ¡ä»¶ä¹Ÿå¿…é¡»æ˜¯**ä¸åˆ†è¯**çš„è¯æ¡ã€‚æŸ¥è¯¢æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„å†…å®¹è·Ÿè‡ªåŠ¨å€¼å®Œå…¨åŒ¹é…æ—¶æ‰è®¤ä¸ºç¬¦åˆæ¡ä»¶ã€‚å¦‚æœç”¨æˆ·è¾“å…¥çš„å†…å®¹è¿‡å¤šï¼Œåè€Œæœç´¢ä¸åˆ°æ•°æ®ã€‚



è¯­æ³•è¯´æ˜ï¼š

```json
//Â termæŸ¥è¯¢
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "term":Â {
Â Â Â Â Â Â "FIELD":Â {
Â Â Â Â Â Â Â Â "value":Â "VALUE"
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```



ç¤ºä¾‹ï¼š

å½“æˆ‘æœç´¢çš„æ˜¯ç²¾ç¡®è¯æ¡æ—¶ï¼Œèƒ½æ­£ç¡®æŸ¥è¯¢å‡ºç»“æœï¼š

![image-20210721171655308](https://cdn.fengxianhub.top/resources-master/202205172245861.png)

ä½†æ˜¯ï¼Œå½“æˆ‘æœç´¢çš„å†…å®¹ä¸æ˜¯è¯æ¡ï¼Œè€Œæ˜¯å¤šä¸ªè¯è¯­å½¢æˆçš„çŸ­è¯­æ—¶ï¼Œåè€Œæœç´¢ä¸åˆ°ï¼š

![image-20210721171838378](https://cdn.fengxianhub.top/resources-master/202205172245569.png)





### 1.3.2.rangeæŸ¥è¯¢

èŒƒå›´æŸ¥è¯¢ï¼Œä¸€èˆ¬åº”ç”¨åœ¨å¯¹æ•°å€¼ç±»å‹åšèŒƒå›´è¿‡æ»¤çš„æ—¶å€™ã€‚æ¯”å¦‚åšä»·æ ¼èŒƒå›´è¿‡æ»¤ã€‚



åŸºæœ¬è¯­æ³•ï¼š

```json
//Â rangeæŸ¥è¯¢
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "range":Â {
Â Â Â Â Â Â "FIELD":Â {
Â Â Â Â Â Â Â Â "gte":Â 10, // è¿™é‡Œçš„gteä»£è¡¨å¤§äºç­‰äºï¼Œgtåˆ™ä»£è¡¨å¤§äº
Â Â Â Â Â Â Â Â "lte":Â 20 // lteä»£è¡¨å°äºç­‰äºï¼Œltåˆ™ä»£è¡¨å°äº
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```



ç¤ºä¾‹ï¼š

![image-20210721172307172](https://cdn.fengxianhub.top/resources-master/202205172245022.png)





### 1.3.3.æ€»ç»“

ç²¾ç¡®æŸ¥è¯¢å¸¸è§çš„æœ‰å“ªäº›ï¼Ÿ

- termæŸ¥è¯¢ï¼šæ ¹æ®è¯æ¡ç²¾ç¡®åŒ¹é…ï¼Œä¸€èˆ¬æœç´¢keywordç±»å‹ã€æ•°å€¼ç±»å‹ã€å¸ƒå°”ç±»å‹ã€æ—¥æœŸç±»å‹å­—æ®µ
- rangeæŸ¥è¯¢ï¼šæ ¹æ®æ•°å€¼èŒƒå›´æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯æ•°å€¼ã€æ—¥æœŸçš„èŒƒå›´



## 1.4.åœ°ç†åæ ‡æŸ¥è¯¢

æ‰€è°“çš„åœ°ç†åæ ‡æŸ¥è¯¢ï¼Œå…¶å®å°±æ˜¯æ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ï¼Œå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html

å¸¸è§çš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

- æºç¨‹ï¼šæœç´¢æˆ‘é™„è¿‘çš„é…’åº—
- æ»´æ»´ï¼šæœç´¢æˆ‘é™„è¿‘çš„å‡ºç§Ÿè½¦
- å¾®ä¿¡ï¼šæœç´¢æˆ‘é™„è¿‘çš„äºº



é™„è¿‘çš„é…’åº—ï¼š

![image-20210721172645103](https://cdn.fengxianhub.top/resources-master/202205172014399.png) 

é™„è¿‘çš„è½¦ï¼š

![image-20210721172654880](https://cdn.fengxianhub.top/resources-master/202205172014181.png) 



### 1.4.1.çŸ©å½¢èŒƒå›´æŸ¥è¯¢

çŸ©å½¢èŒƒå›´æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯geo_bounding_boxæŸ¥è¯¢ï¼ŒæŸ¥è¯¢åæ ‡è½åœ¨æŸä¸ªçŸ©å½¢èŒƒå›´çš„æ‰€æœ‰æ–‡æ¡£ï¼š

![DKV9HZbVS6](https://cdn.fengxianhub.top/resources-master/202205172014992.gif)

æŸ¥è¯¢æ—¶ï¼Œéœ€è¦æŒ‡å®šçŸ©å½¢çš„**å·¦ä¸Š**ã€**å³ä¸‹**ä¸¤ä¸ªç‚¹çš„åæ ‡ï¼Œç„¶åç”»å‡ºä¸€ä¸ªçŸ©å½¢ï¼Œè½åœ¨è¯¥çŸ©å½¢å†…çš„éƒ½æ˜¯ç¬¦åˆæ¡ä»¶çš„ç‚¹ã€‚

è¯­æ³•å¦‚ä¸‹ï¼š

```json
//Â geo_bounding_boxæŸ¥è¯¢
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "geo_bounding_box":Â {
Â Â Â Â Â Â "FIELD":Â {
Â Â Â Â Â Â Â Â "top_left":Â { // å·¦ä¸Šç‚¹
Â Â Â Â Â Â Â Â Â Â "lat":Â 31.1,
Â Â Â Â Â Â Â Â Â Â "lon":Â 121.5
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â "bottom_right":Â { // å³ä¸‹ç‚¹
Â Â Â Â Â Â Â Â Â Â "lat":Â 30.9,
Â Â Â Â Â Â Â Â Â Â "lon":Â 121.7
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```





è¿™ç§å¹¶ä¸ç¬¦åˆâ€œé™„è¿‘çš„äººâ€è¿™æ ·çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸åšäº†ã€‚



### 1.4.2.é™„è¿‘æŸ¥è¯¢

é™„è¿‘æŸ¥è¯¢ï¼Œä¹Ÿå«åšè·ç¦»æŸ¥è¯¢ï¼ˆgeo_distanceï¼‰ï¼šæŸ¥è¯¢åˆ°æŒ‡å®šä¸­å¿ƒç‚¹å°äºæŸä¸ªè·ç¦»å€¼çš„æ‰€æœ‰æ–‡æ¡£ã€‚



æ¢å¥è¯æ¥è¯´ï¼Œåœ¨åœ°å›¾ä¸Šæ‰¾ä¸€ä¸ªç‚¹ä½œä¸ºåœ†å¿ƒï¼Œä»¥æŒ‡å®šè·ç¦»ä¸ºåŠå¾„ï¼Œç”»ä¸€ä¸ªåœ†ï¼Œè½åœ¨åœ†å†…çš„åæ ‡éƒ½ç®—ç¬¦åˆæ¡ä»¶ï¼š

![vZrdKAh19C](https://cdn.fengxianhub.top/resources-master/202205172018086.gif)

è¯­æ³•è¯´æ˜ï¼š

```json
//Â geo_distance æŸ¥è¯¢
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "geo_distance":Â {
Â Â Â Â Â Â "distance":Â "15km", // åŠå¾„
Â Â Â Â Â Â "FIELD":Â "31.21,121.5" // åœ†å¿ƒ
Â Â Â Â }
Â Â }
}
```



ç¤ºä¾‹ï¼š

æˆ‘ä»¬å…ˆæœç´¢é™†å®¶å˜´é™„è¿‘15kmçš„é…’åº—ï¼š

![image-20210721175443234](https://cdn.fengxianhub.top/resources-master/202205172018180.png)

å‘ç°å…±æœ‰47å®¶é…’åº—ã€‚



ç„¶åæŠŠåŠå¾„ç¼©çŸ­åˆ°3å…¬é‡Œï¼š

![image-20210721182031475](https://cdn.fengxianhub.top/resources-master/202205172018849.png)

å¯ä»¥å‘ç°ï¼Œæœç´¢åˆ°çš„é…’åº—æ•°é‡å‡å°‘åˆ°äº†5å®¶ã€‚



## 1.5.å¤åˆæŸ¥è¯¢

å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†å…¶å®ƒç®€å•æŸ¥è¯¢ç»„åˆèµ·æ¥ï¼Œå®ç°æ›´å¤æ‚çš„æœç´¢é€»è¾‘ã€‚å¸¸è§çš„æœ‰ä¸¤ç§ï¼š

- fuction scoreï¼šç®—åˆ†å‡½æ•°æŸ¥è¯¢ï¼Œå¯ä»¥æ§åˆ¶æ–‡æ¡£ç›¸å…³æ€§ç®—åˆ†ï¼Œæ§åˆ¶æ–‡æ¡£æ’å
- bool queryï¼šå¸ƒå°”æŸ¥è¯¢ï¼Œåˆ©ç”¨é€»è¾‘å…³ç³»ç»„åˆå¤šä¸ªå…¶å®ƒçš„æŸ¥è¯¢ï¼Œå®ç°å¤æ‚æœç´¢



### 1.5.1.ç›¸å…³æ€§ç®—åˆ†

å½“æˆ‘ä»¬åˆ©ç”¨matchæŸ¥è¯¢æ—¶ï¼Œæ–‡æ¡£ç»“æœä¼šæ ¹æ®ä¸æœç´¢è¯æ¡çš„å…³è”åº¦æ‰“åˆ†ï¼ˆ_scoreï¼‰ï¼Œè¿”å›ç»“æœæ—¶æŒ‰ç…§åˆ†å€¼é™åºæ’åˆ—ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœç´¢ "è™¹æ¡¥å¦‚å®¶"ï¼Œç»“æœå¦‚ä¸‹ï¼š

```json
[
Â Â {
Â Â Â Â "_score"Â :Â 17.850193,
Â Â Â Â "_source"Â :Â {
Â Â Â Â Â Â "name"Â :Â "è™¹æ¡¥å¦‚å®¶é…’åº—çœŸä¸é”™",
Â Â Â Â }
Â Â },
Â Â {
Â Â Â Â "_score"Â :Â 12.259849,
Â Â Â Â "_source"Â :Â {
Â Â Â Â Â Â "name"Â :Â "å¤–æ»©å¦‚å®¶é…’åº—çœŸä¸é”™",
Â Â Â Â }
Â Â },
Â Â {
Â Â Â Â "_score"Â :Â 11.91091,
Â Â Â Â "_source"Â :Â {
Â Â Â Â Â Â "name"Â :Â "è¿ªå£«å°¼å¦‚å®¶é…’åº—çœŸä¸é”™",
Â Â Â Â }
Â Â }
]
```



åœ¨elasticsearchä¸­ï¼Œæ—©æœŸä½¿ç”¨çš„æ‰“åˆ†ç®—æ³•æ˜¯TF-IDFç®—æ³•ï¼Œå…¬å¼å¦‚ä¸‹ï¼š

![image-20210721190152134](https://cdn.fengxianhub.top/resources-master/202205172021572.png)



åœ¨åæ¥çš„5.1ç‰ˆæœ¬å‡çº§ä¸­ï¼Œelasticsearchå°†ç®—æ³•æ”¹è¿›ä¸ºBM25ç®—æ³•ï¼Œå…¬å¼å¦‚ä¸‹ï¼š

![image-20210721190416214](https://cdn.fengxianhub.top/resources-master/202205172021209.png)





TF-IDFç®—æ³•æœ‰ä¸€å„ç¼ºé™·ï¼Œå°±æ˜¯è¯æ¡é¢‘ç‡è¶Šé«˜ï¼Œæ–‡æ¡£å¾—åˆ†ä¹Ÿä¼šè¶Šé«˜ï¼Œå•ä¸ªè¯æ¡å¯¹æ–‡æ¡£å½±å“è¾ƒå¤§ã€‚è€ŒBM25åˆ™ä¼šè®©å•ä¸ªè¯æ¡çš„ç®—åˆ†æœ‰ä¸€ä¸ªä¸Šé™ï¼Œæ›²çº¿æ›´åŠ å¹³æ»‘ï¼š

![image-20210721190907320](https://cdn.fengxianhub.top/resources-master/202205172022459.png)



å°ç»“ï¼šelasticsearchä¼šæ ¹æ®è¯æ¡å’Œæ–‡æ¡£çš„ç›¸å…³åº¦åšæ‰“åˆ†ï¼Œç®—æ³•ç”±ä¸¤ç§ï¼š

- TF-IDFç®—æ³•
- BM25ç®—æ³•ï¼Œelasticsearch5.1ç‰ˆæœ¬åé‡‡ç”¨çš„ç®—æ³•



### 1.5.2.ç®—åˆ†å‡½æ•°æŸ¥è¯¢

æ ¹æ®ç›¸å…³åº¦æ‰“åˆ†æ˜¯æ¯”è¾ƒåˆç†çš„éœ€æ±‚ï¼Œä½†**åˆç†çš„ä¸ä¸€å®šæ˜¯äº§å“ç»ç†éœ€è¦**çš„ã€‚

ä»¥ç™¾åº¦ä¸ºä¾‹ï¼Œä½ æœç´¢çš„ç»“æœä¸­ï¼Œå¹¶ä¸æ˜¯ç›¸å…³åº¦è¶Šé«˜æ’åè¶Šé å‰ï¼Œè€Œæ˜¯è°æçš„é’±å¤šæ’åå°±è¶Šé å‰ã€‚å¦‚å›¾ï¼š

![image-20210721191144560](https://cdn.fengxianhub.top/resources-master/202205172022646.png)



è¦æƒ³è®¤ä¸ºæ§åˆ¶ç›¸å…³æ€§ç®—åˆ†ï¼Œå°±éœ€è¦åˆ©ç”¨elasticsearchä¸­çš„function score æŸ¥è¯¢äº†ã€‚



#### 1ï¼‰è¯­æ³•è¯´æ˜

![image-20210721191544750](https://cdn.fengxianhub.top/resources-master/202205172027971.png)



function score æŸ¥è¯¢ä¸­åŒ…å«å››éƒ¨åˆ†å†…å®¹ï¼š

- **åŸå§‹æŸ¥è¯¢**æ¡ä»¶ï¼šqueryéƒ¨åˆ†ï¼ŒåŸºäºè¿™ä¸ªæ¡ä»¶æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”åŸºäºBM25ç®—æ³•ç»™æ–‡æ¡£æ‰“åˆ†ï¼Œ**åŸå§‹ç®—åˆ†**ï¼ˆquery score)
- **è¿‡æ»¤æ¡ä»¶**ï¼šfilteréƒ¨åˆ†ï¼Œç¬¦åˆè¯¥æ¡ä»¶çš„æ–‡æ¡£æ‰ä¼šé‡æ–°ç®—åˆ†
- **ç®—åˆ†å‡½æ•°**ï¼šç¬¦åˆfilteræ¡ä»¶çš„æ–‡æ¡£è¦æ ¹æ®è¿™ä¸ªå‡½æ•°åšè¿ç®—ï¼Œå¾—åˆ°çš„**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰ï¼Œæœ‰å››ç§å‡½æ•°
  - weightï¼šå‡½æ•°ç»“æœæ˜¯å¸¸é‡
  - field_value_factorï¼šä»¥æ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µå€¼ä½œä¸ºå‡½æ•°ç»“æœ
  - random_scoreï¼šä»¥éšæœºæ•°ä½œä¸ºå‡½æ•°ç»“æœ
  - script_scoreï¼šè‡ªå®šä¹‰ç®—åˆ†å‡½æ•°ç®—æ³•
- **è¿ç®—æ¨¡å¼**ï¼šç®—åˆ†å‡½æ•°çš„ç»“æœã€åŸå§‹æŸ¥è¯¢çš„ç›¸å…³æ€§ç®—åˆ†ï¼Œä¸¤è€…ä¹‹é—´çš„è¿ç®—æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š
  - multiplyï¼šç›¸ä¹˜
  - replaceï¼šç”¨function scoreæ›¿æ¢query score
  - å…¶å®ƒï¼Œä¾‹å¦‚ï¼šsumã€avgã€maxã€min



function scoreçš„è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š

- 1ï¼‰æ ¹æ®**åŸå§‹æ¡ä»¶**æŸ¥è¯¢æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”è®¡ç®—ç›¸å…³æ€§ç®—åˆ†ï¼Œç§°ä¸º**åŸå§‹ç®—åˆ†**ï¼ˆquery scoreï¼‰
- 2ï¼‰æ ¹æ®**è¿‡æ»¤æ¡ä»¶**ï¼Œè¿‡æ»¤æ–‡æ¡£
- 3ï¼‰ç¬¦åˆ**è¿‡æ»¤æ¡ä»¶**çš„æ–‡æ¡£ï¼ŒåŸºäº**ç®—åˆ†å‡½æ•°**è¿ç®—ï¼Œå¾—åˆ°**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰
- 4ï¼‰å°†**åŸå§‹ç®—åˆ†**ï¼ˆquery scoreï¼‰å’Œ**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰åŸºäº**è¿ç®—æ¨¡å¼**åšè¿ç®—ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœï¼Œä½œä¸ºç›¸å…³æ€§ç®—åˆ†ã€‚



å› æ­¤ï¼Œå…¶ä¸­çš„å…³é”®ç‚¹æ˜¯ï¼š

- è¿‡æ»¤æ¡ä»¶ï¼šå†³å®šå“ªäº›æ–‡æ¡£çš„ç®—åˆ†è¢«ä¿®æ”¹
- ç®—åˆ†å‡½æ•°ï¼šå†³å®šå‡½æ•°ç®—åˆ†çš„ç®—æ³•
- è¿ç®—æ¨¡å¼ï¼šå†³å®šæœ€ç»ˆç®—åˆ†ç»“æœ



#### 2ï¼‰ç¤ºä¾‹

éœ€æ±‚ï¼šç»™â€œå¦‚å®¶â€è¿™ä¸ªå“ç‰Œçš„é…’åº—æ’åé å‰ä¸€äº›

ç¿»è¯‘ä¸€ä¸‹è¿™ä¸ªéœ€æ±‚ï¼Œè½¬æ¢ä¸ºä¹‹å‰è¯´çš„å››ä¸ªè¦ç‚¹ï¼š

- åŸå§‹æ¡ä»¶ï¼šä¸ç¡®å®šï¼Œå¯ä»¥ä»»æ„å˜åŒ–
- è¿‡æ»¤æ¡ä»¶ï¼šbrand = "å¦‚å®¶"
- ç®—åˆ†å‡½æ•°ï¼šå¯ä»¥ç®€å•ç²—æš´ï¼Œç›´æ¥ç»™å›ºå®šçš„ç®—åˆ†ç»“æœï¼Œweight
- è¿ç®—æ¨¡å¼ï¼šæ¯”å¦‚æ±‚å’Œ

å› æ­¤æœ€ç»ˆçš„DSLè¯­å¥å¦‚ä¸‹ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "function_score":Â {
Â Â Â Â Â Â "query":Â {  .... }, // åŸå§‹æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯ä»»æ„æ¡ä»¶
Â Â Â Â Â Â "functions":Â [Â //Â ç®—åˆ†å‡½æ•°
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â "filter":Â {Â //Â æ»¡è¶³çš„æ¡ä»¶ï¼Œå“ç‰Œå¿…é¡»æ˜¯å¦‚å®¶
Â Â Â Â Â Â Â Â Â Â Â Â "term":Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â "brand":Â "å¦‚å®¶"
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â "weight":Â 2Â //Â ç®—åˆ†æƒé‡ä¸º2
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â ],
      "boost_mode": "sum" // åŠ æƒæ¨¡å¼ï¼Œæ±‚å’Œ
Â Â Â Â }
Â Â }
}
```



æµ‹è¯•ï¼Œåœ¨æœªæ·»åŠ ç®—åˆ†å‡½æ•°æ—¶ï¼Œå¦‚å®¶å¾—åˆ†å¦‚ä¸‹ï¼š

![image-20210721193152520](https://cdn.fengxianhub.top/resources-master/202205172051004.png)

æ·»åŠ äº†ç®—åˆ†å‡½æ•°åï¼Œå¦‚å®¶å¾—åˆ†å°±æå‡äº†ï¼š

![image-20210721193458182](https://cdn.fengxianhub.top/resources-master/202205172051956.png)



#### 3ï¼‰å°ç»“

function score queryå®šä¹‰çš„ä¸‰è¦ç´ æ˜¯ä»€ä¹ˆï¼Ÿ

- è¿‡æ»¤æ¡ä»¶ï¼šå“ªäº›æ–‡æ¡£è¦åŠ åˆ†
- ç®—åˆ†å‡½æ•°ï¼šå¦‚ä½•è®¡ç®—function score
- åŠ æƒæ–¹å¼ï¼šfunction score ä¸ query scoreå¦‚ä½•è¿ç®—



### 1.5.3.Boolean Queryå¸ƒå°”æŸ¥è¯¢

å¸ƒå°”æŸ¥è¯¢æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæŸ¥è¯¢å­å¥çš„ç»„åˆï¼Œæ¯ä¸€ä¸ªå­å¥å°±æ˜¯ä¸€ä¸ª**å­æŸ¥è¯¢**ã€‚å­æŸ¥è¯¢çš„ç»„åˆæ–¹å¼æœ‰ï¼š

- mustï¼šå¿…é¡»åŒ¹é…æ¯ä¸ªå­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œä¸â€
- shouldï¼šé€‰æ‹©æ€§åŒ¹é…å­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œæˆ–â€
- must_notï¼šå¿…é¡»ä¸åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**ï¼Œç±»ä¼¼â€œéâ€
- filterï¼šå¿…é¡»åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**



æ¯”å¦‚åœ¨æœç´¢é…’åº—æ—¶ï¼Œé™¤äº†å…³é”®å­—æœç´¢å¤–ï¼Œæˆ‘ä»¬è¿˜å¯èƒ½æ ¹æ®å“ç‰Œã€ä»·æ ¼ã€åŸå¸‚ç­‰å­—æ®µåšè¿‡æ»¤ï¼š

![image-20210721193822848](https://cdn.fengxianhub.top/resources-master/202205172051908.png)

æ¯ä¸€ä¸ªä¸åŒçš„å­—æ®µï¼Œå…¶æŸ¥è¯¢çš„æ¡ä»¶ã€æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œå¿…é¡»æ˜¯å¤šä¸ªä¸åŒçš„æŸ¥è¯¢ï¼Œè€Œè¦ç»„åˆè¿™äº›æŸ¥è¯¢ï¼Œå°±å¿…é¡»ç”¨boolæŸ¥è¯¢äº†ã€‚



éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœç´¢æ—¶ï¼Œå‚ä¸**æ‰“åˆ†çš„å­—æ®µè¶Šå¤šï¼ŒæŸ¥è¯¢çš„æ€§èƒ½ä¹Ÿè¶Šå·®**ã€‚å› æ­¤è¿™ç§å¤šæ¡ä»¶æŸ¥è¯¢æ—¶ï¼Œå»ºè®®è¿™æ ·åšï¼š

- æœç´¢æ¡†çš„å…³é”®å­—æœç´¢ï¼Œæ˜¯å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œä½¿ç”¨mustæŸ¥è¯¢ï¼Œå‚ä¸ç®—åˆ†
- å…¶å®ƒè¿‡æ»¤æ¡ä»¶ï¼Œé‡‡ç”¨filteræŸ¥è¯¢ã€‚ä¸å‚ä¸ç®—åˆ†



#### 1ï¼‰è¯­æ³•ç¤ºä¾‹ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "bool":Â {
Â Â Â Â Â Â "must":Â [
Â Â Â Â Â Â Â Â {"term":Â {"city":Â "ä¸Šæµ·"Â }}
Â Â Â Â Â Â ],
Â Â Â Â Â Â "should":Â [
Â Â Â Â Â Â Â Â {"term":Â {"brand":Â "çš‡å† å‡æ—¥"Â }},
        {"term":Â {"brand":Â "åç¾è¾¾"Â }}
Â Â Â Â Â Â ],
Â Â Â Â Â Â "must_not":Â [
Â Â Â Â Â Â Â Â {Â "range":Â {Â "price":Â {Â "lte":Â 500Â }Â }}
Â Â Â Â Â Â ],
Â Â Â Â Â Â "filter":Â [
Â Â Â Â Â Â Â Â {Â "range":Â {"score":Â {Â "gte":Â 45Â }Â }}
Â Â Â Â Â Â ]
Â Â Â Â }
Â Â }
}
```



#### 2ï¼‰ç¤ºä¾‹

éœ€æ±‚ï¼šæœç´¢åå­—åŒ…å«â€œå¦‚å®¶â€ï¼Œä»·æ ¼ä¸é«˜äº400ï¼Œåœ¨åæ ‡31.21,121.5å‘¨å›´10kmèŒƒå›´å†…çš„é…’åº—ã€‚

åˆ†æï¼š

- åç§°æœç´¢ï¼Œå±äºå…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œåº”è¯¥å‚ä¸ç®—åˆ†ã€‚æ”¾åˆ°mustä¸­
- ä»·æ ¼ä¸é«˜äº400ï¼Œç”¨rangeæŸ¥è¯¢ï¼Œå±äºè¿‡æ»¤æ¡ä»¶ï¼Œä¸å‚ä¸ç®—åˆ†ã€‚æ”¾åˆ°must_notä¸­
- å‘¨å›´10kmèŒƒå›´å†…ï¼Œç”¨geo_distanceæŸ¥è¯¢ï¼Œå±äºè¿‡æ»¤æ¡ä»¶ï¼Œä¸å‚ä¸ç®—åˆ†ã€‚æ”¾åˆ°filterä¸­



![image-20210721194744183](https://cdn.fengxianhub.top/resources-master/202205172106065.png)





#### 3ï¼‰å°ç»“

boolæŸ¥è¯¢æœ‰å‡ ç§é€»è¾‘å…³ç³»ï¼Ÿ

- mustï¼šå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºâ€œä¸â€
- shouldï¼šé€‰æ‹©æ€§åŒ¹é…çš„æ¡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºâ€œæˆ–â€
- must_notï¼šå¿…é¡»ä¸åŒ¹é…çš„æ¡ä»¶ï¼Œä¸å‚ä¸æ‰“åˆ†
- filterï¼šå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œä¸å‚ä¸æ‰“åˆ†



# 2.æœç´¢ç»“æœå¤„ç†

æœç´¢çš„ç»“æœå¯ä»¥æŒ‰ç…§ç”¨æˆ·æŒ‡å®šçš„æ–¹å¼å»å¤„ç†æˆ–å±•ç¤ºã€‚

## 2.1.æ’åº

elasticsearché»˜è®¤æ˜¯æ ¹æ®ç›¸å…³åº¦ç®—åˆ†ï¼ˆ_scoreï¼‰æ¥æ’åºï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ–¹å¼å¯¹æœç´¢[ç»“æœæ’åº](https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html)ã€‚å¯ä»¥æ’åºå­—æ®µç±»å‹æœ‰ï¼škeywordç±»å‹ã€æ•°å€¼ç±»å‹ã€åœ°ç†åæ ‡ç±»å‹ã€æ—¥æœŸç±»å‹ç­‰ã€‚

### 2.1.1.æ™®é€šå­—æ®µæ’åº

keywordã€æ•°å€¼ã€æ—¥æœŸç±»å‹æ’åºçš„è¯­æ³•åŸºæœ¬ä¸€è‡´ã€‚

**è¯­æ³•**ï¼š

```json
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
Â Â "sort":Â [
Â Â Â Â {
Â Â Â Â Â Â "FIELD":Â "desc"Â Â //Â æ’åºå­—æ®µã€æ’åºæ–¹å¼ASCã€DESC
Â Â Â Â }
Â Â ]
}
```

æ’åºæ¡ä»¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å†™å¤šä¸ªæ’åºæ¡ä»¶ã€‚æŒ‰ç…§å£°æ˜çš„é¡ºåºï¼Œå½“ç¬¬ä¸€ä¸ªæ¡ä»¶ç›¸ç­‰æ—¶ï¼Œå†æŒ‰ç…§ç¬¬äºŒä¸ªæ¡ä»¶æ’åºï¼Œä»¥æ­¤ç±»æ¨



**ç¤ºä¾‹**ï¼š

éœ€æ±‚æè¿°ï¼šé…’åº—æ•°æ®æŒ‰ç…§ç”¨æˆ·è¯„ä»·ï¼ˆscore)é™åºæ’åºï¼Œè¯„ä»·ç›¸åŒçš„æŒ‰ç…§ä»·æ ¼(price)å‡åºæ’åº

![image-20210721195728306](https://cdn.fengxianhub.top/resources-master/202205172117721.png)



### 2.1.2.åœ°ç†åæ ‡æ’åº

åœ°ç†åæ ‡æ’åºç•¥æœ‰ä¸åŒã€‚

**è¯­æ³•è¯´æ˜**ï¼š

```json
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
Â Â "sort":Â [
Â Â Â Â {
Â Â Â Â Â Â "_geo_distance"Â :Â {
Â Â Â Â Â Â Â Â Â Â "FIELD"Â :Â "çº¬åº¦ï¼Œç»åº¦", // æ–‡æ¡£ä¸­geo_pointç±»å‹çš„å­—æ®µåã€ç›®æ ‡åæ ‡ç‚¹
Â Â Â Â Â Â Â Â Â Â "order"Â :Â "asc", // æ’åºæ–¹å¼
Â Â Â Â Â Â Â Â Â Â "unit"Â :Â "km" // æ’åºçš„è·ç¦»å•ä½
Â Â Â Â Â Â }
Â Â Â Â }
Â Â ]
}
```

è¿™ä¸ªæŸ¥è¯¢çš„å«ä¹‰æ˜¯ï¼š

- æŒ‡å®šä¸€ä¸ªåæ ‡ï¼Œä½œä¸ºç›®æ ‡ç‚¹
- è®¡ç®—æ¯ä¸€ä¸ªæ–‡æ¡£ä¸­ï¼ŒæŒ‡å®šå­—æ®µï¼ˆå¿…é¡»æ˜¯geo_pointç±»å‹ï¼‰çš„åæ ‡ åˆ°ç›®æ ‡ç‚¹çš„è·ç¦»æ˜¯å¤šå°‘
- æ ¹æ®è·ç¦»æ’åº



**ç¤ºä¾‹ï¼š**

éœ€æ±‚æè¿°ï¼šå®ç°å¯¹é…’åº—æ•°æ®æŒ‰ç…§åˆ°ä½ çš„ä½ç½®åæ ‡çš„è·ç¦»å‡åºæ’åº

æç¤ºï¼šè·å–ä½ çš„ä½ç½®çš„ç»çº¬åº¦çš„æ–¹å¼ï¼šhttps://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat/



å‡è®¾æˆ‘çš„ä½ç½®æ˜¯ï¼š31.034661ï¼Œ121.612282ï¼Œå¯»æ‰¾æˆ‘å‘¨å›´è·ç¦»æœ€è¿‘çš„é…’åº—ã€‚

![image-20210721200214690](https://cdn.fengxianhub.top/resources-master/202205172117062.png)





## 2.2.åˆ†é¡µ

elasticsearch é»˜è®¤æƒ…å†µä¸‹åªè¿”å›top10çš„æ•°æ®ã€‚è€Œå¦‚æœè¦æŸ¥è¯¢æ›´å¤šæ•°æ®å°±éœ€è¦ä¿®æ”¹åˆ†é¡µå‚æ•°äº†ã€‚elasticsearchä¸­é€šè¿‡ä¿®æ”¹fromã€sizeå‚æ•°æ¥æ§åˆ¶è¦è¿”å›çš„åˆ†é¡µç»“æœï¼š

- fromï¼šä»ç¬¬å‡ ä¸ªæ–‡æ¡£å¼€å§‹
- sizeï¼šæ€»å…±æŸ¥è¯¢å‡ ä¸ªæ–‡æ¡£

ç±»ä¼¼äºmysqlä¸­çš„`limit ?, ?`

### 2.2.1.åŸºæœ¬çš„åˆ†é¡µ

åˆ†é¡µçš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
Â Â "from":Â 0,Â //Â åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0
Â Â "size":Â 10,Â //Â æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°
Â Â "sort":Â [
Â Â Â Â {"price":Â "asc"}
Â Â ]
}
```





### 2.2.2.æ·±åº¦åˆ†é¡µé—®é¢˜

ç°åœ¨ï¼Œæˆ‘è¦æŸ¥è¯¢990~1000çš„æ•°æ®ï¼ŒæŸ¥è¯¢é€»è¾‘è¦è¿™ä¹ˆå†™ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
Â Â "from":Â 990,Â //Â åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0
Â Â "size":Â 10,Â //Â æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°
Â Â "sort":Â [
Â Â Â Â {"price":Â "asc"}
Â Â ]
}
```

è¿™é‡Œæ˜¯æŸ¥è¯¢990å¼€å§‹çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ ç¬¬990~ç¬¬1000æ¡ æ•°æ®ã€‚

ä¸è¿‡ï¼Œelasticsearchå†…éƒ¨åˆ†é¡µæ—¶ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢ 0~1000æ¡ï¼Œç„¶åæˆªå–å…¶ä¸­çš„990 ~ 1000çš„è¿™10æ¡ï¼š

![image-20210721200643029](https://cdn.fengxianhub.top/resources-master/202205172142753.png)



æŸ¥è¯¢TOP1000ï¼Œå¦‚æœesæ˜¯å•ç‚¹æ¨¡å¼ï¼Œè¿™å¹¶æ— å¤ªå¤§å½±å“ã€‚

ä½†æ˜¯elasticsearchå°†æ¥ä¸€å®šæ˜¯é›†ç¾¤ï¼Œä¾‹å¦‚æˆ‘é›†ç¾¤æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘è¦æŸ¥è¯¢TOP1000çš„æ•°æ®ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹æŸ¥è¯¢200æ¡å°±å¯ä»¥äº†ã€‚

å› ä¸ºèŠ‚ç‚¹Açš„TOP200ï¼Œåœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ’åˆ°10000åä»¥å¤–äº†ã€‚

å› æ­¤è¦æƒ³è·å–æ•´ä¸ªé›†ç¾¤çš„TOP1000ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„TOP1000ï¼Œæ±‡æ€»ç»“æœåï¼Œé‡æ–°æ’åï¼Œé‡æ–°æˆªå–TOP1000ã€‚

![image-20210721201003229](https://cdn.fengxianhub.top/resources-master/202205172209795.png)



é‚£å¦‚æœæˆ‘è¦æŸ¥è¯¢9900~10000çš„æ•°æ®å‘¢ï¼Ÿæ˜¯ä¸æ˜¯è¦å…ˆæŸ¥è¯¢TOP10000å‘¢ï¼Ÿé‚£æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦æŸ¥è¯¢10000æ¡ï¼Ÿæ±‡æ€»åˆ°å†…å­˜ä¸­ï¼Ÿ



å½“æŸ¥è¯¢åˆ†é¡µæ·±åº¦è¾ƒå¤§æ—¶ï¼Œæ±‡æ€»æ•°æ®è¿‡å¤šï¼Œå¯¹å†…å­˜å’ŒCPUä¼šäº§ç”Ÿéå¸¸å¤§çš„å‹åŠ›ï¼Œå› æ­¤elasticsearchä¼šç¦æ­¢from+ size è¶…è¿‡10000çš„è¯·æ±‚ã€‚



é’ˆå¯¹æ·±åº¦åˆ†é¡µï¼ŒESæä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œ[å®˜æ–¹æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html)ï¼š

- search afterï¼šåˆ†é¡µæ—¶éœ€è¦æ’åºï¼ŒåŸç†æ˜¯ä»ä¸Šä¸€æ¬¡çš„æ’åºå€¼å¼€å§‹ï¼ŒæŸ¥è¯¢ä¸‹ä¸€é¡µæ•°æ®ã€‚å®˜æ–¹æ¨èä½¿ç”¨çš„æ–¹å¼ã€‚
- scrollï¼šåŸç†å°†æ’åºåçš„æ–‡æ¡£idå½¢æˆå¿«ç…§ï¼Œä¿å­˜åœ¨å†…å­˜ã€‚å®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ã€‚



### 2.2.3.å°ç»“

åˆ†é¡µæŸ¥è¯¢çš„å¸¸è§å®ç°æ–¹æ¡ˆä»¥åŠä¼˜ç¼ºç‚¹ï¼š

- `from + size`ï¼š
  - ä¼˜ç‚¹ï¼šæ”¯æŒéšæœºç¿»é¡µ
  - ç¼ºç‚¹ï¼šæ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œé»˜è®¤æŸ¥è¯¢ä¸Šé™ï¼ˆfrom + sizeï¼‰æ˜¯10000
  - åœºæ™¯ï¼šç™¾åº¦ã€äº¬ä¸œã€è°·æ­Œã€æ·˜å®è¿™æ ·çš„éšæœºç¿»é¡µæœç´¢
- `after search`ï¼š
  - ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰
  - ç¼ºç‚¹ï¼šåªèƒ½å‘åé€é¡µæŸ¥è¯¢ï¼Œä¸æ”¯æŒéšæœºç¿»é¡µ
  - åœºæ™¯ï¼šæ²¡æœ‰éšæœºç¿»é¡µéœ€æ±‚çš„æœç´¢ï¼Œä¾‹å¦‚æ‰‹æœºå‘ä¸‹æ»šåŠ¨ç¿»é¡µ

- `scroll`ï¼š
  - ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰
  - ç¼ºç‚¹ï¼šä¼šæœ‰é¢å¤–å†…å­˜æ¶ˆè€—ï¼Œå¹¶ä¸”æœç´¢ç»“æœæ˜¯éå®æ—¶çš„
  - åœºæ™¯ï¼šæµ·é‡æ•°æ®çš„è·å–å’Œè¿ç§»ã€‚ä»ES7.1å¼€å§‹ä¸æ¨èï¼Œå»ºè®®ç”¨ after searchæ–¹æ¡ˆã€‚





## 2.3.é«˜äº®

### 2.3.1.é«˜äº®åŸç†

ä»€ä¹ˆæ˜¯é«˜äº®æ˜¾ç¤ºå‘¢ï¼Ÿ

æˆ‘ä»¬åœ¨ç™¾åº¦ï¼Œäº¬ä¸œæœç´¢æ—¶ï¼Œå…³é”®å­—ä¼šå˜æˆçº¢è‰²ï¼Œæ¯”è¾ƒé†’ç›®ï¼Œè¿™å«é«˜äº®æ˜¾ç¤ºï¼š

![image-20210721202705030](https://cdn.fengxianhub.top/resources-master/202205172218241.png)

é«˜äº®æ˜¾ç¤ºçš„å®ç°åˆ†ä¸ºä¸¤æ­¥ï¼š

- 1ï¼‰ç»™æ–‡æ¡£ä¸­çš„æ‰€æœ‰å…³é”®å­—éƒ½æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼Œä¾‹å¦‚`<em>`æ ‡ç­¾
- 2ï¼‰é¡µé¢ç»™`<em>`æ ‡ç­¾ç¼–å†™CSSæ ·å¼



### 2.3.2.å®ç°é«˜äº®

**é«˜äº®çš„è¯­æ³•**ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "match":Â {
Â Â Â Â Â Â "FIELD":Â "TEXT" // æŸ¥è¯¢æ¡ä»¶ï¼Œé«˜äº®ä¸€å®šè¦ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢
Â Â Â Â }
Â Â },
Â Â "highlight":Â {
Â Â Â Â "fields":Â {Â //Â æŒ‡å®šè¦é«˜äº®çš„å­—æ®µ
Â Â Â Â Â Â "FIELD":Â {
Â Â Â Â Â Â Â Â "pre_tags":Â "<em>",Â Â //Â ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„å‰ç½®æ ‡ç­¾
Â Â Â Â Â Â Â Â "post_tags":Â "</em>"Â //Â ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„åç½®æ ‡ç­¾
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```



**æ³¨æ„ï¼š**

- é«˜äº®æ˜¯å¯¹å…³é”®å­—é«˜äº®ï¼Œå› æ­¤**æœç´¢æ¡ä»¶å¿…é¡»å¸¦æœ‰å…³é”®å­—**ï¼Œè€Œä¸èƒ½æ˜¯èŒƒå›´è¿™æ ·çš„æŸ¥è¯¢ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼Œ**é«˜äº®çš„å­—æ®µï¼Œå¿…é¡»ä¸æœç´¢æŒ‡å®šçš„å­—æ®µä¸€è‡´**ï¼Œå¦åˆ™æ— æ³•é«˜äº®
- å¦‚æœè¦å¯¹éæœç´¢å­—æ®µé«˜äº®ï¼Œåˆ™éœ€è¦æ·»åŠ ä¸€ä¸ªå±æ€§ï¼šrequired_field_match=false



**ç¤ºä¾‹**ï¼š

![image-20210721203349633](https://cdn.fengxianhub.top/resources-master/202205172218525.png)





## 2.4.æ€»ç»“

æŸ¥è¯¢çš„DSLæ˜¯ä¸€ä¸ªå¤§çš„JSONå¯¹è±¡ï¼ŒåŒ…å«ä¸‹åˆ—å±æ€§ï¼š

- queryï¼šæŸ¥è¯¢æ¡ä»¶
- fromå’Œsizeï¼šåˆ†é¡µæ¡ä»¶
- sortï¼šæ’åºæ¡ä»¶
- highlightï¼šé«˜äº®æ¡ä»¶

ç¤ºä¾‹ï¼š

![image-20210721203657850](https://cdn.fengxianhub.top/resources-master/202205172218094.png)









# 3.RestClientæŸ¥è¯¢æ–‡æ¡£

æ–‡æ¡£çš„æŸ¥è¯¢åŒæ ·é€‚ç”¨æ˜¨å¤©å­¦ä¹ çš„ RestHighLevelClientå¯¹è±¡ï¼ŒåŸºæœ¬æ­¥éª¤åŒ…æ‹¬ï¼š

- 1ï¼‰å‡†å¤‡Requestå¯¹è±¡
- 2ï¼‰å‡†å¤‡è¯·æ±‚å‚æ•°
- 3ï¼‰å‘èµ·è¯·æ±‚
- 4ï¼‰è§£æå“åº”



## 3.1.å¿«é€Ÿå…¥é—¨

æˆ‘ä»¬ä»¥match_allæŸ¥è¯¢ä¸ºä¾‹

### 3.1.1.å‘èµ·æŸ¥è¯¢è¯·æ±‚

![image-20210721203950559](https://cdn.fengxianhub.top/resources-master/202205172218075.png)

ä»£ç è§£è¯»ï¼š

- ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º`SearchRequest`å¯¹è±¡ï¼ŒæŒ‡å®šç´¢å¼•åº“å

- ç¬¬äºŒæ­¥ï¼Œåˆ©ç”¨`request.source()`æ„å»ºDSLï¼ŒDSLä¸­å¯ä»¥åŒ…å«æŸ¥è¯¢ã€åˆ†é¡µã€æ’åºã€é«˜äº®ç­‰
  - `query()`ï¼šä»£è¡¨æŸ¥è¯¢æ¡ä»¶ï¼Œåˆ©ç”¨`QueryBuilders.matchAllQuery()`æ„å»ºä¸€ä¸ªmatch_allæŸ¥è¯¢çš„DSL
- ç¬¬ä¸‰æ­¥ï¼Œåˆ©ç”¨client.search()å‘é€è¯·æ±‚ï¼Œå¾—åˆ°å“åº”



è¿™é‡Œå…³é”®çš„APIæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯`request.source()`ï¼Œå…¶ä¸­åŒ…å«äº†æŸ¥è¯¢ã€æ’åºã€åˆ†é¡µã€é«˜äº®ç­‰æ‰€æœ‰åŠŸèƒ½ï¼š

![image-20210721215640790](https://cdn.fengxianhub.top/resources-master/202205172228147.png)

å¦ä¸€ä¸ªæ˜¯`QueryBuilders`ï¼Œå…¶ä¸­åŒ…å«matchã€termã€function_scoreã€boolç­‰å„ç§æŸ¥è¯¢ï¼š

![image-20210721215729236](https://cdn.fengxianhub.top/resources-master/202205172228741.png)



### 3.1.2.è§£æå“åº”

å“åº”ç»“æœçš„è§£æï¼š

![image-20210721214221057](https://cdn.fengxianhub.top/resources-master/202205172228547.png)



elasticsearchè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªJSONå­—ç¬¦ä¸²ï¼Œç»“æ„åŒ…å«ï¼š

- `hits`ï¼šå‘½ä¸­çš„ç»“æœ
  - `total`ï¼šæ€»æ¡æ•°ï¼Œå…¶ä¸­çš„valueæ˜¯å…·ä½“çš„æ€»æ¡æ•°å€¼
  - `max_score`ï¼šæ‰€æœ‰ç»“æœä¸­å¾—åˆ†æœ€é«˜çš„æ–‡æ¡£çš„ç›¸å…³æ€§ç®—åˆ†
  - `hits`ï¼šæœç´¢ç»“æœçš„æ–‡æ¡£æ•°ç»„ï¼Œå…¶ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½æ˜¯ä¸€ä¸ªjsonå¯¹è±¡
    - `_source`ï¼šæ–‡æ¡£ä¸­çš„åŸå§‹æ•°æ®ï¼Œä¹Ÿæ˜¯jsonå¯¹è±¡

å› æ­¤ï¼Œæˆ‘ä»¬è§£æå“åº”ç»“æœï¼Œå°±æ˜¯é€å±‚è§£æJSONå­—ç¬¦ä¸²ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

- `SearchHits`ï¼šé€šè¿‡response.getHits()è·å–ï¼Œå°±æ˜¯JSONä¸­çš„æœ€å¤–å±‚çš„hitsï¼Œä»£è¡¨å‘½ä¸­çš„ç»“æœ
  - `SearchHits#getTotalHits().value`ï¼šè·å–æ€»æ¡æ•°ä¿¡æ¯
  - `SearchHits#getHits()`ï¼šè·å–SearchHitæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ–‡æ¡£æ•°ç»„
    - `SearchHit#getSourceAsString()`ï¼šè·å–æ–‡æ¡£ç»“æœä¸­çš„_sourceï¼Œä¹Ÿå°±æ˜¯åŸå§‹çš„jsonæ–‡æ¡£æ•°æ®



### 3.1.3.å®Œæ•´ä»£ç 

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
@Test
void testMatchAll() throws IOException {
    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    request.source()
        .query(QueryBuilders.matchAllQuery());
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);

    // 4.è§£æå“åº”
    handleResponse(response);
}

private void handleResponse(SearchResponse response) {
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    // 4.1.è·å–æ€»æ¡æ•°
    long total = searchHits.getTotalHits().value;
    System.out.println("å…±æœç´¢åˆ°" + total + "æ¡æ•°æ®");
    // 4.2.æ–‡æ¡£æ•°ç»„
    SearchHit[] hits = searchHits.getHits();
    // 4.3.éå†
    for (SearchHit hit : hits) {
        // è·å–æ–‡æ¡£source
        String json = hit.getSourceAsString();
        // ååºåˆ—åŒ–
        HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);
        System.out.println("hotelDoc = " + hotelDoc);
    }
}
```



### 3.1.4.å°ç»“

æŸ¥è¯¢çš„åŸºæœ¬æ­¥éª¤æ˜¯ï¼š

1. åˆ›å»ºSearchRequestå¯¹è±¡

2. å‡†å¤‡Request.source()ï¼Œä¹Ÿå°±æ˜¯DSLã€‚

   â‘  QueryBuildersæ¥æ„å»ºæŸ¥è¯¢æ¡ä»¶

   â‘¡ ä¼ å…¥Request.source() çš„ query() æ–¹æ³•

3. å‘é€è¯·æ±‚ï¼Œå¾—åˆ°ç»“æœ

4. è§£æç»“æœï¼ˆå‚è€ƒJSONç»“æœï¼Œä»å¤–åˆ°å†…ï¼Œé€å±‚è§£æï¼‰





## 3.2.matchæŸ¥è¯¢

å…¨æ–‡æ£€ç´¢çš„matchå’Œmulti_matchæŸ¥è¯¢ä¸match_allçš„APIåŸºæœ¬ä¸€è‡´ã€‚å·®åˆ«æ˜¯æŸ¥è¯¢æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯queryçš„éƒ¨åˆ†ã€‚

![image-20210721215923060](https://cdn.fengxianhub.top/resources-master/202205181236746.png) 



å› æ­¤ï¼ŒJavaä»£ç ä¸Šçš„å·®å¼‚ä¸»è¦æ˜¯request.source().query()ä¸­çš„å‚æ•°äº†ã€‚åŒæ ·æ˜¯åˆ©ç”¨QueryBuildersæä¾›çš„æ–¹æ³•ï¼š

![image-20210721215843099](https://cdn.fengxianhub.top/resources-master/202205181236404.png) 

è€Œç»“æœè§£æä»£ç åˆ™å®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥æŠ½å–å¹¶å…±äº«ã€‚



å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
@Test
void testMatch() throws IOException {
    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    request.source()
        .query(QueryBuilders.matchQuery("all", "å¦‚å®¶"));
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    handleResponse(response);

}
```





## 3.3.ç²¾ç¡®æŸ¥è¯¢

ç²¾ç¡®æŸ¥è¯¢ä¸»è¦æ˜¯ä¸¤è€…ï¼š

- termï¼šè¯æ¡ç²¾ç¡®åŒ¹é…
- rangeï¼šèŒƒå›´æŸ¥è¯¢

ä¸ä¹‹å‰çš„æŸ¥è¯¢ç›¸æ¯”ï¼Œå·®å¼‚åŒæ ·åœ¨æŸ¥è¯¢æ¡ä»¶ï¼Œå…¶å®ƒéƒ½ä¸€æ ·ã€‚

æŸ¥è¯¢æ¡ä»¶æ„é€ çš„APIå¦‚ä¸‹ï¼š

![image-20210721220305140](https://cdn.fengxianhub.top/resources-master/202205181236035.png) 





## 3.4.å¸ƒå°”æŸ¥è¯¢

å¸ƒå°”æŸ¥è¯¢æ˜¯ç”¨mustã€must_notã€filterç­‰æ–¹å¼ç»„åˆå…¶å®ƒæŸ¥è¯¢ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

![image-20210721220927286](https://cdn.fengxianhub.top/resources-master/202205181236156.png)



å¯ä»¥çœ‹åˆ°ï¼ŒAPIä¸å…¶å®ƒæŸ¥è¯¢çš„å·®åˆ«åŒæ ·æ˜¯åœ¨æŸ¥è¯¢æ¡ä»¶çš„æ„å»ºï¼ŒQueryBuildersï¼Œç»“æœè§£æç­‰å…¶ä»–ä»£ç å®Œå…¨ä¸å˜ã€‚



å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
@Test
void testBool() throws IOException {
    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    // 2.1.å‡†å¤‡BooleanQuery
    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
    // 2.2.æ·»åŠ term
    boolQuery.must(QueryBuilders.termQuery("city", "æ­å·"));
    // 2.3.æ·»åŠ range
    boolQuery.filter(QueryBuilders.rangeQuery("price").lte(250));

    request.source().query(boolQuery);
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    handleResponse(response);

}
```



## 3.5.æ’åºã€åˆ†é¡µ

æœç´¢ç»“æœçš„æ’åºå’Œåˆ†é¡µæ˜¯ä¸queryåŒçº§çš„å‚æ•°ï¼Œå› æ­¤åŒæ ·æ˜¯ä½¿ç”¨request.source()æ¥è®¾ç½®ã€‚

å¯¹åº”çš„APIå¦‚ä¸‹ï¼š

![image-20210721221121266](https://cdn.fengxianhub.top/resources-master/202205251733003.png)

å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š

```java
@Test
void testPageAndSort() throws IOException {
    // é¡µç ï¼Œæ¯é¡µå¤§å°
    int page = 1, size = 5;

    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    // 2.1.query
    request.source().query(QueryBuilders.matchAllQuery());
    // 2.2.æ’åº sort
    request.source().sort("price", SortOrder.ASC);
    // 2.3.åˆ†é¡µ fromã€size
    request.source().from((page - 1) * size).size(5);
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    handleResponse(response);

}
```



## 3.6.é«˜äº®

é«˜äº®çš„ä»£ç ä¸ä¹‹å‰ä»£ç å·®å¼‚è¾ƒå¤§ï¼Œæœ‰ä¸¤ç‚¹ï¼š

- æŸ¥è¯¢çš„DSLï¼šå…¶ä¸­é™¤äº†æŸ¥è¯¢æ¡ä»¶ï¼Œè¿˜éœ€è¦æ·»åŠ é«˜äº®æ¡ä»¶ï¼ŒåŒæ ·æ˜¯ä¸queryåŒçº§ã€‚
- ç»“æœè§£æï¼šç»“æœé™¤äº†è¦è§£æ_sourceæ–‡æ¡£æ•°æ®ï¼Œè¿˜è¦è§£æé«˜äº®ç»“æœ

### 3.6.1.é«˜äº®è¯·æ±‚æ„å»º

é«˜äº®è¯·æ±‚çš„æ„å»ºAPIå¦‚ä¸‹ï¼š

![image-20210721221744883](https://cdn.fengxianhub.top/resources-master/202205251733138.png)

ä¸Šè¿°ä»£ç çœç•¥äº†æŸ¥è¯¢æ¡ä»¶éƒ¨åˆ†ï¼Œä½†æ˜¯å¤§å®¶ä¸è¦å¿˜äº†ï¼šé«˜äº®æŸ¥è¯¢å¿…é¡»ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œå¹¶ä¸”è¦æœ‰æœç´¢å…³é”®å­—ï¼Œå°†æ¥æ‰å¯ä»¥å¯¹å…³é”®å­—é«˜äº®ã€‚

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
@Test
void testHighlight() throws IOException {
    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    // 2.1.query
    request.source().query(QueryBuilders.matchQuery("all", "å¦‚å®¶"));
    // 2.2.é«˜äº®
    request.source().highlighter(new HighlightBuilder().field("name").requireFieldMatch(false));
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    handleResponse(response);

}
```



### 3.6.2.é«˜äº®ç»“æœè§£æ

é«˜äº®çš„ç»“æœä¸æŸ¥è¯¢çš„æ–‡æ¡£ç»“æœé»˜è®¤æ˜¯åˆ†ç¦»çš„ï¼Œå¹¶ä¸åœ¨ä¸€èµ·ã€‚

å› æ­¤è§£æé«˜äº®çš„ä»£ç éœ€è¦é¢å¤–å¤„ç†ï¼š

![image-20210721222057212](https://cdn.fengxianhub.top/resources-master/202205251733094.png)

ä»£ç è§£è¯»ï¼š

- ç¬¬ä¸€æ­¥ï¼šä»ç»“æœä¸­è·å–sourceã€‚hit.getSourceAsString()ï¼Œè¿™éƒ¨åˆ†æ˜¯éé«˜äº®ç»“æœï¼Œjsonå­—ç¬¦ä¸²ã€‚è¿˜éœ€è¦ååºåˆ—ä¸ºHotelDocå¯¹è±¡
- ç¬¬äºŒæ­¥ï¼šè·å–é«˜äº®ç»“æœã€‚hit.getHighlightFields()ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªMapï¼Œkeyæ˜¯é«˜äº®å­—æ®µåç§°ï¼Œå€¼æ˜¯HighlightFieldå¯¹è±¡ï¼Œä»£è¡¨é«˜äº®å€¼
- ç¬¬ä¸‰æ­¥ï¼šä»mapä¸­æ ¹æ®é«˜äº®å­—æ®µåç§°ï¼Œè·å–é«˜äº®å­—æ®µå€¼å¯¹è±¡HighlightField
- ç¬¬å››æ­¥ï¼šä»HighlightFieldä¸­è·å–Fragmentsï¼Œå¹¶ä¸”è½¬ä¸ºå­—ç¬¦ä¸²ã€‚è¿™éƒ¨åˆ†å°±æ˜¯çœŸæ­£çš„é«˜äº®å­—ç¬¦ä¸²äº†
- ç¬¬äº”æ­¥ï¼šç”¨é«˜äº®çš„ç»“æœæ›¿æ¢HotelDocä¸­çš„éé«˜äº®ç»“æœ



å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
private void handleResponse(SearchResponse response) {
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    // 4.1.è·å–æ€»æ¡æ•°
    long total = searchHits.getTotalHits().value;
    System.out.println("å…±æœç´¢åˆ°" + total + "æ¡æ•°æ®");
    // 4.2.æ–‡æ¡£æ•°ç»„
    SearchHit[] hits = searchHits.getHits();
    // 4.3.éå†
    for (SearchHit hit : hits) {
        // è·å–æ–‡æ¡£source
        String json = hit.getSourceAsString();
        // ååºåˆ—åŒ–
        HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);
        // è·å–é«˜äº®ç»“æœ
        Map<String, HighlightField> highlightFields = hit.getHighlightFields();
        if (!CollectionUtils.isEmpty(highlightFields)) {
            // æ ¹æ®å­—æ®µåè·å–é«˜äº®ç»“æœ
            HighlightField highlightField = highlightFields.get("name");
            if (highlightField != null) {
                // è·å–é«˜äº®å€¼
                String name = highlightField.getFragments()[0].string();
                // è¦†ç›–éé«˜äº®ç»“æœ
                hotelDoc.setName(name);
            }
        }
        System.out.println("hotelDoc = " + hotelDoc);
    }
}
```





# 4.é»‘é©¬æ—…æ¸¸æ¡ˆä¾‹

ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡é»‘é©¬æ—…æ¸¸çš„æ¡ˆä¾‹æ¥å®æˆ˜æ¼”ç»ƒä¸‹ä¹‹å‰å­¦ä¹ çš„çŸ¥è¯†ã€‚

æˆ‘ä»¬å®ç°å››éƒ¨åˆ†åŠŸèƒ½ï¼š

- é…’åº—æœç´¢å’Œåˆ†é¡µ
- é…’åº—ç»“æœè¿‡æ»¤
- æˆ‘å‘¨è¾¹çš„é…’åº—
- é…’åº—ç«ä»·æ’å



å¯åŠ¨æˆ‘ä»¬æä¾›çš„hotel-demoé¡¹ç›®ï¼Œå…¶é»˜è®¤ç«¯å£æ˜¯8089ï¼Œè®¿é—®http://localhost:8090ï¼Œå°±èƒ½çœ‹åˆ°é¡¹ç›®é¡µé¢äº†ï¼š

![image-20210721223159598](https://cdn.fengxianhub.top/resources-master/202205251735193.png)





## 4.1.é…’åº—æœç´¢å’Œåˆ†é¡µ

æ¡ˆä¾‹éœ€æ±‚ï¼šå®ç°é»‘é©¬æ—…æ¸¸çš„é…’åº—æœç´¢åŠŸèƒ½ï¼Œå®Œæˆå…³é”®å­—æœç´¢å’Œåˆ†é¡µ

### 4.1.1.éœ€æ±‚åˆ†æ

åœ¨é¡¹ç›®çš„é¦–é¡µï¼Œæœ‰ä¸€ä¸ªå¤§å¤§çš„æœç´¢æ¡†ï¼Œè¿˜æœ‰åˆ†é¡µæŒ‰é’®ï¼š

![image-20210721223859419](https://cdn.fengxianhub.top/resources-master/202205251735191.png)

ç‚¹å‡»æœç´¢æŒ‰é’®ï¼Œå¯ä»¥çœ‹åˆ°æµè§ˆå™¨æ§åˆ¶å°å‘å‡ºäº†è¯·æ±‚ï¼š

![image-20210721224033789](https://cdn.fengxianhub.top/resources-master/202205251735203.png)

è¯·æ±‚å‚æ•°å¦‚ä¸‹ï¼š

![image-20210721224112708](https://cdn.fengxianhub.top/resources-master/202205251735205.png)



ç”±æ­¤å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬è¿™ä¸ªè¯·æ±‚çš„ä¿¡æ¯å¦‚ä¸‹ï¼š

- è¯·æ±‚æ–¹å¼ï¼šPOST
- è¯·æ±‚è·¯å¾„ï¼š/hotel/list
- è¯·æ±‚å‚æ•°ï¼šJSONå¯¹è±¡ï¼ŒåŒ…å«4ä¸ªå­—æ®µï¼š
  - keyï¼šæœç´¢å…³é”®å­—
  - pageï¼šé¡µç 
  - sizeï¼šæ¯é¡µå¤§å°
  - sortByï¼šæ’åºï¼Œç›®å‰æš‚ä¸å®ç°
- è¿”å›å€¼ï¼šåˆ†é¡µæŸ¥è¯¢ï¼Œéœ€è¦è¿”å›åˆ†é¡µç»“æœPageResultï¼ŒåŒ…å«ä¸¤ä¸ªå±æ€§ï¼š
  - `total`ï¼šæ€»æ¡æ•°
  - `List<HotelDoc>`ï¼šå½“å‰é¡µçš„æ•°æ®



å› æ­¤ï¼Œæˆ‘ä»¬å®ç°ä¸šåŠ¡çš„æµç¨‹å¦‚ä¸‹ï¼š

- æ­¥éª¤ä¸€ï¼šå®šä¹‰å®ä½“ç±»ï¼Œæ¥æ”¶è¯·æ±‚å‚æ•°çš„JSONå¯¹è±¡
- æ­¥éª¤äºŒï¼šç¼–å†™controllerï¼Œæ¥æ”¶é¡µé¢çš„è¯·æ±‚
- æ­¥éª¤ä¸‰ï¼šç¼–å†™ä¸šåŠ¡å®ç°ï¼Œåˆ©ç”¨RestHighLevelClientå®ç°æœç´¢ã€åˆ†é¡µ



### 4.1.2.å®šä¹‰å®ä½“ç±»

å®ä½“ç±»æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯å‰ç«¯çš„è¯·æ±‚å‚æ•°å®ä½“ï¼Œä¸€ä¸ªæ˜¯æœåŠ¡ç«¯åº”è¯¥è¿”å›çš„å“åº”ç»“æœå®ä½“ã€‚

1ï¼‰è¯·æ±‚å‚æ•°

å‰ç«¯è¯·æ±‚çš„jsonç»“æ„å¦‚ä¸‹ï¼š

```json
{
    "key": "æœç´¢å…³é”®å­—",
    "page": 1,
    "size": 3,
    "sortBy": "default"
}
```

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨`cn.itcast.hotel.pojo`åŒ…ä¸‹å®šä¹‰ä¸€ä¸ªå®ä½“ç±»ï¼š

```java
package cn.itcast.hotel.pojo;

import lombok.Data;

@Data
public class RequestParams {
    private String key;
    private Integer page;
    private Integer size;
    private String sortBy;
}
```



2ï¼‰è¿”å›å€¼

åˆ†é¡µæŸ¥è¯¢ï¼Œéœ€è¦è¿”å›åˆ†é¡µç»“æœPageResultï¼ŒåŒ…å«ä¸¤ä¸ªå±æ€§ï¼š

- `total`ï¼šæ€»æ¡æ•°
- `List<HotelDoc>`ï¼šå½“å‰é¡µçš„æ•°æ®

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨`cn.itcast.hotel.pojo`ä¸­å®šä¹‰è¿”å›ç»“æœï¼š

```java
package cn.itcast.hotel.pojo;

import lombok.Data;

import java.util.List;

@Data
public class PageResult {
    private Long total;
    private List<HotelDoc> hotels;

    public PageResult() {
    }

    public PageResult(Long total, List<HotelDoc> hotels) {
        this.total = total;
        this.hotels = hotels;
    }
}
```



### 4.1.3.å®šä¹‰controller

å®šä¹‰ä¸€ä¸ªHotelControllerï¼Œå£°æ˜æŸ¥è¯¢æ¥å£ï¼Œæ»¡è¶³ä¸‹åˆ—è¦æ±‚ï¼š

- è¯·æ±‚æ–¹å¼ï¼šPost
- è¯·æ±‚è·¯å¾„ï¼š/hotel/list
- è¯·æ±‚å‚æ•°ï¼šå¯¹è±¡ï¼Œç±»å‹ä¸ºRequestParam
- è¿”å›å€¼ï¼šPageResultï¼ŒåŒ…å«ä¸¤ä¸ªå±æ€§
  - `Long total`ï¼šæ€»æ¡æ•°
  - `List<HotelDoc> hotels`ï¼šé…’åº—æ•°æ®



å› æ­¤ï¼Œæˆ‘ä»¬åœ¨`cn.itcast.hotel.web`ä¸­å®šä¹‰HotelControllerï¼š

```java
@RestController
@RequestMapping("/hotel")
public class HotelController {

    @Autowired
    private IHotelService hotelService;
	// æœç´¢é…’åº—æ•°æ®
    @PostMapping("/list")
    public PageResult search(@RequestBody RequestParams params){
        return hotelService.search(params);
    }
}
```



### 4.1.4.å®ç°æœç´¢ä¸šåŠ¡

æˆ‘ä»¬åœ¨controllerè°ƒç”¨äº†IHotelServiceï¼Œå¹¶æ²¡æœ‰å®ç°è¯¥æ–¹æ³•ï¼Œå› æ­¤ä¸‹é¢æˆ‘ä»¬å°±åœ¨IHotelServiceä¸­å®šä¹‰æ–¹æ³•ï¼Œå¹¶ä¸”å»å®ç°ä¸šåŠ¡é€»è¾‘ã€‚

1ï¼‰åœ¨`cn.itcast.hotel.service`ä¸­çš„`IHotelService`æ¥å£ä¸­å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼š

```java
/**
 * æ ¹æ®å…³é”®å­—æœç´¢é…’åº—ä¿¡æ¯
 * @param params è¯·æ±‚å‚æ•°å¯¹è±¡ï¼ŒåŒ…å«ç”¨æˆ·è¾“å…¥çš„å…³é”®å­— 
 * @return é…’åº—æ–‡æ¡£åˆ—è¡¨
 */
PageResult search(RequestParams params);
```



2ï¼‰å®ç°æœç´¢ä¸šåŠ¡ï¼Œè‚¯å®šç¦»ä¸å¼€RestHighLevelClientï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒæ³¨å†Œåˆ°Springä¸­ä½œä¸ºä¸€ä¸ªBeanã€‚åœ¨`cn.itcast.hotel`ä¸­çš„`HotelDemoApplication`ä¸­å£°æ˜è¿™ä¸ªBeanï¼š

```java
@Bean
public RestHighLevelClient client(){
    return  new RestHighLevelClient(RestClient.builder(
        HttpHost.create("http://192.168.150.101:9200")
    ));
}
```





3ï¼‰åœ¨`cn.itcast.hotel.service.impl`ä¸­çš„`HotelService`ä¸­å®ç°searchæ–¹æ³•ï¼š

```java
@Override
public PageResult search(RequestParams params) {
    try {
        // 1.å‡†å¤‡Request
        SearchRequest request = new SearchRequest("hotel");
        // 2.å‡†å¤‡DSL
        // 2.1.query
        String key = params.getKey();
        if (key == null || "".equals(key)) {
            boolQuery.must(QueryBuilders.matchAllQuery());
        } else {
            boolQuery.must(QueryBuilders.matchQuery("all", key));
        }

        // 2.2.åˆ†é¡µ
        int page = params.getPage();
        int size = params.getSize();
        request.source().from((page - 1) * size).size(size);

        // 3.å‘é€è¯·æ±‚
        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        // 4.è§£æå“åº”
        return handleResponse(response);
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}

// ç»“æœè§£æ
private PageResult handleResponse(SearchResponse response) {
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    // 4.1.è·å–æ€»æ¡æ•°
    long total = searchHits.getTotalHits().value;
    // 4.2.æ–‡æ¡£æ•°ç»„
    SearchHit[] hits = searchHits.getHits();
    // 4.3.éå†
    List<HotelDoc> hotels = new ArrayList<>();
    for (SearchHit hit : hits) {
        // è·å–æ–‡æ¡£source
        String json = hit.getSourceAsString();
        // ååºåˆ—åŒ–
        HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);
		// æ”¾å…¥é›†åˆ
        hotels.add(hotelDoc);
    }
    // 4.4.å°è£…è¿”å›
    return new PageResult(total, hotels);
}
```





## 4.2.é…’åº—ç»“æœè¿‡æ»¤

éœ€æ±‚ï¼šæ·»åŠ å“ç‰Œã€åŸå¸‚ã€æ˜Ÿçº§ã€ä»·æ ¼ç­‰è¿‡æ»¤åŠŸèƒ½

### 4.2.1.éœ€æ±‚åˆ†æ

åœ¨é¡µé¢æœç´¢æ¡†ä¸‹é¢ï¼Œä¼šæœ‰ä¸€äº›è¿‡æ»¤é¡¹ï¼š

![image-20210722091940726](https://cdn.fengxianhub.top/resources-master/202205251735206.png)

ä¼ é€’çš„å‚æ•°å¦‚å›¾ï¼š

![image-20210722092051994](https://cdn.fengxianhub.top/resources-master/202205251735223.png) 

åŒ…å«çš„è¿‡æ»¤æ¡ä»¶æœ‰ï¼š

- brandï¼šå“ç‰Œå€¼
- cityï¼šåŸå¸‚
- minPrice~maxPriceï¼šä»·æ ¼èŒƒå›´
- starNameï¼šæ˜Ÿçº§

æˆ‘ä»¬éœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š

- ä¿®æ”¹è¯·æ±‚å‚æ•°çš„å¯¹è±¡RequestParamsï¼Œæ¥æ”¶ä¸Šè¿°å‚æ•°
- ä¿®æ”¹ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨æœç´¢æ¡ä»¶ä¹‹å¤–ï¼Œæ·»åŠ ä¸€äº›è¿‡æ»¤æ¡ä»¶



### 4.2.2.ä¿®æ”¹å®ä½“ç±»

ä¿®æ”¹åœ¨`cn.itcast.hotel.pojo`åŒ…ä¸‹çš„å®ä½“ç±»RequestParamsï¼š

```java
@Data
public class RequestParams {
    private String key;
    private Integer page;
    private Integer size;
    private String sortBy;
    // ä¸‹é¢æ˜¯æ–°å¢çš„è¿‡æ»¤æ¡ä»¶å‚æ•°
    private String city;
    private String brand;
    private String starName;
    private Integer minPrice;
    private Integer maxPrice;
}
```



### 4.2.3.ä¿®æ”¹æœç´¢ä¸šåŠ¡

åœ¨HotelServiceçš„searchæ–¹æ³•ä¸­ï¼Œåªæœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦ä¿®æ”¹ï¼šrequet.source().query( ... )å…¶ä¸­çš„æŸ¥è¯¢æ¡ä»¶ã€‚

åœ¨ä¹‹å‰çš„ä¸šåŠ¡ä¸­ï¼Œåªæœ‰matchæŸ¥è¯¢ï¼Œæ ¹æ®å…³é”®å­—æœç´¢ï¼Œç°åœ¨è¦æ·»åŠ æ¡ä»¶è¿‡æ»¤ï¼ŒåŒ…æ‹¬ï¼š

- å“ç‰Œè¿‡æ»¤ï¼šæ˜¯keywordç±»å‹ï¼Œç”¨termæŸ¥è¯¢
- æ˜Ÿçº§è¿‡æ»¤ï¼šæ˜¯keywordç±»å‹ï¼Œç”¨termæŸ¥è¯¢
- ä»·æ ¼è¿‡æ»¤ï¼šæ˜¯æ•°å€¼ç±»å‹ï¼Œç”¨rangeæŸ¥è¯¢
- åŸå¸‚è¿‡æ»¤ï¼šæ˜¯keywordç±»å‹ï¼Œç”¨termæŸ¥è¯¢

å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ç»„åˆï¼Œè‚¯å®šæ˜¯booleanæŸ¥è¯¢æ¥ç»„åˆï¼š

- å…³é”®å­—æœç´¢æ”¾åˆ°mustä¸­ï¼Œå‚ä¸ç®—åˆ†
- å…¶å®ƒè¿‡æ»¤æ¡ä»¶æ”¾åˆ°filterä¸­ï¼Œä¸å‚ä¸ç®—åˆ†



å› ä¸ºæ¡ä»¶æ„å»ºçš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œå…ˆå°è£…ä¸ºä¸€ä¸ªå‡½æ•°ï¼š

![image-20210722092935453](https://cdn.fengxianhub.top/resources-master/202205251735584.png)



buildBasicQueryçš„ä»£ç å¦‚ä¸‹ï¼š

```java
private void buildBasicQuery(RequestParams params, SearchRequest request) {
    // 1.æ„å»ºBooleanQuery
    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
    // 2.å…³é”®å­—æœç´¢
    String key = params.getKey();
    if (key == null || "".equals(key)) {
        boolQuery.must(QueryBuilders.matchAllQuery());
    } else {
        boolQuery.must(QueryBuilders.matchQuery("all", key));
    }
    // 3.åŸå¸‚æ¡ä»¶
    if (params.getCity() != null && !params.getCity().equals("")) {
        boolQuery.filter(QueryBuilders.termQuery("city", params.getCity()));
    }
    // 4.å“ç‰Œæ¡ä»¶
    if (params.getBrand() != null && !params.getBrand().equals("")) {
        boolQuery.filter(QueryBuilders.termQuery("brand", params.getBrand()));
    }
    // 5.æ˜Ÿçº§æ¡ä»¶
    if (params.getStarName() != null && !params.getStarName().equals("")) {
        boolQuery.filter(QueryBuilders.termQuery("starName", params.getStarName()));
    }
	// 6.ä»·æ ¼
    if (params.getMinPrice() != null && params.getMaxPrice() != null) {
        boolQuery.filter(QueryBuilders
                         .rangeQuery("price")
                         .gte(params.getMinPrice())
                         .lte(params.getMaxPrice())
                        );
    }
	// 7.æ”¾å…¥source
    request.source().query(boolQuery);
}
```





## 4.3.æˆ‘å‘¨è¾¹çš„é…’åº—

éœ€æ±‚ï¼šæˆ‘é™„è¿‘çš„é…’åº—

### 4.3.1.éœ€æ±‚åˆ†æ

åœ¨é…’åº—åˆ—è¡¨é¡µçš„å³ä¾§ï¼Œæœ‰ä¸€ä¸ªå°åœ°å›¾ï¼Œç‚¹å‡»åœ°å›¾çš„å®šä½æŒ‰é’®ï¼Œåœ°å›¾ä¼šæ‰¾åˆ°ä½ æ‰€åœ¨çš„ä½ç½®ï¼š

![image-20210722093414542](https://cdn.fengxianhub.top/resources-master/202205251735012.png) 

å¹¶ä¸”ï¼Œåœ¨å‰ç«¯ä¼šå‘èµ·æŸ¥è¯¢è¯·æ±‚ï¼Œå°†ä½ çš„åæ ‡å‘é€åˆ°æœåŠ¡ç«¯ï¼š

![image-20210722093642382](https://cdn.fengxianhub.top/resources-master/202205251735033.png) 



æˆ‘ä»¬è¦åšçš„äº‹æƒ…å°±æ˜¯åŸºäºè¿™ä¸ªlocationåæ ‡ï¼Œç„¶åæŒ‰ç…§è·ç¦»å¯¹å‘¨å›´é…’åº—æ’åºã€‚å®ç°æ€è·¯å¦‚ä¸‹ï¼š

- ä¿®æ”¹RequestParamså‚æ•°ï¼Œæ¥æ”¶locationå­—æ®µ
- ä¿®æ”¹searchæ–¹æ³•ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚æœlocationæœ‰å€¼ï¼Œæ·»åŠ æ ¹æ®geo_distanceæ’åºçš„åŠŸèƒ½



### 4.3.2.ä¿®æ”¹å®ä½“ç±»

ä¿®æ”¹åœ¨`cn.itcast.hotel.pojo`åŒ…ä¸‹çš„å®ä½“ç±»RequestParamsï¼š

```java
package cn.itcast.hotel.pojo;

import lombok.Data;

@Data
public class RequestParams {
    private String key;
    private Integer page;
    private Integer size;
    private String sortBy;
    private String city;
    private String brand;
    private String starName;
    private Integer minPrice;
    private Integer maxPrice;
    // æˆ‘å½“å‰çš„åœ°ç†åæ ‡
    private String location;
}

```



### 4.3.3.è·ç¦»æ’åºAPI

æˆ‘ä»¬ä»¥å‰å­¦ä¹ è¿‡æ’åºåŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¸¤ç§ï¼š

- æ™®é€šå­—æ®µæ’åº
- åœ°ç†åæ ‡æ’åº

æˆ‘ä»¬åªè®²äº†æ™®é€šå­—æ®µæ’åºå¯¹åº”çš„javaå†™æ³•ã€‚åœ°ç†åæ ‡æ’åºåªå­¦è¿‡DSLè¯­æ³•ï¼Œå¦‚ä¸‹ï¼š

```json
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
 Â "sort":Â [
Â Â Â Â {
Â Â Â Â Â Â "price":Â "asc"Â Â 
Â Â Â Â },
Â Â Â Â {
Â Â Â Â Â Â "_geo_distance"Â :Â {
Â Â Â Â Â Â Â Â Â Â "FIELD"Â :Â "çº¬åº¦ï¼Œç»åº¦",
Â Â Â Â Â Â Â Â Â Â "order"Â :Â "asc",
Â Â Â Â Â Â Â Â Â Â "unit"Â :Â "km"
Â Â Â Â Â Â }
Â Â Â Â }
Â Â ]
}
```

å¯¹åº”çš„javaä»£ç ç¤ºä¾‹ï¼š

![image-20210722095227059](https://cdn.fengxianhub.top/resources-master/202205251735051.png)





### 4.3.4.æ·»åŠ è·ç¦»æ’åº

åœ¨`cn.itcast.hotel.service.impl`çš„`HotelService`çš„`search`æ–¹æ³•ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæ’åºåŠŸèƒ½ï¼š

![image-20210722095902314](https://cdn.fengxianhub.top/resources-master/202205251735060.png)



å®Œæ•´ä»£ç ï¼š

```java
@Override
public PageResult search(RequestParams params) {
    try {
        // 1.å‡†å¤‡Request
        SearchRequest request = new SearchRequest("hotel");
        // 2.å‡†å¤‡DSL
        // 2.1.query
        buildBasicQuery(params, request);

        // 2.2.åˆ†é¡µ
        int page = params.getPage();
        int size = params.getSize();
        request.source().from((page - 1) * size).size(size);

        // 2.3.æ’åº
        String location = params.getLocation();
        if (location != null && !location.equals("")) {
            request.source().sort(SortBuilders
                                  .geoDistanceSort("location", new GeoPoint(location))
                                  .order(SortOrder.ASC)
                                  .unit(DistanceUnit.KILOMETERS)
                                 );
        }

        // 3.å‘é€è¯·æ±‚
        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        // 4.è§£æå“åº”
        return handleResponse(response);
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}
```



### 4.3.5.æ’åºè·ç¦»æ˜¾ç¤º

é‡å¯æœåŠ¡åï¼Œæµ‹è¯•æˆ‘çš„é…’åº—åŠŸèƒ½ï¼š

![image-20210722100040674](https://cdn.fengxianhub.top/resources-master/202205251735077.png)



å‘ç°ç¡®å®å¯ä»¥å®ç°å¯¹æˆ‘é™„è¿‘é…’åº—çš„æ’åºï¼Œä¸è¿‡å¹¶æ²¡æœ‰çœ‹åˆ°é…’åº—åˆ°åº•è·ç¦»æˆ‘å¤šè¿œï¼Œè¿™è¯¥æ€ä¹ˆåŠï¼Ÿ



æ’åºå®Œæˆåï¼Œé¡µé¢è¿˜è¦è·å–æˆ‘é™„è¿‘æ¯ä¸ªé…’åº—çš„å…·ä½“**è·ç¦»**å€¼ï¼Œè¿™ä¸ªå€¼åœ¨å“åº”ç»“æœä¸­æ˜¯ç‹¬ç«‹çš„ï¼š

![image-20210722095648542](https://cdn.fengxianhub.top/resources-master/202205251735445.png)

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ç»“æœè§£æé˜¶æ®µï¼Œé™¤äº†è§£æsourceéƒ¨åˆ†ä»¥å¤–ï¼Œè¿˜è¦å¾—åˆ°sortéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æ’åºçš„è·ç¦»ï¼Œç„¶åæ”¾åˆ°å“åº”ç»“æœä¸­ã€‚

æˆ‘ä»¬è¦åšä¸¤ä»¶äº‹ï¼š

- ä¿®æ”¹HotelDocï¼Œæ·»åŠ æ’åºè·ç¦»å­—æ®µï¼Œç”¨äºé¡µé¢æ˜¾ç¤º
- ä¿®æ”¹HotelServiceç±»ä¸­çš„handleResponseæ–¹æ³•ï¼Œæ·»åŠ å¯¹sortå€¼çš„è·å–



1ï¼‰ä¿®æ”¹HotelDocç±»ï¼Œæ·»åŠ è·ç¦»å­—æ®µ

```java
package cn.itcast.hotel.pojo;

import lombok.Data;
import lombok.NoArgsConstructor;


@Data
@NoArgsConstructor
public class HotelDoc {
    private Long id;
    private String name;
    private String address;
    private Integer price;
    private Integer score;
    private String brand;
    private String city;
    private String starName;
    private String business;
    private String location;
    private String pic;
    // æ’åºæ—¶çš„ è·ç¦»å€¼
    private Object distance;

    public HotelDoc(Hotel hotel) {
        this.id = hotel.getId();
        this.name = hotel.getName();
        this.address = hotel.getAddress();
        this.price = hotel.getPrice();
        this.score = hotel.getScore();
        this.brand = hotel.getBrand();
        this.city = hotel.getCity();
        this.starName = hotel.getStarName();
        this.business = hotel.getBusiness();
        this.location = hotel.getLatitude() + ", " + hotel.getLongitude();
        this.pic = hotel.getPic();
    }
}

```



2ï¼‰ä¿®æ”¹HotelServiceä¸­çš„handleResponseæ–¹æ³•

![image-20210722100613966](https://cdn.fengxianhub.top/resources-master/202205251735142.png)



é‡å¯åæµ‹è¯•ï¼Œå‘ç°é¡µé¢èƒ½æˆåŠŸæ˜¾ç¤ºè·ç¦»äº†ï¼š

![image-20210722100838604](https://cdn.fengxianhub.top/resources-master/202205251735158.png)





## 4.4.é…’åº—ç«ä»·æ’å

éœ€æ±‚ï¼šè®©æŒ‡å®šçš„é…’åº—åœ¨æœç´¢ç»“æœä¸­æ’åç½®é¡¶

### 4.4.1.éœ€æ±‚åˆ†æ

è¦è®©æŒ‡å®šé…’åº—åœ¨æœç´¢ç»“æœä¸­æ’åç½®é¡¶ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![image-20210722100947292](https://cdn.fengxianhub.top/resources-master/202205251735171.png)

é¡µé¢ä¼šç»™æŒ‡å®šçš„é…’åº—æ·»åŠ **å¹¿å‘Š**æ ‡è®°ã€‚



é‚£æ€æ ·æ‰èƒ½è®©æŒ‡å®šçš„é…’åº—æ’åç½®é¡¶å‘¢ï¼Ÿ



æˆ‘ä»¬ä¹‹å‰å­¦ä¹ è¿‡çš„function_scoreæŸ¥è¯¢å¯ä»¥å½±å“ç®—åˆ†ï¼Œç®—åˆ†é«˜äº†ï¼Œè‡ªç„¶æ’åä¹Ÿå°±é«˜äº†ã€‚è€Œfunction_scoreåŒ…å«3ä¸ªè¦ç´ ï¼š

- è¿‡æ»¤æ¡ä»¶ï¼šå“ªäº›æ–‡æ¡£è¦åŠ åˆ†
- ç®—åˆ†å‡½æ•°ï¼šå¦‚ä½•è®¡ç®—function score
- åŠ æƒæ–¹å¼ï¼šfunction score ä¸ query scoreå¦‚ä½•è¿ç®—



è¿™é‡Œçš„éœ€æ±‚æ˜¯ï¼šè®©**æŒ‡å®šé…’åº—**æ’åé å‰ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ç»™è¿™äº›é…’åº—æ·»åŠ ä¸€ä¸ªæ ‡è®°ï¼Œè¿™æ ·åœ¨è¿‡æ»¤æ¡ä»¶ä¸­å°±å¯ä»¥**æ ¹æ®è¿™ä¸ªæ ‡è®°æ¥åˆ¤æ–­ï¼Œæ˜¯å¦è¦æé«˜ç®—åˆ†**ã€‚

æ¯”å¦‚ï¼Œæˆ‘ä»¬ç»™é…’åº—æ·»åŠ ä¸€ä¸ªå­—æ®µï¼šisADï¼ŒBooleanç±»å‹ï¼š

- trueï¼šæ˜¯å¹¿å‘Š
- falseï¼šä¸æ˜¯å¹¿å‘Š

è¿™æ ·function_scoreåŒ…å«3ä¸ªè¦ç´ å°±å¾ˆå¥½ç¡®å®šäº†ï¼š

- è¿‡æ»¤æ¡ä»¶ï¼šåˆ¤æ–­isAD æ˜¯å¦ä¸ºtrue
- ç®—åˆ†å‡½æ•°ï¼šæˆ‘ä»¬å¯ä»¥ç”¨æœ€ç®€å•æš´åŠ›çš„weightï¼Œå›ºå®šåŠ æƒå€¼
- åŠ æƒæ–¹å¼ï¼šå¯ä»¥ç”¨é»˜è®¤çš„ç›¸ä¹˜ï¼Œå¤§å¤§æé«˜ç®—åˆ†



å› æ­¤ï¼Œä¸šåŠ¡çš„å®ç°æ­¥éª¤åŒ…æ‹¬ï¼š

1. ç»™HotelDocç±»æ·»åŠ isADå­—æ®µï¼ŒBooleanç±»å‹

2. æŒ‘é€‰å‡ ä¸ªä½ å–œæ¬¢çš„é…’åº—ï¼Œç»™å®ƒçš„æ–‡æ¡£æ•°æ®æ·»åŠ isADå­—æ®µï¼Œå€¼ä¸ºtrue

3. ä¿®æ”¹searchæ–¹æ³•ï¼Œæ·»åŠ function scoreåŠŸèƒ½ï¼Œç»™isADå€¼ä¸ºtrueçš„é…’åº—å¢åŠ æƒé‡



### 4.4.2.ä¿®æ”¹HotelDocå®ä½“

ç»™`cn.itcast.hotel.pojo`åŒ…ä¸‹çš„HotelDocç±»æ·»åŠ isADå­—æ®µï¼š

![image-20210722101908062](https://cdn.fengxianhub.top/resources-master/202205251735203.png)



### 4.4.3.æ·»åŠ å¹¿å‘Šæ ‡è®°

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŒ‘å‡ ä¸ªé…’åº—ï¼Œæ·»åŠ isADå­—æ®µï¼Œè®¾ç½®ä¸ºtrueï¼š

```json
POST /hotel/_update/1902197537
{
    "doc": {
        "isAD": true
    }
}
POST /hotel/_update/2056126831
{
    "doc": {
        "isAD": true
    }
}
POST /hotel/_update/1989806195
{
    "doc": {
        "isAD": true
    }
}
POST /hotel/_update/2056105938
{
    "doc": {
        "isAD": true
    }
}
```



### 4.4.4.æ·»åŠ ç®—åˆ†å‡½æ•°æŸ¥è¯¢

æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶äº†ã€‚ä¹‹å‰æ˜¯ç”¨çš„boolean æŸ¥è¯¢ï¼Œç°åœ¨è¦æ”¹æˆfunction_socreæŸ¥è¯¢ã€‚



function_scoreæŸ¥è¯¢ç»“æ„å¦‚ä¸‹ï¼š

![image-20210721191544750](https://cdn.fengxianhub.top/resources-master/202205251735246.png)



å¯¹åº”çš„JavaAPIå¦‚ä¸‹ï¼š

![image-20210722102850818](https://cdn.fengxianhub.top/resources-master/202205251735273.png)



æˆ‘ä»¬å¯ä»¥å°†ä¹‹å‰å†™çš„booleanæŸ¥è¯¢ä½œä¸º**åŸå§‹æŸ¥è¯¢**æ¡ä»¶æ”¾åˆ°queryä¸­ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ·»åŠ **è¿‡æ»¤æ¡ä»¶**ã€**ç®—åˆ†å‡½æ•°**ã€**åŠ æƒæ¨¡å¼**äº†ã€‚æ‰€ä»¥åŸæ¥çš„ä»£ç ä¾ç„¶å¯ä»¥æ²¿ç”¨ã€‚



ä¿®æ”¹`cn.itcast.hotel.service.impl`åŒ…ä¸‹çš„`HotelService`ç±»ä¸­çš„`buildBasicQuery`æ–¹æ³•ï¼Œæ·»åŠ ç®—åˆ†å‡½æ•°æŸ¥è¯¢ï¼š

```java
private void buildBasicQuery(RequestParams params, SearchRequest request) {
    // 1.æ„å»ºBooleanQuery
    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
    // å…³é”®å­—æœç´¢
    String key = params.getKey();
    if (key == null || "".equals(key)) {
        boolQuery.must(QueryBuilders.matchAllQuery());
    } else {
        boolQuery.must(QueryBuilders.matchQuery("all", key));
    }
    // åŸå¸‚æ¡ä»¶
    if (params.getCity() != null && !params.getCity().equals("")) {
        boolQuery.filter(QueryBuilders.termQuery("city", params.getCity()));
    }
    // å“ç‰Œæ¡ä»¶
    if (params.getBrand() != null && !params.getBrand().equals("")) {
        boolQuery.filter(QueryBuilders.termQuery("brand", params.getBrand()));
    }
    // æ˜Ÿçº§æ¡ä»¶
    if (params.getStarName() != null && !params.getStarName().equals("")) {
        boolQuery.filter(QueryBuilders.termQuery("starName", params.getStarName()));
    }
    // ä»·æ ¼
    if (params.getMinPrice() != null && params.getMaxPrice() != null) {
        boolQuery.filter(QueryBuilders
                         .rangeQuery("price")
                         .gte(params.getMinPrice())
                         .lte(params.getMaxPrice())
                        );
    }

    // 2.ç®—åˆ†æ§åˆ¶
    FunctionScoreQueryBuilder functionScoreQuery =
        QueryBuilders.functionScoreQuery(
        // åŸå§‹æŸ¥è¯¢ï¼Œç›¸å…³æ€§ç®—åˆ†çš„æŸ¥è¯¢
        boolQuery,
        // function scoreçš„æ•°ç»„
        new FunctionScoreQueryBuilder.FilterFunctionBuilder[]{
            // å…¶ä¸­çš„ä¸€ä¸ªfunction score å…ƒç´ 
            new FunctionScoreQueryBuilder.FilterFunctionBuilder(
                // è¿‡æ»¤æ¡ä»¶
                QueryBuilders.termQuery("isAD", true),
                // ç®—åˆ†å‡½æ•°
                ScoreFunctionBuilders.weightFactorFunction(10)
            )
        });
    request.source().query(functionScoreQuery);
}
```











