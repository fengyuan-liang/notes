# å¼‚æ­¥çº¿ç¨‹ä¸äº‹åŠ¡éš”ç¦»çº§åˆ«

>æœ€è¿‘åœ¨å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œäº‹åŠ¡çš„æ—¶å€™å‘ç°`ä¸€ä»¶æœ‰è¶£çš„äº‹æƒ…`ï¼Œæˆ‘æœ‰ä»¥ä¸‹ä»£ç ï¼Œåœ¨æ–°å¢å•†å“çš„æ—¶å€™åŒæ—¶æ’å…¥SKUå’Œå•†å“-SKUå…³ç³»ä¿¡æ¯ï¼Œå¦‚æœæˆ‘ç›´æ¥ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹ï¼Œå†åœ¨æœ€ä¸Šé¢è®¾ç½®äº‹åŠ¡ï¼Œè‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·å†™

![image-20241019190237923](https://cdn.fengxianhub.top/resources-master/image-20241019190237923.png)

>è¿™æ ·è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå½“`Jdbc`æ‰§è¡ŒSQLæ—¶ï¼Œä¼šä»`ThreadLocal`ä¸­å»è·å–æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œå¦‚æœå¼€å¯äº‹ç‰©çš„çº¿ç¨‹å’Œæ‰§è¡ŒSQLçš„çº¿ç¨‹ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå°±æ‹¿ä¸åˆ°æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œè¿™æ ·ï¼Œ`Jdbc`å°±ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥ç”¨æ¥æ‰§è¡ŒSQLï¼Œå¦‚æœè¿™ä¸ªäº‹ç‰©è‡ªåŠ¨äº‹ç‰©æäº¤`autocommit`é»˜è®¤å¼€å¯çš„è¯ï¼Œå°±ä¸ä¼šå› ä¸ºå¼‚å¸¸è€Œè¿›è¡Œå›æ»š

å¼‚æ­¥çº¿ç¨‹å•ç‹¬æ‰§è¡Œçš„ä»»åŠ¡å°±ä¼šæäº¤ï¼Œè€Œä¸ä¼šå› ä¸ºå…¶ä»–çº¿ç¨‹å‡ºç°é—®é¢˜è€Œè¿›è¡Œå›æ»š

![image-20241019191642124](https://cdn.fengxianhub.top/resources-master/image-20241019191642124.png)

å½“ç„¶ç¬”è€…çš„é—®é¢˜å¹¶ä¸å®Œå…¨æ˜¯ä¸Šé¢å¼‚æ­¥çº¿ç¨‹å¯¼è‡´çš„ï¼Œç¬”è€…ä¹Ÿæ„è¯†åˆ°äº†å¼‚æ­¥çº¿ç¨‹å¯èƒ½å¯¼è‡´äº‹åŠ¡å¤±æ•ˆï¼Œæ‰€ä»¥æŒ‰ç…§å¸¸è§„æ–¹æ³•è¿›è¡Œè§£å†³ï¼Œå…·ä½“æ˜¯åœ¨å½“å‰ç±»ä¸­å†å®šä¹‰ä¸€ä¸ªäº‹åŠ¡çš„å¼‚æ­¥æ–¹æ³•ï¼Œè¿›è¡Œæ‰§è¡Œï¼Œè¿™æ ·çš„è¯å³ä½¿ä¸æ˜¯åŒä¸€ä¸ªè¿æ¥ï¼Œä¹Ÿä¼šé’ˆå¯¹å¼‚å¸¸è¿›è¡Œå›æ»š

```java
@Async
@Transactional(rollbackFor = Throwable.class, propagation = Propagation.SUPPORTS)
public CompletableFuture<Void> executeAsyncInTransaction(Runnable task) {
    task.run();
    return CompletableFuture.completedFuture(null);
}

// ä½¿ç”¨ @Async å¾—ä¸ºSpringæ³¨å…¥çº¿ç¨‹æ± ï¼Œä¸‹é¢æ˜¯æˆ‘çš„é…ç½®ç±»
@Slf4j
@Configuration
@EnableAsync
public class AsyncUtil implements AsyncConfigurer {

    @Getter
    private static final ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();

    @Override
    public Executor getAsyncExecutor() {
        return executor;
    }
}
```

æœ€åæ›´æ¢å¼‚æ­¥æ–¹æ³•å³å¯

![image-20241019221104310](https://cdn.fengxianhub.top/resources-master/image-20241019221104310.png)

å†æ‰§è¡Œä»£ç ï¼Œæˆ‘çš„é—®é¢˜å¾—åˆ°äº†è§£å†³

>çªç„¶ç¬”è€…çµå…‰ä¸€é—ªï¼Œé‚£å¯ä¸å¯ä»¥æŠŠè¿™ä¸ªæ–¹æ³•å®šä¹‰çš„å†é€šç”¨ä¸€ç‚¹ï¼Œç›´æ¥å°è£…åˆ°å¼‚æ­¥å·¥å…·é‡Œå‘¢ï¼Œæˆ‘å¯çœŸæ˜¯ä¸ªå°å¤©æ‰å°å¤©æ‰ğŸ˜

è¯´æ—¶è¿Ÿé‚£æ—¶å¿«ï¼Œæˆ‘ç›´æ¥ä¸‰ä¸‹äº”é™¤äºŒå†™å¥½ä»£ç ï¼Œä¸€è„¸è‡ªä¿¡çš„ç‚¹å‡»å•å…ƒæµ‹è¯•

```java
@Slf4j
@Configuration
@EnableAsync
public class AsyncUtil implements AsyncConfigurer {

    @Getter
    private static final ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();

    @Override
    public Executor getAsyncExecutor() {
        return executor;
    }
    
    @Async
    @Transactional(rollbackFor = Throwable.class, propagation = Propagation.SUPPORTS)
    public CompletableFuture<Void> executeAsyncInTransaction(Runnable task) {
        task.run();
        return CompletableFuture.completedFuture(null);
    }
}
```

ç„¶åå°±æ˜¯ç†Ÿæ‚‰çš„çº¢è‰²æŠ¥é”™

![image-20241019221813749](https://cdn.fengxianhub.top/resources-master/image-20241019221813749.png)

ç›´æ¥ç»™ç¬”è€…å¹²è’™è”½äº†ï¼Œç¬”è€…åªä¸è¿‡æ˜¯æŠŠä»£ç æŒªäº†ä¸ªä½ç½®ï¼å±…ç„¶å°±ä¸è¡Œäº†ï¼Œè¿™éš¾é“å°±æ˜¯**å‰è¾ˆä»¬æ‰€è¯´çš„ä»£ç èƒ½è·‘å°±åƒä¸‡ä¸è¦åŠ¨å˜›**ï¼

![image-20220419181105375](https://cdn.fengxianhub.top/resources-master/202204191811589.png)

>ä¸è¿‡äº‹æƒ…ä¹Ÿå¼€å§‹å˜å¾—æœ‰è¶£èµ·æ¥äº†ğŸ‘¾ğŸ‘¾ğŸ‘¾

è¿™æ ·åšçš„åŒºåˆ«æ˜¯å•¥å˜ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç”¨ä¸€ä¸ªæ–¹æ³•æ¥æ‰“å°ä¸‹å››ä¸ªåç¨‹/çº¿ç¨‹é‡Œé¢çš„äº‹åŠ¡ï¼Œæ¥æ‰¾æ‰¾å·®å¼‚

![image-20241019230807888](https://cdn.fengxianhub.top/resources-master/image-20241019230807888.png)

æ—¥å¿—å¦‚ä¸‹

![image-20241019230943529](https://cdn.fengxianhub.top/resources-master/image-20241019230943529.png)

æˆ‘ä»¬å‘ç°åœ¨åŒä¸€ä¸ªclassé‡Œçš„å¼‚æ­¥æ–¹æ³•ä½¿ç”¨çš„äº‹åŠ¡æ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆç¬”è€…ç¬¬ä¸€ç‰ˆä¿®æ”¹çš„ä»£ç æ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„äº†ï¼Œå› ä¸ºè¿™å‡ ä¸ªåç¨‹/çº¿ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªäº‹åŠ¡ï¼Œå½“å…¶ä¸­ä¸€ä¸ªåç¨‹/çº¿ç¨‹æŠ›å‡ºå¼‚å¸¸åï¼Œä¼šæŠŠæ‰€ä»¥çš„æ•°æ®è¿›è¡Œå›æ»šï¼å¯æ˜¯ä¸ºå•¥å†™åˆ°å…¶ä»–classé‡Œé¢å°±ä¸è¡Œäº†å‘¢ï¼Ÿ

å…¶å®é—®é¢˜ä¼¼ä¹å˜å¾—ç®€å•èµ·æ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

- ç¬¬äºŒä¸ªæ—¥å¿—æ‰“å°çš„åœ°æ–¹æ˜æ˜¾ä¸æ˜¯ä»£ç†æ–¹æ³•
- å¼‚æ­¥ç±»æ—¥å¿—æ‰“å°çš„åœ°æ–¹æ˜¯ä»£ç†æ–¹æ³•

éš¾é“æ˜¯ä»£ç†ç±»çš„é—®é¢˜ï¼Ÿå…¶å®è·Ÿä»£ç†ç±»æœ‰å…³ç³»ï¼Œä½†ä¸»è¦åŸå› æ˜¯äº‹åŠ¡åœ¨Springé‡Œé¢å­˜åœ¨ThreadLocalé‡Œï¼Œå¼‚æ­¥çº¿ç¨‹æ— æ³•å…±äº«ã€‚åœ¨åŒä¸€ä¸ªclassä¸­ä¸ºä»€ä¹ˆåˆå¯ä»¥å…±äº«äº†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨ä»”ç»†çœ‹ä¸‹ç¬¬äºŒä¸ªæ—¥å¿—çš„æ‰“å°ï¼Œæˆ‘ä»¬ä¼šå‘ç° => å®ƒä¸æ˜¯ä»£ç†æ–¹æ³•ï¼ï¼ï¼ï¼ï¼æ‰€ä»¥åŠ çš„`@Asyncã€@Transactional(rollbackFor = Throwable.class)`æ³¨è§£éƒ½æ²¡ç”¨ï¼Œæ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œçš„ï¼Œå½“ç„¶å…±äº«ä¸Šä¸‹æ–‡/äº‹åŠ¡äº†ï¼

æ‰€ä»¥ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå±äºä¸¤ä¸ªbugå åŠ åœ¨ä¸€èµ·ï¼Œåè€Œå¯ä»¥è¿è¡Œäº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼

çŸ¥é“äº†åŸå› ï¼Œå°±èƒ½æ‰¾åˆ°è§£å†³æ–¹æ³•ï¼ŒåŸæ¥è¿™ç§é—®é¢˜Springæ—©å°±å¸®æˆ‘ä»¬æƒ³åˆ°äº†ï¼Œç›´æ¥ç”¨`TransactionSynchronizationManager`å’Œ`ThreadPoolTaskExecutor`æ¥è¿›è¡Œå¼‚æ­¥çº¿ç¨‹é—´äº‹åŠ¡çš„ä¼ é€’ï¼Œè¯»è€…å¯ä»¥çœ‹åé¢è§£å†³æ–¹æ³•é‡Œçš„ä»£ç 

## TransactionSynchronizationManager

>è¿™é‡Œä¹ŸTipsä¸‹`TransactionSynchronizationManager` çš„ä½œç”¨
>
>`TransactionSynchronizationManager` ä½¿ç”¨ `ThreadLocal` æ¥å­˜å‚¨å½“å‰çº¿ç¨‹çš„äº‹åŠ¡çŠ¶æ€å’Œèµ„æºç»‘å®šã€‚å®ƒä¸»è¦ç”¨äºï¼š
>
>- ç®¡ç†äº‹åŠ¡åŒæ­¥æ³¨å†Œã€‚
>- ç»‘å®šå’Œè§£ç»‘èµ„æºï¼ˆå¦‚æ•°æ®åº“è¿æ¥ï¼‰åˆ°å½“å‰çº¿ç¨‹ã€‚
>- æä¾›äº‹åŠ¡çŠ¶æ€ä¿¡æ¯

`ransactionSynchronizationManager` çš„å†…éƒ¨ç»“æ„

`TransactionSynchronizationManager` å†…éƒ¨ä½¿ç”¨äº† `ThreadLocal` æ¥å­˜å‚¨äº‹åŠ¡çŠ¶æ€å’Œèµ„æºç»‘å®šã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ª `ThreadLocal` å˜é‡ï¼š

1. **`boundResources`**ï¼šè¿™æ˜¯ä¸€ä¸ª `Map`ï¼Œç”¨äºå­˜å‚¨ä¸å½“å‰çº¿ç¨‹ç»‘å®šçš„èµ„æºã€‚ä¾‹å¦‚ï¼Œå¯¹äº JDBCï¼Œå®ƒä¼šå­˜å‚¨ `DataSource` å’Œå¯¹åº”çš„ `ConnectionHolder`ã€‚
2. **`transaction`**ï¼šè¿™æ˜¯ä¸€ä¸ª `TransactionStatus` å¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„äº‹åŠ¡çŠ¶æ€ã€‚

```java
private static final ThreadLocal<Map<Object, Object>> resources = new NamedThreadLocal<>("Transactional resources");
private static final ThreadLocal<TransactionStatus> transaction = new NamedThreadLocal<>("Current transaction status");
```

## è§£å†³æ–¹æ³•

ä¸ºäº†ç¡®ä¿ `å¼‚æ­¥çº¿ç¨‹` ä¸­çš„æ“ä½œèƒ½å¤Ÿå‚ä¸äº‹åŠ¡ï¼Œæœ‰å‡ ç§è§£å†³æ–¹æ¡ˆ

- å¼‚æ­¥ä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡
- æ‰‹åŠ¨äº‹åŠ¡ï¼ˆè¿™ä¸ªå°±ä¸ä¸Šä»£ç äº†ğŸ¤–ï¼‰

æ­¤å¤–å¼‚æ­¥æ–¹æ³•ä¼ æ’­æœºåˆ¶éœ€è¦è®¾ç½®ä¸º`REQUIRED` ï¼Œä¹Ÿå°±æ˜¯`æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œæœ‰å°±ç”¨å½“å‰ï¼Œæ²¡æœ‰å°±åˆ›å»º`

### åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­ä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡

>é—®é¢˜ä¼¼ä¹å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ä¸åŒçº¿ç¨‹é—´ä¼ é€’ä¸‹äº‹åŠ¡çš„ä¸Šä¸‹æ–‡å³å¯
>
>ä¸‹é¢çš„ä»£ç ç¬”è€…å¹¶æ²¡æœ‰åœ¨ç”Ÿäº§ä¸Šä½¿ç”¨è¿‡ï¼Œè¯»è€…å¯ä»¥çœ‹è¿™ä¸ª https://www.cnblogs.com/fix200/p/18066537

é…ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„ `TaskExecutor`ï¼Œå¹¶ç¡®ä¿å®ƒæ”¯æŒäº‹åŠ¡ä¼ æ’­ã€‚å¯ä»¥ä½¿ç”¨ `TransactionSynchronizationManager` æ¥ç»‘å®šäº‹åŠ¡ä¸Šä¸‹æ–‡

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;
import org.springframework.transaction.support.TransactionSynchronizationManager;

import java.util.concurrent.Executor;

@Configuration
@EnableAsync
public class AsyncConfig {

    @Async("transactionalTaskExecutor")
    public CompletableFuture<Void> executeAsyncInTransaction(Runnable task) {
        task.run();
        return CompletableFuture.completedFuture(null);
    }

    @Bean(name = "transactionalTaskExecutor")
    public Executor transactionalTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(20);
        executor.setThreadNamePrefix("transactional-async-");

        // è®¾ç½® TaskDecorator æ¥ç»‘å®šäº‹åŠ¡ä¸Šä¸‹æ–‡
        executor.setTaskDecorator(task -> () -> {
            // ä¿å­˜å½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡
            Map<Object, Object> resources = TransactionSynchronizationManager.getResourceMap();
            String currentTransactionName = TransactionSynchronizationManager.getCurrentTransactionName();

            try {
                // ç»‘å®šäº‹åŠ¡ä¸Šä¸‹æ–‡åˆ°æ–°çº¿ç¨‹
                if (resources != null) {
                    for (Map.Entry<Object, Object> entry : resources.entrySet()) {
                        TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());
                    }
                }
                if (currentTransactionName != null) {
                    TransactionSynchronizationManager.bindResource(TransactionSynchronizationManager.class, currentTransactionName);
                }

                // æ‰§è¡Œä»»åŠ¡
                task.run();
            } finally {
                // è§£ç»‘äº‹åŠ¡ä¸Šä¸‹æ–‡
                if (resources != null) {
                    for (Object key : resources.keySet()) {
                        TransactionSynchronizationManager.unbindResource(key);
                    }
                }
                if (currentTransactionName != null) {
                    TransactionSynchronizationManager.unbindResource(TransactionSynchronizationManager.class);
                }
            }
        });

        executor.initialize();
        return executor;
    }
}
```

>`executor.setTaskDecorator` æ–¹æ³•æ˜¯ Spring æä¾›çš„ä¸€ä¸ªé…ç½®é€‰é¡¹ï¼Œç”¨äºåœ¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå‰åæ·»åŠ è‡ªå®šä¹‰çš„é€»è¾‘ã€‚è¿™ä¸ªæ–¹æ³•å…è®¸ä½ åŒ…è£…åŸå§‹çš„ä»»åŠ¡ï¼ˆRunnable æˆ– Callableï¼‰ï¼Œå¹¶åœ¨ä»»åŠ¡æ‰§è¡Œå‰å’Œæ‰§è¡Œåæ’å…¥é¢å¤–çš„æ“ä½œã€‚è¿™å¯¹äºä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡ã€æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§ç­‰åœºæ™¯éå¸¸æœ‰ç”¨ã€‚
>
>### `setTaskDecorator` çš„å·¥ä½œåŸç†
>
>å½“ä½ è°ƒç”¨ `executor.setTaskDecorator` æ—¶ï¼Œä½ éœ€è¦æä¾›ä¸€ä¸ª `TaskDecorator` å®ç°ã€‚`TaskDecorator` æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª `Callable` æˆ– `Runnable` ä»»åŠ¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ `Callable` æˆ– `Runnable` ä»»åŠ¡ã€‚è¿™ä¸ªæ–°çš„ä»»åŠ¡ä¼šåœ¨åŸå§‹ä»»åŠ¡çš„åŸºç¡€ä¸Šæ·»åŠ é¢å¤–çš„é€»è¾‘ã€‚

å°ç»“ï¼š

1. **è·å–å½“å‰çº¿ç¨‹çš„äº‹åŠ¡çŠ¶æ€**ï¼šä½¿ç”¨ `TransactionAspectSupport.currentTransactionStatus()`ã€‚
2. **ä¿å­˜äº‹åŠ¡ä¸Šä¸‹æ–‡**ï¼šå°†è¿™äº›ä¿¡æ¯ä¿å­˜èµ·æ¥ã€‚
3. **åˆ›å»ºæ–°çš„å¼‚æ­¥ä»»åŠ¡**ï¼šåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œæ¢å¤ä¿å­˜çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚
4. **æ¢å¤äº‹åŠ¡ä¸Šä¸‹æ–‡**ï¼šåœ¨æ–°çº¿ç¨‹ä¸­é‡æ–°ç»‘å®šäº‹åŠ¡çŠ¶æ€å’Œèµ„æºã€‚
5. **æ‰§è¡Œä»»åŠ¡**ï¼šåœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå®é™…çš„ä»»åŠ¡ã€‚
6. **æ¸…ç†äº‹åŠ¡ä¸Šä¸‹æ–‡**ï¼šåœ¨ä»»åŠ¡å®Œæˆåï¼Œæ¸…ç†äº‹åŠ¡ä¸Šä¸‹æ–‡ä»¥é¿å…å†…å­˜æ³„æ¼

## æ€»ç»“

åœ¨ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œå’Œ `CompletableFuture`æ—¶ï¼Œ`CompletableFuture` çš„æ‰§è¡Œæ˜¯é€šè¿‡çº¿ç¨‹æ± æ¥å®Œæˆçš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¸ä¼šå‚ä¸ Spring çš„äº‹åŠ¡ç®¡ç†ã€‚åŸå› å¦‚ä¸‹ï¼š

1. **çº¿ç¨‹ä¸Šä¸‹æ–‡**ï¼š

   - Spring äº‹åŠ¡ç®¡ç†ä¾èµ–äºçº¿ç¨‹æœ¬åœ°å˜é‡ï¼ˆThreadLocalï¼‰æ¥å­˜å‚¨äº‹åŠ¡çŠ¶æ€ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚
   - å½“ `CompletableFuture` åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œæ—¶ï¼Œå®ƒä¸ä¼šç»§æ‰¿åŸæ¥çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œå› æ­¤ä¸ä¼šè‡ªåŠ¨è·å–åˆ°çˆ¶çº¿ç¨‹çš„äº‹åŠ¡ä¿¡æ¯ã€‚

2. **ä»£ç†æœºåˆ¶**ï¼š

   - `@Transactional` æ³¨è§£æ˜¯é€šè¿‡ä»£ç†æœºåˆ¶å®ç°çš„ã€‚å½“ä½ ç›´æ¥åœ¨ä¸€ä¸ªæ–¹æ³•ä¸Šè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œä»£ç†æœºåˆ¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚
   - ä½†æ˜¯ï¼Œ`CompletableFuture` ä¸­çš„æ–¹æ³•æ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè¿™ç»•è¿‡äº† Spring çš„ä»£ç†æœºåˆ¶ï¼Œå› æ­¤ `@Transactional` æ³¨è§£æ— æ³•ç”Ÿæ•ˆã€‚

3. **äº‹åŠ¡ä¼ æ’­**ï¼š

   - å³ä½¿ä½ åœ¨ `CompletableFuture` ä¸­æ‰‹åŠ¨æ·»åŠ äº† `@Transactional` æ³¨è§£ï¼Œç”±äºçº¿ç¨‹ä¸Šä¸‹æ–‡çš„ä¸åŒï¼Œäº‹åŠ¡ä¼ æ’­ä¹Ÿæ— æ³•æ­£ç¡®åœ°ä¼ é€’ç»™æ–°çº¿ç¨‹ã€‚

4. **äº‹åŠ¡ä¼ æ’­æœºåˆ¶**

   å‡è®¾ä½ åœ¨ä¸€ä¸ªç±»ä¸­å®šä¹‰äº†å¤šä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œå¹¶ä¸”è¿™äº›æ–¹æ³•éƒ½ä½¿ç”¨äº† `@Transactional` æ³¨è§£ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¿™äº›å¼‚æ­¥æ–¹æ³•éƒ½åœ¨åŒä¸€ä¸ªç±»å®ä¾‹ä¸­æ‰§è¡Œï¼Œå¹¶ä¸”å®ƒä»¬å…±äº«åŒä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚è¿™æ˜¯å› ä¸ºï¼š

   - **äº‹åŠ¡ä¼ æ’­**ï¼šåœ¨åŒä¸€ç±»ä¸­çš„æ–¹æ³•è°ƒç”¨ä¸ä¼šè§¦å‘ AOP ä»£ç†ï¼Œå› æ­¤äº‹åŠ¡ä¸Šä¸‹æ–‡å¯ä»¥ç›´æ¥ä¼ é€’ï¼ˆspringä½¿ç”¨`NamedThreadLocal`ä¿å­˜ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä»¥åŠçˆ¶å­çº¿ç¨‹ä¸­å…±äº«å±æ€§ï¼‰ã€‚
   - **çº¿ç¨‹æœ¬åœ°å˜é‡**ï¼š`TransactionSynchronizationManager` ä½¿ç”¨ `ThreadLocal` å­˜å‚¨äº‹åŠ¡çŠ¶æ€å’Œèµ„æºç»‘å®šï¼Œè¿™äº›å˜é‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…æ˜¯å…±äº«çš„ã€‚
   - åœ¨Springé‡Œé¢å¯ä»¥ä½¿ç”¨`ThreadPoolTaskExecutor`çš„`setTaskDecorator`è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œè¿›è¡Œäº‹åŠ¡ä¼ é€’

## é™„å½• @Transactional æºç 

ä¸‹é¢æ˜¯ç¬”è€…æŸ¥çœ‹`@Transactional`æ‰§è¡Œæºç çš„ä¸€äº›ç¬”è®°ï¼Œè¯»è€…å¯ä»¥è·³è¿‡ğŸ˜

é‚£ä¹ˆæ€ä¹ˆç ”ç©¶å‘¢ï¼Œé‚£å½“ç„¶æ˜¯çœ‹æ–‡æ¡£äº†ï¼Œç¬”è€…è¿™é‡Œçœ‹çš„æ˜¯ [Spring6 çš„æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/data-access/transaction/strategies.html)

![image-20241019215007936](https://cdn.fengxianhub.top/resources-master/image-20241019215007936.png)

>é‡Œé¢æåˆ°äº†ä¸€ä¸ªå…³é”®çš„æ¥å£`PlatformTransactionManager`ï¼ˆTransactionManageræ˜¯ä¸ªç©ºæ¥å£ï¼‰ï¼Œ`PlatformTransactionManager` æ˜¯ Spring äº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒæ¥å£ï¼Œå®šä¹‰äº†äº‹åŠ¡çš„åŸºæœ¬æ“ä½œ`DataSourceTransactionManager`æ˜¯**Mybatiså’ŒJDBC**è¿›è¡Œçš„é»˜è®¤å®ç°

æˆ‘ä»¬éƒ½çŸ¥é“å½“åŠ äº†`@Transactional`ä¹‹åï¼ŒSpringä¼šå¸®æˆ‘ä»¬è¿›è¡Œåˆ‡é¢ï¼Œæ¥å¸®æˆ‘ä»¬å¤„ç†å¼‚å¸¸å†è¿›è¡Œäº‹åŠ¡çš„å›æ»šå’Œæäº¤

![image-20241019223441126](https://cdn.fengxianhub.top/resources-master/image-20241019223441126.png)

åœ¨Springä¸­ï¼Œ`@Transactional`æ˜¯ç”±`TransactionInterceptor`æ¥è¿›è¡Œå®ç°çš„ï¼Œ`TransactionInterceptor` æ˜¯ Spring AOP ä¸­çš„ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œç”¨äºåœ¨æ–¹æ³•è°ƒç”¨å‰åæ‰§è¡Œäº‹åŠ¡ç®¡ç†ã€‚å®ƒå®ç°äº† `MethodInterceptor` æ¥å£ï¼Œå¹¶ä½¿ç”¨ `PlatformTransactionManager` æ¥å¤„ç†äº‹åŠ¡ã€‚

>`TransactionInterceptor` çš„æ ¸å¿ƒæ–¹æ³•

**`invoke` æ–¹æ³•**ï¼ˆä¸‹é¢æ˜¯ä¸€äº›ä¼ªä»£ç ï¼‰ï¼šè¿™æ˜¯ `MethodInterceptor` æ¥å£çš„ä¸»è¦æ–¹æ³•ï¼Œè´Ÿè´£åœ¨ç›®æ ‡æ–¹æ³•è°ƒç”¨å‰åæ‰§è¡Œäº‹åŠ¡ç®¡ç†é€»è¾‘ã€‚

```java
@Override
public Object invoke(final MethodInvocation invocation) throws Throwable {
    // è·å–å½“å‰äº‹åŠ¡å±æ€§
    Class<?> targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);
    TransactionAttributeSource tas = this.getTransactionAttributeSource();
    TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(invocation.getMethod(), targetClass) : null);

    final boolean debugEnabled = logger.isDebugEnabled();

    if (txAttr == null || !(txAttr instanceof RuleBasedTransactionAttribute) ||
            !((RuleBasedTransactionAttribute) txAttr).getRollbackRules().isEmpty()) {
        // æ²¡æœ‰äº‹åŠ¡å±æ€§æˆ–éœ€è¦è‡ªå®šä¹‰å›æ»šè§„åˆ™
        return invokeWithinTransaction(invocation, txAttr);
    } else if (this.rollbackOnCommitFailure) {
        // å¦‚æœæäº¤å¤±è´¥éœ€è¦å›æ»š
        return invokeWithinTransaction(invocation, txAttr);
    } else {
        // ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•
        return invocation.proceed();
    }
}
```

**`invokeWithinTransaction` æ–¹æ³•**ï¼šè¿™æ˜¯å®é™…å¤„ç†äº‹åŠ¡çš„æ–¹æ³•ã€‚

```java
protected Object invokeWithinTransaction(Method method, Object target, final InvocationCallback invocationCallback,
                                         @Nullable TransactionAttribute txAttr) throws Throwable {

    // ç¡®å®šäº‹åŠ¡ç®¡ç†å™¨
    PlatformTransactionManager tm = determineTransactionManager(txAttr);
    final String joinpointIdentification = methodIdentification(method, target.getClass());

    // å¼€å§‹äº‹åŠ¡
    TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);
    Object retVal;
    try {
        // è°ƒç”¨ç›®æ ‡æ–¹æ³•
        retVal = invocationCallback.proceedWithInvocation();
    } catch (Throwable ex) {
        // å¤„ç†å¼‚å¸¸
        completeTransactionAfterThrowing(txInfo, ex);
        throw ex;
    } finally {
        cleanupTransactionInfo(txInfo);
    }

    // æäº¤äº‹åŠ¡
    commitTransactionAfterReturning(txInfo);
    return retVal;
}
```

äº‹åŠ¡çš„åˆ›å»ºä¸æäº¤

**åˆ›å»ºäº‹åŠ¡**

- **`createTransactionIfNecessary` æ–¹æ³•**ï¼šå¦‚æœéœ€è¦äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚

```java
private TransactionInfo createTransactionIfNecessary(PlatformTransactionManager tm, TransactionAttribute txAttr,
                                                     final String joinpointIdentification) {
    // å¦‚æœæ²¡æœ‰äº‹åŠ¡å±æ€§ï¼Œåˆ™ä¸åˆ›å»ºäº‹åŠ¡
    if (txAttr == null) {
        return null;
    }

    // è·å–å½“å‰äº‹åŠ¡çŠ¶æ€
    TransactionStatus ts = tm.getTransaction(txAttr);
    boolean isNewTx = (ts.isNewTransaction());
    boolean shouldDebug = (isNewTx && isTraceEnabled()) || isDebugEnabled();

    if (shouldDebug) {
        logStartOfTransaction(joinpointIdentification, txAttr, isNewTx, ts);
    }

    // åˆ›å»ºå¹¶è¿”å› TransactionInfo
    return prepareTransactionInfo(tm, txAttr, joinpointIdentification, ts, isNewTx);
}
```

- **`getTransaction` æ–¹æ³•**ï¼š`PlatformTransactionManager` çš„å®ç°ç±»ä¼šæ ¹æ® `TransactionDefinition` åˆ›å»ºä¸€ä¸ª `TransactionStatus` å¯¹è±¡

```java
public TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException {
    // å…·ä½“å®ç°ç±»ï¼ˆå¦‚ JpaTransactionManager æˆ– DataSourceTransactionManagerï¼‰ä¼šåœ¨è¿™é‡Œåˆ›å»ºäº‹åŠ¡
}
```

**æäº¤äº‹åŠ¡**

- **`commitTransactionAfterReturning` æ–¹æ³•**ï¼šåœ¨æ–¹æ³•æˆåŠŸå®Œæˆåæäº¤äº‹åŠ¡ã€‚

```java
private void commitTransactionAfterReturning(TransactionInfo txInfo) {
    if (isDebugEnabled()) {
        logger.debug("Completing transaction for [" + txInfo.joinpointIdentification + "]");
    }

    // æäº¤äº‹åŠ¡
    txInfo.transactionManager.commit(txInfo.transactionStatus);
}
```

- **`commit` æ–¹æ³•**ï¼š`PlatformTransactionManager` çš„å®ç°ç±»ä¼šåœ¨è¿™é‡Œæäº¤äº‹åŠ¡ã€‚

```java
public void commit(TransactionStatus status) throws TransactionException {
    // å…·ä½“å®ç°ç±»ï¼ˆå¦‚ JpaTransactionManager æˆ– DataSourceTransactionManagerï¼‰ä¼šåœ¨è¿™é‡Œæäº¤äº‹åŠ¡
}
```

 **å¼‚å¸¸å¤„ç†ä¸å›æ»š**

- **`completeTransactionAfterThrowing` æ–¹æ³•**ï¼šåœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åå›æ»šäº‹åŠ¡ã€‚

```java
private void completeTransactionAfterThrowing(TransactionInfo txInfo, Throwable ex) {
    if (isDebugEnabled()) {
        logger.debug("Completing transaction for [" + txInfo.joinpointIdentification + "] after exception: " + ex);
    }

    // å›æ»šäº‹åŠ¡
    try {
        txInfo.transactionManager.rollback(txInfo.transactionStatus);
    } catch (RuntimeException | Error rethrow) {
        logger.error("Unexpected error during rollback", rethrow);
        throw rethrow;
    } catch (Throwable other) {
        logger.error("Unexpected error during rollback", other);
    }
}
```

- **`rollback` æ–¹æ³•**ï¼š`PlatformTransactionManager` çš„å®ç°ç±»ä¼šåœ¨è¿™é‡Œå›æ»šäº‹åŠ¡ã€‚

```java
public void rollback(TransactionStatus status) throws TransactionException {
    // å…·ä½“å®ç°ç±»ï¼ˆå¦‚ JpaTransactionManager æˆ– DataSourceTransactionManagerï¼‰ä¼šåœ¨è¿™é‡Œå›æ»šäº‹åŠ¡
}
```

**å°ç»“**

1. **äº‹åŠ¡åˆ›å»º**ï¼š
   - `TransactionInterceptor` é€šè¿‡ `PlatformTransactionManager` åˆ›å»ºä¸€ä¸ªæ–°çš„ `TransactionStatus`ã€‚
   - `PlatformTransactionManager` æ ¹æ® `TransactionDefinition` åˆ›å»ºäº‹åŠ¡ã€‚
2. **äº‹åŠ¡æäº¤**ï¼š
   - åœ¨æ–¹æ³•æˆåŠŸå®Œæˆåï¼Œ`TransactionInterceptor` é€šè¿‡ `PlatformTransactionManager` æäº¤äº‹åŠ¡ã€‚
3. **å¼‚å¸¸å¤„ç†ä¸å›æ»š**ï¼š
   - åœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åï¼Œ`TransactionInterceptor` é€šè¿‡ `PlatformTransactionManager` å›æ»šäº‹åŠ¡ã€‚

## é™„å½• - å¸¸è§äº‹åŠ¡å¤±æ•ˆå¸¸è§

### [1. æ–¹æ³•è‡ªè°ƒç”¨](https://blog.fengxianhub.top/#/Spring_Framework/Spring_transaction?id=_1-æ–¹æ³•è‡ªè°ƒç”¨)

> ç¬¬ä¸€ç±»ï¼Œ`@Transactional`æ³¨è§£æœªç”Ÿæ•ˆæƒ…å†µï¼Œå…¶å®è¿™ç§å¹¶ä¸æ˜¯äº‹ç‰©å¤±æ•ˆï¼Œä»…ä»…æ˜¯æ³¨è§£å¤±æ•ˆï¼Œæ³¨è§£å†™äº†æ›´æ²¡å†™ä¸€æ ·
>
> è§£å†³æ–¹æ¡ˆï¼š
>
> - å°†è¢«è°ƒç”¨çš„æ–¹æ³•æ‹†åˆ°å•ç‹¬çš„beanä¸­ï¼Œè®©åˆ‡é¢èµ·ä½œç”¨
> - è‡ªå·±æ³¨å…¥è‡ªå·±è·å–ä»£ç†ç±»
> - `@EnableAspectJAutoProxy(exposeProxy = true)` + `UserService userService = (UserService) AopContext.currentProxy();`

Springäº‹åŠ¡æ˜¯åŸºäºAOPçš„ï¼Œåªæœ‰å½“ä»£ç†å¯¹è±¡è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ï¼ŒSpringçš„äº‹åŠ¡æ‰ä¼šç”Ÿæ•ˆï¼Œè€Œåœ¨ä¸€ä¸ªæ–¹æ³•ä¸­è°ƒç”¨`this.xxx()`æ–¹æ³•æ—¶ï¼Œç”±äº`this`å¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´äº‹åŠ¡å¤±æ•ˆ

```java
@Transactional
public void a(){
    jdbcTemplate.execute("insert into t1 values(1)");
    throw new RuntimeException();
}

// è‡ªè°ƒç”¨
public void b(){
    // ç”±äºè°ƒç”¨è€…å¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥åˆ‡é¢å¤±è´¥å¯¼è‡´äº‹ç‰©å¤±æ•ˆ
    a();
}
```

è¿˜æœ‰ä¸€ç§æƒ…å†µ

```java
// æ­¤æ—¶ç›¸å½“äº`a`æ–¹æ³•ä¸Šé¢æ ¹æœ¬å°±æ²¡è´´äº‹ç‰©æ³¨è§£ä¸€æ ·
@Transactional(propagation = Propagation.NEVER)
public void a(){
    jdbcTemplate.execute("insert into t1 values(1)");
    throw new RuntimeException();
}

// è°ƒç”¨æ–¹æ³•ä¹ŸåŠ äº†äº‹ç‰©æ³¨è§£ï¼Œæ­¤æ—¶ä¼šè¿›è¡Œå›æ»šï¼Œä½†æ˜¯æ˜¯ç”±bæ–¹æ³•çš„äº‹ç‰©å°±è¡Œå›æ»šçš„
@Transactional
public void b(){
    // ç”±äºè°ƒç”¨è€…å¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥åˆ‡é¢å¤±è´¥å¯¼è‡´äº‹ç‰©å¤±æ•ˆ
    a();
}
```

æ‰€ä»¥è§£å†³æ–¹æ¡ˆå°±æ˜¯ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨å³å¯

```java
public class UserService {
    @Autowired // è‡ªå·±æ³¨å…¥è‡ªå·±
    private UserService userService;
    @Transactional
    public void a(){
        jdbcTemplate.execute("insert into t1 values(1)");
        throw new RuntimeException();
    }

    // äº‹ç‰©ç”Ÿæ•ˆ
    public void b(){
        userService.a();
    }
}
```

æˆ–è€…å¯ä»¥é€šè¿‡ä»£ç†ä¸Šä¸‹æ–‡è·å–å½“å‰ç±»çš„ä»£ç†å¯¹è±¡ï¼Œä½†æ˜¯è¿™ç§éœ€è¦æˆ‘ä»¬åœ¨é…ç½®ç±»ä¸Šé¢è®¾ç½®å±æ€§`@EnableAspectJAutoProxy(exposeProxy = true)`

```java
public class UserService {
    @Transactional
    public void a(){
        jdbcTemplate.execute("insert into t1 values(1)");
        throw new RuntimeException();
    }

    // äº‹ç‰©ç”Ÿæ•ˆ
    public void b(){
        // è·å–å½“å‰ç±»çš„ä»£ç†å¯¹è±¡
        UserService userService = (UserService) AopContext.currentProxy();
        userService.a();
    }
}
```

### [2. æ–¹æ³•ä¿®é¥°ç¬¦ä¸ºprivate](https://blog.fengxianhub.top/#/Spring_Framework/Spring_transaction?id=_2-æ–¹æ³•ä¿®é¥°ç¬¦ä¸ºprivate)

> - cglibä»£ç†æ˜¯åŸºäºçˆ¶å­ç±»çš„ï¼Œå¦‚æœæ–¹æ³•ç§æœ‰æ— æ³•åœ¨å­ç±»ä¸­è·å–åˆ°ï¼Œæ— æ³•é‡å†™ï¼Œåªèƒ½æ‰§è¡Œçˆ¶ç±»çš„æ–¹æ³•ï¼Œä½†æ˜¯çˆ¶ç±»ä¸­æ²¡æœ‰`jdbcTemplate`ï¼Œä¼šæŠ›å‡º`NPE`
> - å¤šæ€å£è¯€ï¼šnewè°è°ƒç”¨è°çš„æ–¹æ³•ï¼Œè°åˆ›å»ºä½¿ç”¨è°çš„å±æ€§

```java
public class UserService {
    // cglibä»£ç†æ˜¯åŸºäºçˆ¶å­ç±»çš„ï¼Œå¦‚æœæ–¹æ³•ç§æœ‰æ— æ³•åœ¨å­ç±»ä¸­è·å–åˆ°ï¼Œåªèƒ½æ‰§è¡Œçˆ¶ç±»çš„æ–¹æ³•ï¼Œä½†æ˜¯çˆ¶ç±»ä¸­æ²¡æœ‰`jdbcTemplate`ï¼Œ`NPE`
    @Transactional
    private void a(){
        jdbcTemplate.execute("insert into t1 values(1)");
        throw new RuntimeException();
    }
}
```

### [3. æ–¹æ³•æ˜¯finalçš„](https://blog.fengxianhub.top/#/Spring_Framework/Spring_transaction?id=_3-æ–¹æ³•æ˜¯finalçš„)

> åŒä¸Šï¼Œä»£ç†ç±»æ— æ³•é‡å†™ä»£ç†çš„æ–¹æ³•

### [4. å•ç‹¬çš„çº¿ç¨‹è°ƒç”¨](https://blog.fengxianhub.top/#/Spring_Framework/Spring_transaction?id=_4-å•ç‹¬çš„çº¿ç¨‹è°ƒç”¨)

> å½“`Mybatis`æˆ–è€…`JdbcTemplate`æ‰§è¡ŒSQLæ—¶ï¼Œä¼šä»`ThreadLocal`ä¸­å»è·å–æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œå¦‚æœå¼€å¯äº‹ç‰©çš„çº¿ç¨‹å’Œæ‰§è¡ŒSQLçš„çº¿ç¨‹ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå°±æ‹¿ä¸åˆ°æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œè¿™æ ·ï¼Œ`Mybatis`æˆ–è€…`JdbcTemplate`å°±ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥ç”¨æ¥æ‰§è¡ŒSQLï¼Œå¦‚æœè¿™ä¸ªäº‹ç‰©è‡ªåŠ¨äº‹ç‰©æäº¤`autocommit`é»˜è®¤å¼€å¯çš„è¯ï¼Œå°±ä¸ä¼šå› ä¸ºå¼‚å¸¸è€Œè¿›è¡Œå›æ»š

```java
public class UserService {
    // äº‹ç‰©å¤±æ•ˆ
    @Transactional
    private void a(){
        new Thread(() -> {
            jdbcTemplate.execute("insert into t1 values(1)");
            throw new RuntimeException();
        }).start();
    }
}
```

### [5. Springä¸­æ²¡åŠ @Configurationæ³¨è§£](https://blog.fengxianhub.top/#/Spring_Framework/Spring_transaction?id=_5-springä¸­æ²¡åŠ configurationæ³¨è§£)

> åœ¨Springä¸­ï¼Œç”±äº`Mybatis`æˆ–`JdbcTemplate`ä¼šä»ThreadLocalä¸­è·å–æ•°æ®åº“è¿æ¥ï¼Œä½†æ˜¯ThreadLocalé‡Œé¢å­˜çš„æ˜¯mapï¼Œå³`ThreadLocal<Map<DateSource, Connection>>`çš„ç»“æ„
>
> å¦‚æœæ²¡æœ‰æ·»åŠ `@Configuration`æ³¨è§£ï¼Œä¼šå¯¼è‡´Mapä¸­å­˜çš„DateSourceå’Œ`Mybatis`æˆ–`JdbcTemplate`å¯¹è±¡ä¸ç›¸ç­‰ï¼Œä»è€Œæ‹¿ä¸åˆ°æ•°æ®åº“è¿æ¥ï¼Œå¯¼è‡´è‡ªå·±ä¼šæ–°å»ºä¸€ä¸ªï¼Œä»è€Œå¯¼è‡´äº‹ç‰©å¤±æ•ˆ
>
> **æ³¨æ„ï¼šåœ¨SpringBootä¸­ç”±äºè‡ªåŠ¨è£…ç®±ï¼Œä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜**

### [6. å¼‚å¸¸è¢«åƒæ‰](https://blog.fengxianhub.top/#/Spring_Framework/Spring_transaction?id=_6-å¼‚å¸¸è¢«åƒæ‰)

> Springé»˜è®¤åªä¼šå¯¹`RuntimeException`å’Œ`Error`è¿›è¡Œå›æ»š

### [7. ç±»æ²¡æœ‰è¢«Springç®¡ç†](https://blog.fengxianhub.top/#/Spring_Framework/Spring_transaction?id=_7-ç±»æ²¡æœ‰è¢«springç®¡ç†)

### [8. æ•°æ®åº“æ²¡æœ‰å¼€å¯äº‹ç‰©](https://blog.fengxianhub.top/#/Spring_Framework/Spring_transaction?id=_8-æ•°æ®åº“æ²¡æœ‰å¼€å¯äº‹ç‰©)





## é™„å½•ï¼šå‚è€ƒæ–‡ç« 

- https://www.cnblogs.com/fix200/p/18066537
- https://d9bp4nr5ye.feishu.cn/wiki/OJdiwdYeXirkdBk3NV8c5evrnmh